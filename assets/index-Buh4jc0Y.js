var Ju=Object.defineProperty;var Ta=n=>{throw TypeError(n)};var Zu=(n,t,e)=>t in n?Ju(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var Sa=(n,t,e)=>Zu(n,typeof t!="symbol"?t+"":t,e),mr=(n,t,e)=>t.has(n)||Ta("Cannot "+e);var ae=(n,t,e)=>(mr(n,t,"read from private field"),e?e.call(n):t.get(n)),vi=(n,t,e)=>t.has(n)?Ta("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),pr=(n,t,e,i)=>(mr(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e),Aa=(n,t,e)=>(mr(n,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();const th=!1;var Rl=Array.isArray,Bs=Array.from,eh=Object.defineProperty,La=Object.getOwnPropertyDescriptor,_l=Object.getOwnPropertyDescriptors,Wr=Object.getPrototypeOf;function ih(n){return n()}function qr(n){for(var t=0;t<n.length;t++)n[t]()}const $t=2,Il=4,Vi=8,$s=16,re=32,rr=64,Ue=128,In=256,Tt=512,Se=1024,fi=2048,Zt=4096,Yi=8192,nh=16384,Gs=32768,rh=1<<18,bl=1<<19,zr=Symbol("$state"),sh=Symbol("");function wl(n){return n===this.v}function ah(n,t){return n!=n?t==t:n!==t||n!==null&&typeof n=="object"||typeof n=="function"}function oh(n){return!ah(n,this.v)}function lh(n){throw new Error("effect_in_teardown")}function ch(){throw new Error("effect_in_unowned_derived")}function uh(n){throw new Error("effect_orphan")}function hh(){throw new Error("effect_update_depth_exceeded")}function fh(){throw new Error("state_unsafe_local_read")}function dh(){throw new Error("state_unsafe_mutation")}let Wi=!1;function gh(){Wi=!0}function bn(n){return{f:0,v:n,reactions:null,equals:wl,version:0}}function Dl(n,t=!1){var i;const e=bn(n);return t||(e.equals=oh),Wi&&ot!==null&&ot.l!==null&&((i=ot.l).s??(i.s=[])).push(e),e}function oe(n,t=!1){return mh(Dl(n,t))}function mh(n){return et!==null&&et.f&$t&&(te===null?Ph([n]):te.push(n)),n}function Ra(n,t){return Mt(n,mi(()=>G(n))),t}function Mt(n,t){return et!==null&&qs()&&et.f&($t|$s)&&(te===null||!te.includes(n))&&dh(),Cl(n,t)}function Cl(n,t){return n.equals(t)||(n.v=t,n.version=ql(),kl(n,Se),qs()&&Z!==null&&Z.f&Tt&&!(Z.f&re)&&(xt!==null&&xt.includes(n)?(Kt(Z,Se),lr(Z)):Te===null?Fh([n]):Te.push(n))),t}function kl(n,t){var e=n.reactions;if(e!==null)for(var i=qs(),r=e.length,s=0;s<r;s++){var a=e[s],o=a.f;o&Se||!i&&a===Z||(Kt(a,t),o&(Tt|Ue)&&(o&$t?kl(a,fi):lr(a)))}}const ph=1,yh=2,vh=16,Eh=2;let xh=!1;var _a,Pl,Fl;function Th(){if(_a===void 0){_a=window;var n=Element.prototype,t=Node.prototype;Pl=La(t,"firstChild").get,Fl=La(t,"nextSibling").get,n.__click=void 0,n.__className="",n.__attributes=null,n.__styles=null,n.__e=void 0,Text.prototype.__t=void 0}}function Ks(n=""){return document.createTextNode(n)}function be(n){return Pl.call(n)}function sr(n){return Fl.call(n)}function Ia(n,t){return be(n)}function ba(n,t){{var e=be(n);return e instanceof Comment&&e.data===""?sr(e):e}}function wa(n,t=1,e=!1){let i=n;for(;t--;)i=sr(i);return i}function Sh(n){n.textContent=""}function Ah(n){var t=$t|Se;Z===null?t|=Ue:Z.f|=bl;var e=et!==null&&et.f&$t?et:null;const i={children:null,ctx:ot,deps:null,equals:wl,f:t,fn:n,reactions:null,v:null,version:0,parent:e??Z};return e!==null&&(e.children??(e.children=[])).push(i),i}function Ol(n){var t=n.children;if(t!==null){n.children=null;for(var e=0;e<t.length;e+=1){var i=t[e];i.f&$t?Hs(i):Be(i)}}}function Lh(n){for(var t=n.parent;t!==null;){if(!(t.f&$t))return t;t=t.parent}return null}function Ml(n){var t,e=Z;Le(Lh(n));try{Ol(n),t=zl(n)}finally{Le(e)}return t}function Nl(n){var t=Ml(n),e=(ze||n.f&Ue)&&n.deps!==null?fi:Tt;Kt(n,e),n.equals(t)||(n.v=t,n.version=ql())}function Hs(n){Ol(n),Pi(n,0),Kt(n,Yi),n.v=n.children=n.deps=n.ctx=n.reactions=null}function Ul(n){Z===null&&et===null&&uh(),et!==null&&et.f&Ue&&ch(),Ws&&lh()}function Rh(n,t){var e=t.last;e===null?t.last=t.first=n:(e.next=n,n.prev=e,t.last=n)}function di(n,t,e,i=!0){var r=(n&rr)!==0,s=Z,a={ctx:ot,deps:null,deriveds:null,nodes_start:null,nodes_end:null,f:n|Se,first:null,fn:t,last:null,next:null,parent:r?null:s,prev:null,teardown:null,transitions:null,version:0};if(e){var o=Je;try{Ca(!0),qi(a),a.f|=nh}catch(u){throw Be(a),u}finally{Ca(o)}}else t!==null&&lr(a);var l=e&&a.deps===null&&a.first===null&&a.nodes_start===null&&a.teardown===null&&(a.f&bl)===0;if(!l&&!r&&i&&(s!==null&&Rh(a,s),et!==null&&et.f&$t)){var c=et;(c.children??(c.children=[])).push(a)}return a}function _h(n){const t=di(Vi,null,!1);return Kt(t,Tt),t.teardown=n,t}function Xr(n){Ul();var t=Z!==null&&(Z.f&re)!==0&&ot!==null&&!ot.m;if(t){var e=ot;(e.e??(e.e=[])).push({fn:n,effect:Z,reaction:et})}else{var i=ar(n);return i}}function Ih(n){return Ul(),or(n)}function bh(n){const t=di(rr,n,!0);return()=>{Be(t)}}function ar(n){return di(Il,n,!1)}function Xi(n,t){var e=ot,i={effect:null,ran:!1};e.l.r1.push(i),i.effect=or(()=>{n(),!i.ran&&(i.ran=!0,Mt(e.l.r2,!0),mi(t))})}function wh(){var n=ot;or(()=>{if(G(n.l.r2)){for(var t of n.l.r1){var e=t.effect;e.f&Tt&&Kt(e,fi),gi(e)&&qi(e),t.ran=!1}n.l.r2.v=!1}})}function or(n){return di(Vi,n,!0)}function Da(n){return Vs(n)}function Vs(n,t=0){return di(Vi|$s|t,n,!0)}function ki(n,t=!0){return di(Vi|re,n,!0,t)}function Bl(n){var t=n.teardown;if(t!==null){const e=Ws,i=et;ka(!0),Ae(null);try{t.call(null)}finally{ka(e),Ae(i)}}}function $l(n){var t=n.deriveds;if(t!==null){n.deriveds=null;for(var e=0;e<t.length;e+=1)Hs(t[e])}}function Gl(n,t=!1){var e=n.first;for(n.first=n.last=null;e!==null;){var i=e.next;Be(e,t),e=i}}function Dh(n){for(var t=n.first;t!==null;){var e=t.next;t.f&re||Be(t),t=e}}function Be(n,t=!0){var e=!1;if((t||n.f&rh)&&n.nodes_start!==null){for(var i=n.nodes_start,r=n.nodes_end;i!==null;){var s=i===r?null:sr(i);i.remove(),i=s}e=!0}Gl(n,t&&!e),$l(n),Pi(n,0),Kt(n,Yi);var a=n.transitions;if(a!==null)for(const l of a)l.stop();Bl(n);var o=n.parent;o!==null&&o.first!==null&&Kl(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.parent=n.fn=n.nodes_start=n.nodes_end=null}function Kl(n){var t=n.parent,e=n.prev,i=n.next;e!==null&&(e.next=i),i!==null&&(i.prev=e),t!==null&&(t.first===n&&(t.first=i),t.last===n&&(t.last=e))}function jr(n,t){var e=[];Ys(n,e,!0),Hl(e,()=>{Be(n),t&&t()})}function Hl(n,t){var e=n.length;if(e>0){var i=()=>--e||t();for(var r of n)r.out(i)}else t()}function Ys(n,t,e){if(!(n.f&Zt)){if(n.f^=Zt,n.transitions!==null)for(const a of n.transitions)(a.is_global||e)&&t.push(a);for(var i=n.first;i!==null;){var r=i.next,s=(i.f&Gs)!==0||(i.f&re)!==0;Ys(i,t,s?e:!1),i=r}}}function wn(n){Vl(n,!0)}function Vl(n,t){if(n.f&Zt){gi(n)&&qi(n),n.f^=Zt;for(var e=n.first;e!==null;){var i=e.next,r=(e.f&Gs)!==0||(e.f&re)!==0;Vl(e,r?t:!1),e=i}if(n.transitions!==null)for(const s of n.transitions)(s.is_global||t)&&s.in()}}let Qr=!1,Jr=[];function Ch(){Qr=!1;const n=Jr.slice();Jr=[],qr(n)}function Yl(n){Qr||(Qr=!0,queueMicrotask(Ch)),Jr.push(n)}function kh(n){throw new Error("lifecycle_outside_component")}let Dn=!1,Je=!1,Ws=!1;function Ca(n){Je=n}function ka(n){Ws=n}let Zr=[],Di=0;let et=null;function Ae(n){et=n}let Z=null;function Le(n){Z=n}let te=null;function Ph(n){te=n}let xt=null,Rt=0,Te=null;function Fh(n){Te=n}let Wl=0,ze=!1,ot=null;function ql(){return++Wl}function qs(){return!Wi||ot!==null&&ot.l===null}function gi(n){var a,o;var t=n.f;if(t&Se)return!0;if(t&fi){var e=n.deps,i=(t&Ue)!==0;if(e!==null){var r;if(t&In){for(r=0;r<e.length;r++)((a=e[r]).reactions??(a.reactions=[])).push(n);n.f^=In}for(r=0;r<e.length;r++){var s=e[r];if(gi(s)&&Nl(s),i&&Z!==null&&!ze&&!((o=s==null?void 0:s.reactions)!=null&&o.includes(n))&&(s.reactions??(s.reactions=[])).push(n),s.version>n.version)return!0}}i||Kt(n,Tt)}return!1}function Oh(n,t,e){throw n}function zl(n){var f;var t=xt,e=Rt,i=Te,r=et,s=ze,a=te,o=ot,l=n.f;xt=null,Rt=0,Te=null,et=l&(re|rr)?null:n,ze=!Je&&(l&Ue)!==0,te=null,ot=n.ctx;try{var c=(0,n.fn)(),u=n.deps;if(xt!==null){var h;if(Pi(n,Rt),u!==null&&Rt>0)for(u.length=Rt+xt.length,h=0;h<xt.length;h++)u[Rt+h]=xt[h];else n.deps=u=xt;if(!ze)for(h=Rt;h<u.length;h++)((f=u[h]).reactions??(f.reactions=[])).push(n)}else u!==null&&Rt<u.length&&(Pi(n,Rt),u.length=Rt);return c}finally{xt=t,Rt=e,Te=i,et=r,ze=s,te=a,ot=o}}function Mh(n,t){let e=t.reactions;if(e!==null){var i=e.indexOf(n);if(i!==-1){var r=e.length-1;r===0?e=t.reactions=null:(e[i]=e[r],e.pop())}}e===null&&t.f&$t&&(xt===null||!xt.includes(t))&&(Kt(t,fi),t.f&(Ue|In)||(t.f^=In),Pi(t,0))}function Pi(n,t){var e=n.deps;if(e!==null)for(var i=t;i<e.length;i++)Mh(n,e[i])}function qi(n){var t=n.f;if(!(t&Yi)){Kt(n,Tt);var e=Z;Z=n;try{t&$s?Dh(n):Gl(n),$l(n),Bl(n);var i=zl(n);n.teardown=typeof i=="function"?i:null,n.version=Wl}catch(r){Oh(r)}finally{Z=e}}}function Nh(){Di>1e3&&(Di=0,hh()),Di++}function Uh(n){var t=n.length;if(t!==0){Nh();var e=Je;Je=!0;try{for(var i=0;i<t;i++){var r=n[i];r.f&Tt||(r.f^=Tt);var s=[];Xl(r,s),Bh(s)}}finally{Je=e}}}function Bh(n){var t=n.length;if(t!==0)for(var e=0;e<t;e++){var i=n[e];!(i.f&(Yi|Zt))&&gi(i)&&(qi(i),i.deps===null&&i.first===null&&i.nodes_start===null&&(i.teardown===null?Kl(i):i.fn=null))}}function $h(){if(Dn=!1,Di>1001)return;const n=Zr;Zr=[],Uh(n),Dn||(Di=0)}function lr(n){Dn||(Dn=!0,queueMicrotask($h));for(var t=n;t.parent!==null;){t=t.parent;var e=t.f;if(e&(rr|re)){if(!(e&Tt))return;t.f^=Tt}}Zr.push(t)}function Xl(n,t){var e=n.first,i=[];t:for(;e!==null;){var r=e.f,s=(r&re)!==0,a=s&&(r&Tt)!==0;if(!a&&!(r&Zt))if(r&Vi){s?e.f^=Tt:gi(e)&&qi(e);var o=e.first;if(o!==null){e=o;continue}}else r&Il&&i.push(e);var l=e.next;if(l===null){let h=e.parent;for(;h!==null;){if(n===h)break t;var c=h.next;if(c!==null){e=c;continue t}h=h.parent}}e=l}for(var u=0;u<i.length;u++)o=i[u],t.push(o),Xl(o,t)}function G(n){var u;var t=n.f,e=(t&$t)!==0;if(e&&t&Yi){var i=Ml(n);return Hs(n),i}if(et!==null){te!==null&&te.includes(n)&&fh();var r=et.deps;xt===null&&r!==null&&r[Rt]===n?Rt++:xt===null?xt=[n]:xt.push(n),Te!==null&&Z!==null&&Z.f&Tt&&!(Z.f&re)&&Te.includes(n)&&(Kt(Z,Se),lr(Z))}else if(e&&n.deps===null)for(var s=n,a=s.parent,o=s;a!==null;)if(a.f&$t){var l=a;o=l,a=l.parent}else{var c=a;(u=c.deriveds)!=null&&u.includes(o)||(c.deriveds??(c.deriveds=[])).push(o);break}return e&&(s=n,gi(s)&&Nl(s)),n.v}function mi(n){const t=et;try{return et=null,n()}finally{et=t}}const Gh=~(Se|fi|Tt);function Kt(n,t){n.f=n.f&Gh|t}function jl(n,t=!1,e){ot={p:ot,c:null,e:null,m:!1,s:n,x:null,l:null},Wi&&!t&&(ot.l={s:null,u:null,r1:[],r2:bn(!1)})}function Ql(n){const t=ot;if(t!==null){const a=t.e;if(a!==null){var e=Z,i=et;t.e=null;try{for(var r=0;r<a.length;r++){var s=a[r];Le(s.effect),Ae(s.reaction),ar(s.fn)}}finally{Le(e),Ae(i)}}ot=t.p,t.m=!0}return{}}function Kh(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(zr in n)ts(n);else if(!Array.isArray(n))for(let t in n){const e=n[t];typeof e=="object"&&e&&zr in e&&ts(e)}}}function ts(n,t=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!t.has(n)){t.add(n),n instanceof Date&&n.getTime();for(let i in n)try{ts(n[i],t)}catch{}const e=Wr(n);if(e!==Object.prototype&&e!==Array.prototype&&e!==Map.prototype&&e!==Set.prototype&&e!==Date.prototype){const i=_l(e);for(let r in i){const s=i[r].get;if(s)try{s.call(n)}catch{}}}}}function Hh(n){var t=et,e=Z;Ae(null),Le(null);try{return n()}finally{Ae(t),Le(e)}}const Vh=new Set,Pa=new Set;function Yh(n,t,e,i){function r(s){if(i.capture||Ti.call(t,s),!s.cancelBubble)return Hh(()=>e.call(this,s))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Yl(()=>{t.addEventListener(n,r,i)}):t.addEventListener(n,r,i),r}function $e(n,t,e,i,r){var s={capture:i,passive:r},a=Yh(n,t,e,s);(t===document.body||t===window||t===document)&&_h(()=>{t.removeEventListener(n,a,s)})}function Ti(n){var x;var t=this,e=t.ownerDocument,i=n.type,r=((x=n.composedPath)==null?void 0:x.call(n))||[],s=r[0]||n.target,a=0,o=n.__root;if(o){var l=r.indexOf(o);if(l!==-1&&(t===document||t===window)){n.__root=t;return}var c=r.indexOf(t);if(c===-1)return;l<=c&&(a=l)}if(s=r[a]||n.target,s!==t){eh(n,"currentTarget",{configurable:!0,get(){return s||e}});var u=et,h=Z;Ae(null),Le(null);try{for(var f,d=[];s!==null;){var g=s.assignedSlot||s.parentNode||s.host||null;try{var m=s["__"+i];if(m!==void 0&&!s.disabled)if(Rl(m)){var[p,...v]=m;p.apply(s,[n,...v])}else m.call(s,n)}catch(T){f?d.push(T):f=T}if(n.cancelBubble||g===t||g===null)break;s=g}if(f){for(let T of d)queueMicrotask(()=>{throw T});throw f}}finally{n.__root=t,delete n.currentTarget,Ae(u),Le(h)}}}function Jl(n){var t=document.createElement("template");return t.innerHTML=n,t.content}function zs(n,t){var e=Z;e.nodes_start===null&&(e.nodes_start=n,e.nodes_end=t)}function Wh(n,t){var e=(t&Eh)!==0,i,r=!n.startsWith("<!>");return()=>{i===void 0&&(i=Jl(r?n:"<!>"+n),i=be(i));var s=e?document.importNode(i,!0):i.cloneNode(!0);return zs(s,s),s}}function qh(n,t,e="svg"){var i=!n.startsWith("<!>"),r=`<${e}>${i?n:"<!>"+n}</${e}>`,s;return()=>{if(!s){var a=Jl(r),o=be(a);for(s=document.createDocumentFragment();be(o);)s.appendChild(be(o))}var l=s.cloneNode(!0);{var c=be(l),u=l.lastChild;zs(c,u)}return l}}function zh(){var n=document.createDocumentFragment(),t=document.createComment(""),e=Ks();return n.append(t,e),zs(t,e),n}function yr(n,t){n!==null&&n.before(t)}const Xh=["touchstart","touchmove"];function jh(n){return Xh.includes(n)}function Qh(n,t){return Jh(n,t)}const Ge=new Map;function Jh(n,{target:t,anchor:e,props:i={},events:r,context:s,intro:a=!0}){Th();var o=new Set,l=h=>{for(var f=0;f<h.length;f++){var d=h[f];if(!o.has(d)){o.add(d);var g=jh(d);t.addEventListener(d,Ti,{passive:g});var m=Ge.get(d);m===void 0?(document.addEventListener(d,Ti,{passive:g}),Ge.set(d,1)):Ge.set(d,m+1)}}};l(Bs(Vh)),Pa.add(l);var c=void 0,u=bh(()=>{var h=e??t.appendChild(Ks());return ki(()=>{if(s){jl({});var f=ot;f.c=s}r&&(i.$$events=r),c=n(h,i)||{},s&&Ql()}),()=>{var g;for(var f of o){t.removeEventListener(f,Ti);var d=Ge.get(f);--d===0?(document.removeEventListener(f,Ti),Ge.delete(f)):Ge.set(f,d)}Pa.delete(l),Fa.delete(c),h!==e&&((g=h.parentNode)==null||g.removeChild(h))}});return Fa.set(c,u),c}let Fa=new WeakMap;function Zh(n,t,e,i=null,r=!1){var s=n,a=null,o=null,l=null,c=r?Gs:0;Vs(()=>{l!==(l=!!t())&&(l?(a?wn(a):a=ki(()=>e(s)),o&&jr(o,()=>{o=null})):(o?wn(o):i&&(o=ki(()=>i(s))),a&&jr(a,()=>{a=null})))},c)}function tf(n,t){return t}function ef(n,t,e,i){for(var r=[],s=t.length,a=0;a<s;a++)Ys(t[a].e,r,!0);var o=s>0&&r.length===0&&e!==null;if(o){var l=e.parentNode;Sh(l),l.append(e),i.clear(),ye(n,t[0].prev,t[s-1].next)}Hl(r,()=>{for(var c=0;c<s;c++){var u=t[c];o||(i.delete(u.k),ye(n,u.prev,u.next)),Be(u.e,!o)}})}function nf(n,t,e,i,r,s=null){var a=n,o={flags:t,items:new Map,first:null};{var l=n;a=l.appendChild(Ks())}var c=null,u=!1;Vs(()=>{var h=e(),f=Rl(h)?h:h==null?[]:Bs(h),d=f.length;if(!(u&&d===0)){u=d===0;{var g=et;rf(f,o,a,r,t,(g.f&Zt)!==0,i)}s!==null&&(d===0?c?wn(c):c=ki(()=>s(a)):c!==null&&jr(c,()=>{c=null})),e()}})}function rf(n,t,e,i,r,s,a){var o=n.length,l=t.items,c=t.first,u=c,h,f=null,d=[],g=[],m,p,v,x;for(x=0;x<o;x+=1){if(m=n[x],p=a(m,x),v=l.get(p),v===void 0){var T=u?u.e.nodes_start:e;f=af(T,t,f,f===null?t.first:f.next,m,p,x,i,r),l.set(p,f),d=[],g=[],u=f.next;continue}if(sf(v,m,x),v.e.f&Zt&&wn(v.e),v!==u){if(h!==void 0&&h.has(v)){if(d.length<g.length){var S=g[0],E;f=S.prev;var R=d[0],A=d[d.length-1];for(E=0;E<d.length;E+=1)Oa(d[E],S,e);for(E=0;E<g.length;E+=1)h.delete(g[E]);ye(t,R.prev,A.next),ye(t,f,R),ye(t,A,S),u=S,f=A,x-=1,d=[],g=[]}else h.delete(v),Oa(v,u,e),ye(t,v.prev,v.next),ye(t,v,f===null?t.first:f.next),ye(t,f,v),f=v;continue}for(d=[],g=[];u!==null&&u.k!==p;)(s||!(u.e.f&Zt))&&(h??(h=new Set)).add(u),g.push(u),u=u.next;if(u===null)continue;v=u}d.push(v),f=v,u=v.next}if(u!==null||h!==void 0){for(var C=h===void 0?[]:Bs(h);u!==null;)(s||!(u.e.f&Zt))&&C.push(u),u=u.next;var k=C.length;if(k>0){var I=o===0?e:null;ef(t,C,I,l)}}Z.first=t.first&&t.first.e,Z.last=f&&f.e}function sf(n,t,e,i){Cl(n.v,t),n.i=e}function af(n,t,e,i,r,s,a,o,l){var c=(l&ph)!==0,u=(l&vh)===0,h=c?u?Dl(r):bn(r):r,f=l&yh?bn(a):a,d={i:f,v:h,k:s,a:null,e:null,prev:e,next:i};try{return d.e=ki(()=>o(n,h,f),xh),d.e.prev=e&&e.e,d.e.next=i&&i.e,e===null?t.first=d:(e.next=d,e.e.next=d.e),i!==null&&(i.prev=d,i.e.prev=d.e),d}finally{}}function Oa(n,t,e){for(var i=n.next?n.next.e.nodes_start:e,r=t?t.e.nodes_start:e,s=n.e.nodes_start;s!==i;){var a=sr(s);r.before(s),s=a}}function ye(n,t,e){t===null?n.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Vt(n,t,e,i){var r=n.__attributes??(n.__attributes={});r[t]!==(r[t]=e)&&(t==="style"&&"__styles"in n&&(n.__styles={}),t==="loading"&&(n[sh]=e),e==null?n.removeAttribute(t):typeof e!="string"&&of(n).includes(t)?n[t]=e:n.setAttribute(t,e))}var Ma=new Map;function of(n){var t=Ma.get(n.nodeName);if(t)return t;Ma.set(n.nodeName,t=[]);for(var e,i=Wr(n),r=Element.prototype;r!==i;){e=_l(i);for(var s in e)e[s].set&&t.push(s);i=Wr(i)}return t}var xe,ii,Hi,ir,Zl;const nr=class nr{constructor(t){vi(this,ir);vi(this,xe,new WeakMap);vi(this,ii);vi(this,Hi);pr(this,Hi,t)}observe(t,e){var i=ae(this,xe).get(t)||new Set;return i.add(e),ae(this,xe).set(t,i),Aa(this,ir,Zl).call(this).observe(t,ae(this,Hi)),()=>{var r=ae(this,xe).get(t);r.delete(e),r.size===0&&(ae(this,xe).delete(t),ae(this,ii).unobserve(t))}}};xe=new WeakMap,ii=new WeakMap,Hi=new WeakMap,ir=new WeakSet,Zl=function(){return ae(this,ii)??pr(this,ii,new ResizeObserver(t=>{for(var e of t){nr.entries.set(e.target,e);for(var i of ae(this,xe).get(e.target)||[])i(e)}}))},Sa(nr,"entries",new WeakMap);let es=nr;var lf=new es({box:"border-box"});function Na(n,t,e){var i=lf.observe(n,()=>e(n[t]));ar(()=>(mi(()=>e(n[t])),i))}function Ua(n,t){return n===t||(n==null?void 0:n[zr])===t}function cf(n={},t,e,i){return ar(()=>{var r,s;return or(()=>{r=s,s=[],mi(()=>{n!==e(...s)&&(t(n,...s),r&&Ua(e(...r),n)&&t(null,...r))})}),()=>{Yl(()=>{s&&Ua(e(...s),n)&&t(null,...s)})}}),n}function uf(n=!1){const t=ot,e=t.l.u;if(!e)return;let i=()=>Kh(t.s);if(n){let r=0,s={};const a=Ah(()=>{let o=!1;const l=t.s;for(const c in l)l[c]!==s[c]&&(s[c]=l[c],o=!0);return o&&r++,r});i=()=>G(a)}e.b.length&&Ih(()=>{Ba(t,i),qr(e.b)}),Xr(()=>{const r=mi(()=>e.m.map(ih));return()=>{for(const s of r)typeof s=="function"&&s()}}),e.a.length&&Xr(()=>{Ba(t,i),qr(e.a)})}function Ba(n,t){if(n.l.s)for(const e of n.l.s)G(e);t()}function hf(n){ot===null&&kh(),Wi&&ot.l!==null?ff(ot).m.push(n):Xr(()=>{const t=mi(n);if(typeof t=="function")return t})}function ff(n){var t=n.l;return t.u??(t.u={a:[],b:[],m:[]})}const df="5";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(df);gh();class Pe{constructor(){this._partials=new Float64Array(32),this._n=0}add(t){const e=this._partials;let i=0;for(let r=0;r<this._n&&r<32;r++){const s=e[r],a=t+s,o=Math.abs(t)<Math.abs(s)?t-(a-s):s-(a-t);o&&(e[i++]=o),t=a}return e[i]=t,this._n=i+1,this}valueOf(){const t=this._partials;let e=this._n,i,r,s,a=0;if(e>0){for(a=t[--e];e>0&&(i=a,r=t[--e],a=i+r,s=r-(a-i),!s););e>0&&(s<0&&t[e-1]<0||s>0&&t[e-1]>0)&&(r=s*2,i=a+r,r==i-a&&(a=i))}return a}}function*gf(n){for(const t of n)yield*t}function tc(n){return Array.from(gf(n))}var mf={value:()=>{}};function ec(){for(var n=0,t=arguments.length,e={},i;n<t;++n){if(!(i=arguments[n]+"")||i in e||/[\s.]/.test(i))throw new Error("illegal type: "+i);e[i]=[]}return new mn(e)}function mn(n){this._=n}function pf(n,t){return n.trim().split(/^|\s+/).map(function(e){var i="",r=e.indexOf(".");if(r>=0&&(i=e.slice(r+1),e=e.slice(0,r)),e&&!t.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:i}})}mn.prototype=ec.prototype={constructor:mn,on:function(n,t){var e=this._,i=pf(n+"",e),r,s=-1,a=i.length;if(arguments.length<2){for(;++s<a;)if((r=(n=i[s]).type)&&(r=yf(e[r],n.name)))return r;return}if(t!=null&&typeof t!="function")throw new Error("invalid callback: "+t);for(;++s<a;)if(r=(n=i[s]).type)e[r]=$a(e[r],n.name,t);else if(t==null)for(r in e)e[r]=$a(e[r],n.name,null);return this},copy:function(){var n={},t=this._;for(var e in t)n[e]=t[e].slice();return new mn(n)},call:function(n,t){if((r=arguments.length-2)>0)for(var e=new Array(r),i=0,r,s;i<r;++i)e[i]=arguments[i+2];if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(s=this._[n],i=0,r=s.length;i<r;++i)s[i].value.apply(t,e)},apply:function(n,t,e){if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(var i=this._[n],r=0,s=i.length;r<s;++r)i[r].value.apply(t,e)}};function yf(n,t){for(var e=0,i=n.length,r;e<i;++e)if((r=n[e]).name===t)return r.value}function $a(n,t,e){for(var i=0,r=n.length;i<r;++i)if(n[i].name===t){n[i]=mf,n=n.slice(0,i).concat(n.slice(i+1));break}return e!=null&&n.push({name:t,value:e}),n}var is="http://www.w3.org/1999/xhtml";const Ga={svg:"http://www.w3.org/2000/svg",xhtml:is,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function cr(n){var t=n+="",e=t.indexOf(":");return e>=0&&(t=n.slice(0,e))!=="xmlns"&&(n=n.slice(e+1)),Ga.hasOwnProperty(t)?{space:Ga[t],local:n}:n}function vf(n){return function(){var t=this.ownerDocument,e=this.namespaceURI;return e===is&&t.documentElement.namespaceURI===is?t.createElement(n):t.createElementNS(e,n)}}function Ef(n){return function(){return this.ownerDocument.createElementNS(n.space,n.local)}}function ic(n){var t=cr(n);return(t.local?Ef:vf)(t)}function xf(){}function Xs(n){return n==null?xf:function(){return this.querySelector(n)}}function Tf(n){typeof n!="function"&&(n=Xs(n));for(var t=this._groups,e=t.length,i=new Array(e),r=0;r<e;++r)for(var s=t[r],a=s.length,o=i[r]=new Array(a),l,c,u=0;u<a;++u)(l=s[u])&&(c=n.call(l,l.__data__,u,s))&&("__data__"in l&&(c.__data__=l.__data__),o[u]=c);return new Gt(i,this._parents)}function Sf(n){return n==null?[]:Array.isArray(n)?n:Array.from(n)}function Af(){return[]}function nc(n){return n==null?Af:function(){return this.querySelectorAll(n)}}function Lf(n){return function(){return Sf(n.apply(this,arguments))}}function Rf(n){typeof n=="function"?n=Lf(n):n=nc(n);for(var t=this._groups,e=t.length,i=[],r=[],s=0;s<e;++s)for(var a=t[s],o=a.length,l,c=0;c<o;++c)(l=a[c])&&(i.push(n.call(l,l.__data__,c,a)),r.push(l));return new Gt(i,r)}function rc(n){return function(){return this.matches(n)}}function sc(n){return function(t){return t.matches(n)}}var _f=Array.prototype.find;function If(n){return function(){return _f.call(this.children,n)}}function bf(){return this.firstElementChild}function wf(n){return this.select(n==null?bf:If(typeof n=="function"?n:sc(n)))}var Df=Array.prototype.filter;function Cf(){return Array.from(this.children)}function kf(n){return function(){return Df.call(this.children,n)}}function Pf(n){return this.selectAll(n==null?Cf:kf(typeof n=="function"?n:sc(n)))}function Ff(n){typeof n!="function"&&(n=rc(n));for(var t=this._groups,e=t.length,i=new Array(e),r=0;r<e;++r)for(var s=t[r],a=s.length,o=i[r]=[],l,c=0;c<a;++c)(l=s[c])&&n.call(l,l.__data__,c,s)&&o.push(l);return new Gt(i,this._parents)}function ac(n){return new Array(n.length)}function Of(){return new Gt(this._enter||this._groups.map(ac),this._parents)}function Cn(n,t){this.ownerDocument=n.ownerDocument,this.namespaceURI=n.namespaceURI,this._next=null,this._parent=n,this.__data__=t}Cn.prototype={constructor:Cn,appendChild:function(n){return this._parent.insertBefore(n,this._next)},insertBefore:function(n,t){return this._parent.insertBefore(n,t)},querySelector:function(n){return this._parent.querySelector(n)},querySelectorAll:function(n){return this._parent.querySelectorAll(n)}};function Mf(n){return function(){return n}}function Nf(n,t,e,i,r,s){for(var a=0,o,l=t.length,c=s.length;a<c;++a)(o=t[a])?(o.__data__=s[a],i[a]=o):e[a]=new Cn(n,s[a]);for(;a<l;++a)(o=t[a])&&(r[a]=o)}function Uf(n,t,e,i,r,s,a){var o,l,c=new Map,u=t.length,h=s.length,f=new Array(u),d;for(o=0;o<u;++o)(l=t[o])&&(f[o]=d=a.call(l,l.__data__,o,t)+"",c.has(d)?r[o]=l:c.set(d,l));for(o=0;o<h;++o)d=a.call(n,s[o],o,s)+"",(l=c.get(d))?(i[o]=l,l.__data__=s[o],c.delete(d)):e[o]=new Cn(n,s[o]);for(o=0;o<u;++o)(l=t[o])&&c.get(f[o])===l&&(r[o]=l)}function Bf(n){return n.__data__}function $f(n,t){if(!arguments.length)return Array.from(this,Bf);var e=t?Uf:Nf,i=this._parents,r=this._groups;typeof n!="function"&&(n=Mf(n));for(var s=r.length,a=new Array(s),o=new Array(s),l=new Array(s),c=0;c<s;++c){var u=i[c],h=r[c],f=h.length,d=Gf(n.call(u,u&&u.__data__,c,i)),g=d.length,m=o[c]=new Array(g),p=a[c]=new Array(g),v=l[c]=new Array(f);e(u,h,m,p,v,d,t);for(var x=0,T=0,S,E;x<g;++x)if(S=m[x]){for(x>=T&&(T=x+1);!(E=p[T])&&++T<g;);S._next=E||null}}return a=new Gt(a,i),a._enter=o,a._exit=l,a}function Gf(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function Kf(){return new Gt(this._exit||this._groups.map(ac),this._parents)}function Hf(n,t,e){var i=this.enter(),r=this,s=this.exit();return typeof n=="function"?(i=n(i),i&&(i=i.selection())):i=i.append(n+""),t!=null&&(r=t(r),r&&(r=r.selection())),e==null?s.remove():e(s),i&&r?i.merge(r).order():r}function Vf(n){for(var t=n.selection?n.selection():n,e=this._groups,i=t._groups,r=e.length,s=i.length,a=Math.min(r,s),o=new Array(r),l=0;l<a;++l)for(var c=e[l],u=i[l],h=c.length,f=o[l]=new Array(h),d,g=0;g<h;++g)(d=c[g]||u[g])&&(f[g]=d);for(;l<r;++l)o[l]=e[l];return new Gt(o,this._parents)}function Yf(){for(var n=this._groups,t=-1,e=n.length;++t<e;)for(var i=n[t],r=i.length-1,s=i[r],a;--r>=0;)(a=i[r])&&(s&&a.compareDocumentPosition(s)^4&&s.parentNode.insertBefore(a,s),s=a);return this}function Wf(n){n||(n=qf);function t(h,f){return h&&f?n(h.__data__,f.__data__):!h-!f}for(var e=this._groups,i=e.length,r=new Array(i),s=0;s<i;++s){for(var a=e[s],o=a.length,l=r[s]=new Array(o),c,u=0;u<o;++u)(c=a[u])&&(l[u]=c);l.sort(t)}return new Gt(r,this._parents).order()}function qf(n,t){return n<t?-1:n>t?1:n>=t?0:NaN}function zf(){var n=arguments[0];return arguments[0]=this,n.apply(null,arguments),this}function Xf(){return Array.from(this)}function jf(){for(var n=this._groups,t=0,e=n.length;t<e;++t)for(var i=n[t],r=0,s=i.length;r<s;++r){var a=i[r];if(a)return a}return null}function Qf(){let n=0;for(const t of this)++n;return n}function Jf(){return!this.node()}function Zf(n){for(var t=this._groups,e=0,i=t.length;e<i;++e)for(var r=t[e],s=0,a=r.length,o;s<a;++s)(o=r[s])&&n.call(o,o.__data__,s,r);return this}function td(n){return function(){this.removeAttribute(n)}}function ed(n){return function(){this.removeAttributeNS(n.space,n.local)}}function id(n,t){return function(){this.setAttribute(n,t)}}function nd(n,t){return function(){this.setAttributeNS(n.space,n.local,t)}}function rd(n,t){return function(){var e=t.apply(this,arguments);e==null?this.removeAttribute(n):this.setAttribute(n,e)}}function sd(n,t){return function(){var e=t.apply(this,arguments);e==null?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,e)}}function ad(n,t){var e=cr(n);if(arguments.length<2){var i=this.node();return e.local?i.getAttributeNS(e.space,e.local):i.getAttribute(e)}return this.each((t==null?e.local?ed:td:typeof t=="function"?e.local?sd:rd:e.local?nd:id)(e,t))}function oc(n){return n.ownerDocument&&n.ownerDocument.defaultView||n.document&&n||n.defaultView}function od(n){return function(){this.style.removeProperty(n)}}function ld(n,t,e){return function(){this.style.setProperty(n,t,e)}}function cd(n,t,e){return function(){var i=t.apply(this,arguments);i==null?this.style.removeProperty(n):this.style.setProperty(n,i,e)}}function ud(n,t,e){return arguments.length>1?this.each((t==null?od:typeof t=="function"?cd:ld)(n,t,e??"")):ni(this.node(),n)}function ni(n,t){return n.style.getPropertyValue(t)||oc(n).getComputedStyle(n,null).getPropertyValue(t)}function hd(n){return function(){delete this[n]}}function fd(n,t){return function(){this[n]=t}}function dd(n,t){return function(){var e=t.apply(this,arguments);e==null?delete this[n]:this[n]=e}}function gd(n,t){return arguments.length>1?this.each((t==null?hd:typeof t=="function"?dd:fd)(n,t)):this.node()[n]}function lc(n){return n.trim().split(/^|\s+/)}function js(n){return n.classList||new cc(n)}function cc(n){this._node=n,this._names=lc(n.getAttribute("class")||"")}cc.prototype={add:function(n){var t=this._names.indexOf(n);t<0&&(this._names.push(n),this._node.setAttribute("class",this._names.join(" ")))},remove:function(n){var t=this._names.indexOf(n);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(n){return this._names.indexOf(n)>=0}};function uc(n,t){for(var e=js(n),i=-1,r=t.length;++i<r;)e.add(t[i])}function hc(n,t){for(var e=js(n),i=-1,r=t.length;++i<r;)e.remove(t[i])}function md(n){return function(){uc(this,n)}}function pd(n){return function(){hc(this,n)}}function yd(n,t){return function(){(t.apply(this,arguments)?uc:hc)(this,n)}}function vd(n,t){var e=lc(n+"");if(arguments.length<2){for(var i=js(this.node()),r=-1,s=e.length;++r<s;)if(!i.contains(e[r]))return!1;return!0}return this.each((typeof t=="function"?yd:t?md:pd)(e,t))}function Ed(){this.textContent=""}function xd(n){return function(){this.textContent=n}}function Td(n){return function(){var t=n.apply(this,arguments);this.textContent=t??""}}function Sd(n){return arguments.length?this.each(n==null?Ed:(typeof n=="function"?Td:xd)(n)):this.node().textContent}function Ad(){this.innerHTML=""}function Ld(n){return function(){this.innerHTML=n}}function Rd(n){return function(){var t=n.apply(this,arguments);this.innerHTML=t??""}}function _d(n){return arguments.length?this.each(n==null?Ad:(typeof n=="function"?Rd:Ld)(n)):this.node().innerHTML}function Id(){this.nextSibling&&this.parentNode.appendChild(this)}function bd(){return this.each(Id)}function wd(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Dd(){return this.each(wd)}function Cd(n){var t=typeof n=="function"?n:ic(n);return this.select(function(){return this.appendChild(t.apply(this,arguments))})}function kd(){return null}function Pd(n,t){var e=typeof n=="function"?n:ic(n),i=t==null?kd:typeof t=="function"?t:Xs(t);return this.select(function(){return this.insertBefore(e.apply(this,arguments),i.apply(this,arguments)||null)})}function Fd(){var n=this.parentNode;n&&n.removeChild(this)}function Od(){return this.each(Fd)}function Md(){var n=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(n,this.nextSibling):n}function Nd(){var n=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(n,this.nextSibling):n}function Ud(n){return this.select(n?Nd:Md)}function Bd(n){return arguments.length?this.property("__data__",n):this.node().__data__}function $d(n){return function(t){n.call(this,t,this.__data__)}}function Gd(n){return n.trim().split(/^|\s+/).map(function(t){var e="",i=t.indexOf(".");return i>=0&&(e=t.slice(i+1),t=t.slice(0,i)),{type:t,name:e}})}function Kd(n){return function(){var t=this.__on;if(t){for(var e=0,i=-1,r=t.length,s;e<r;++e)s=t[e],(!n.type||s.type===n.type)&&s.name===n.name?this.removeEventListener(s.type,s.listener,s.options):t[++i]=s;++i?t.length=i:delete this.__on}}}function Hd(n,t,e){return function(){var i=this.__on,r,s=$d(t);if(i){for(var a=0,o=i.length;a<o;++a)if((r=i[a]).type===n.type&&r.name===n.name){this.removeEventListener(r.type,r.listener,r.options),this.addEventListener(r.type,r.listener=s,r.options=e),r.value=t;return}}this.addEventListener(n.type,s,e),r={type:n.type,name:n.name,value:t,listener:s,options:e},i?i.push(r):this.__on=[r]}}function Vd(n,t,e){var i=Gd(n+""),r,s=i.length,a;if(arguments.length<2){var o=this.node().__on;if(o){for(var l=0,c=o.length,u;l<c;++l)for(r=0,u=o[l];r<s;++r)if((a=i[r]).type===u.type&&a.name===u.name)return u.value}return}for(o=t?Hd:Kd,r=0;r<s;++r)this.each(o(i[r],t,e));return this}function fc(n,t,e){var i=oc(n),r=i.CustomEvent;typeof r=="function"?r=new r(t,e):(r=i.document.createEvent("Event"),e?(r.initEvent(t,e.bubbles,e.cancelable),r.detail=e.detail):r.initEvent(t,!1,!1)),n.dispatchEvent(r)}function Yd(n,t){return function(){return fc(this,n,t)}}function Wd(n,t){return function(){return fc(this,n,t.apply(this,arguments))}}function qd(n,t){return this.each((typeof t=="function"?Wd:Yd)(n,t))}function*zd(){for(var n=this._groups,t=0,e=n.length;t<e;++t)for(var i=n[t],r=0,s=i.length,a;r<s;++r)(a=i[r])&&(yield a)}var Xd=[null];function Gt(n,t){this._groups=n,this._parents=t}function pi(){return new Gt([[document.documentElement]],Xd)}function jd(){return this}Gt.prototype=pi.prototype={constructor:Gt,select:Tf,selectAll:Rf,selectChild:wf,selectChildren:Pf,filter:Ff,data:$f,enter:Of,exit:Kf,join:Hf,merge:Vf,selection:jd,order:Yf,sort:Wf,call:zf,nodes:Xf,node:jf,size:Qf,empty:Jf,each:Zf,attr:ad,style:ud,property:gd,classed:vd,text:Sd,html:_d,raise:bd,lower:Dd,append:Cd,insert:Pd,remove:Od,clone:Ud,datum:Bd,on:Vd,dispatch:qd,[Symbol.iterator]:zd};function Qs(n,t,e){n.prototype=t.prototype=e,e.constructor=n}function dc(n,t){var e=Object.create(n.prototype);for(var i in t)e[i]=t[i];return e}function zi(){}var Fi=.7,kn=1/Fi,Ze="\\s*([+-]?\\d+)\\s*",Oi="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ee="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Qd=/^#([0-9a-f]{3,8})$/,Jd=new RegExp(`^rgb\\(${Ze},${Ze},${Ze}\\)$`),Zd=new RegExp(`^rgb\\(${ee},${ee},${ee}\\)$`),t0=new RegExp(`^rgba\\(${Ze},${Ze},${Ze},${Oi}\\)$`),e0=new RegExp(`^rgba\\(${ee},${ee},${ee},${Oi}\\)$`),i0=new RegExp(`^hsl\\(${Oi},${ee},${ee}\\)$`),n0=new RegExp(`^hsla\\(${Oi},${ee},${ee},${Oi}\\)$`),Ka={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Qs(zi,Mi,{copy(n){return Object.assign(new this.constructor,this,n)},displayable(){return this.rgb().displayable()},hex:Ha,formatHex:Ha,formatHex8:r0,formatHsl:s0,formatRgb:Va,toString:Va});function Ha(){return this.rgb().formatHex()}function r0(){return this.rgb().formatHex8()}function s0(){return gc(this).formatHsl()}function Va(){return this.rgb().formatRgb()}function Mi(n){var t,e;return n=(n+"").trim().toLowerCase(),(t=Qd.exec(n))?(e=t[1].length,t=parseInt(t[1],16),e===6?Ya(t):e===3?new Lt(t>>8&15|t>>4&240,t>>4&15|t&240,(t&15)<<4|t&15,1):e===8?ji(t>>24&255,t>>16&255,t>>8&255,(t&255)/255):e===4?ji(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|t&240,((t&15)<<4|t&15)/255):null):(t=Jd.exec(n))?new Lt(t[1],t[2],t[3],1):(t=Zd.exec(n))?new Lt(t[1]*255/100,t[2]*255/100,t[3]*255/100,1):(t=t0.exec(n))?ji(t[1],t[2],t[3],t[4]):(t=e0.exec(n))?ji(t[1]*255/100,t[2]*255/100,t[3]*255/100,t[4]):(t=i0.exec(n))?za(t[1],t[2]/100,t[3]/100,1):(t=n0.exec(n))?za(t[1],t[2]/100,t[3]/100,t[4]):Ka.hasOwnProperty(n)?Ya(Ka[n]):n==="transparent"?new Lt(NaN,NaN,NaN,0):null}function Ya(n){return new Lt(n>>16&255,n>>8&255,n&255,1)}function ji(n,t,e,i){return i<=0&&(n=t=e=NaN),new Lt(n,t,e,i)}function a0(n){return n instanceof zi||(n=Mi(n)),n?(n=n.rgb(),new Lt(n.r,n.g,n.b,n.opacity)):new Lt}function ns(n,t,e,i){return arguments.length===1?a0(n):new Lt(n,t,e,i??1)}function Lt(n,t,e,i){this.r=+n,this.g=+t,this.b=+e,this.opacity=+i}Qs(Lt,ns,dc(zi,{brighter(n){return n=n==null?kn:Math.pow(kn,n),new Lt(this.r*n,this.g*n,this.b*n,this.opacity)},darker(n){return n=n==null?Fi:Math.pow(Fi,n),new Lt(this.r*n,this.g*n,this.b*n,this.opacity)},rgb(){return this},clamp(){return new Lt(Ce(this.r),Ce(this.g),Ce(this.b),Pn(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Wa,formatHex:Wa,formatHex8:o0,formatRgb:qa,toString:qa}));function Wa(){return`#${we(this.r)}${we(this.g)}${we(this.b)}`}function o0(){return`#${we(this.r)}${we(this.g)}${we(this.b)}${we((isNaN(this.opacity)?1:this.opacity)*255)}`}function qa(){const n=Pn(this.opacity);return`${n===1?"rgb(":"rgba("}${Ce(this.r)}, ${Ce(this.g)}, ${Ce(this.b)}${n===1?")":`, ${n})`}`}function Pn(n){return isNaN(n)?1:Math.max(0,Math.min(1,n))}function Ce(n){return Math.max(0,Math.min(255,Math.round(n)||0))}function we(n){return n=Ce(n),(n<16?"0":"")+n.toString(16)}function za(n,t,e,i){return i<=0?n=t=e=NaN:e<=0||e>=1?n=t=NaN:t<=0&&(n=NaN),new Bt(n,t,e,i)}function gc(n){if(n instanceof Bt)return new Bt(n.h,n.s,n.l,n.opacity);if(n instanceof zi||(n=Mi(n)),!n)return new Bt;if(n instanceof Bt)return n;n=n.rgb();var t=n.r/255,e=n.g/255,i=n.b/255,r=Math.min(t,e,i),s=Math.max(t,e,i),a=NaN,o=s-r,l=(s+r)/2;return o?(t===s?a=(e-i)/o+(e<i)*6:e===s?a=(i-t)/o+2:a=(t-e)/o+4,o/=l<.5?s+r:2-s-r,a*=60):o=l>0&&l<1?0:a,new Bt(a,o,l,n.opacity)}function l0(n,t,e,i){return arguments.length===1?gc(n):new Bt(n,t,e,i??1)}function Bt(n,t,e,i){this.h=+n,this.s=+t,this.l=+e,this.opacity=+i}Qs(Bt,l0,dc(zi,{brighter(n){return n=n==null?kn:Math.pow(kn,n),new Bt(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?Fi:Math.pow(Fi,n),new Bt(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=this.h%360+(this.h<0)*360,t=isNaN(n)||isNaN(this.s)?0:this.s,e=this.l,i=e+(e<.5?e:1-e)*t,r=2*e-i;return new Lt(vr(n>=240?n-240:n+120,r,i),vr(n,r,i),vr(n<120?n+240:n-120,r,i),this.opacity)},clamp(){return new Bt(Xa(this.h),Qi(this.s),Qi(this.l),Pn(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const n=Pn(this.opacity);return`${n===1?"hsl(":"hsla("}${Xa(this.h)}, ${Qi(this.s)*100}%, ${Qi(this.l)*100}%${n===1?")":`, ${n})`}`}}));function Xa(n){return n=(n||0)%360,n<0?n+360:n}function Qi(n){return Math.max(0,Math.min(1,n||0))}function vr(n,t,e){return(n<60?t+(e-t)*n/60:n<180?e:n<240?t+(e-t)*(240-n)/60:t)*255}const mc=n=>()=>n;function c0(n,t){return function(e){return n+e*t}}function u0(n,t,e){return n=Math.pow(n,e),t=Math.pow(t,e)-n,e=1/e,function(i){return Math.pow(n+i*t,e)}}function h0(n){return(n=+n)==1?pc:function(t,e){return e-t?u0(t,e,n):mc(isNaN(t)?e:t)}}function pc(n,t){var e=t-n;return e?c0(n,e):mc(isNaN(n)?t:n)}const ja=function n(t){var e=h0(t);function i(r,s){var a=e((r=ns(r)).r,(s=ns(s)).r),o=e(r.g,s.g),l=e(r.b,s.b),c=pc(r.opacity,s.opacity);return function(u){return r.r=a(u),r.g=o(u),r.b=l(u),r.opacity=c(u),r+""}}return i.gamma=n,i}(1);function ve(n,t){return n=+n,t=+t,function(e){return n*(1-e)+t*e}}var rs=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Er=new RegExp(rs.source,"g");function f0(n){return function(){return n}}function d0(n){return function(t){return n(t)+""}}function g0(n,t){var e=rs.lastIndex=Er.lastIndex=0,i,r,s,a=-1,o=[],l=[];for(n=n+"",t=t+"";(i=rs.exec(n))&&(r=Er.exec(t));)(s=r.index)>e&&(s=t.slice(e,s),o[a]?o[a]+=s:o[++a]=s),(i=i[0])===(r=r[0])?o[a]?o[a]+=r:o[++a]=r:(o[++a]=null,l.push({i:a,x:ve(i,r)})),e=Er.lastIndex;return e<t.length&&(s=t.slice(e),o[a]?o[a]+=s:o[++a]=s),o.length<2?l[0]?d0(l[0].x):f0(t):(t=l.length,function(c){for(var u=0,h;u<t;++u)o[(h=l[u]).i]=h.x(c);return o.join("")})}var Qa=180/Math.PI,ss={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function yc(n,t,e,i,r,s){var a,o,l;return(a=Math.sqrt(n*n+t*t))&&(n/=a,t/=a),(l=n*e+t*i)&&(e-=n*l,i-=t*l),(o=Math.sqrt(e*e+i*i))&&(e/=o,i/=o,l/=o),n*i<t*e&&(n=-n,t=-t,l=-l,a=-a),{translateX:r,translateY:s,rotate:Math.atan2(t,n)*Qa,skewX:Math.atan(l)*Qa,scaleX:a,scaleY:o}}var Ji;function m0(n){const t=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(n+"");return t.isIdentity?ss:yc(t.a,t.b,t.c,t.d,t.e,t.f)}function p0(n){return n==null||(Ji||(Ji=document.createElementNS("http://www.w3.org/2000/svg","g")),Ji.setAttribute("transform",n),!(n=Ji.transform.baseVal.consolidate()))?ss:(n=n.matrix,yc(n.a,n.b,n.c,n.d,n.e,n.f))}function vc(n,t,e,i){function r(c){return c.length?c.pop()+" ":""}function s(c,u,h,f,d,g){if(c!==h||u!==f){var m=d.push("translate(",null,t,null,e);g.push({i:m-4,x:ve(c,h)},{i:m-2,x:ve(u,f)})}else(h||f)&&d.push("translate("+h+t+f+e)}function a(c,u,h,f){c!==u?(c-u>180?u+=360:u-c>180&&(c+=360),f.push({i:h.push(r(h)+"rotate(",null,i)-2,x:ve(c,u)})):u&&h.push(r(h)+"rotate("+u+i)}function o(c,u,h,f){c!==u?f.push({i:h.push(r(h)+"skewX(",null,i)-2,x:ve(c,u)}):u&&h.push(r(h)+"skewX("+u+i)}function l(c,u,h,f,d,g){if(c!==h||u!==f){var m=d.push(r(d)+"scale(",null,",",null,")");g.push({i:m-4,x:ve(c,h)},{i:m-2,x:ve(u,f)})}else(h!==1||f!==1)&&d.push(r(d)+"scale("+h+","+f+")")}return function(c,u){var h=[],f=[];return c=n(c),u=n(u),s(c.translateX,c.translateY,u.translateX,u.translateY,h,f),a(c.rotate,u.rotate,h,f),o(c.skewX,u.skewX,h,f),l(c.scaleX,c.scaleY,u.scaleX,u.scaleY,h,f),c=u=null,function(d){for(var g=-1,m=f.length,p;++g<m;)h[(p=f[g]).i]=p.x(d);return h.join("")}}}var y0=vc(m0,"px, ","px)","deg)"),Ec=vc(p0,", ",")",")"),ri=0,Si=0,Ei=0,xc=1e3,Fn,Ai,On=0,Fe=0,ur=0,Ni=typeof performance=="object"&&performance.now?performance:Date,Tc=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(n){setTimeout(n,17)};function Js(){return Fe||(Tc(v0),Fe=Ni.now()+ur)}function v0(){Fe=0}function Mn(){this._call=this._time=this._next=null}Mn.prototype=Sc.prototype={constructor:Mn,restart:function(n,t,e){if(typeof n!="function")throw new TypeError("callback is not a function");e=(e==null?Js():+e)+(t==null?0:+t),!this._next&&Ai!==this&&(Ai?Ai._next=this:Fn=this,Ai=this),this._call=n,this._time=e,as()},stop:function(){this._call&&(this._call=null,this._time=1/0,as())}};function Sc(n,t,e){var i=new Mn;return i.restart(n,t,e),i}function E0(){Js(),++ri;for(var n=Fn,t;n;)(t=Fe-n._time)>=0&&n._call.call(void 0,t),n=n._next;--ri}function Ja(){Fe=(On=Ni.now())+ur,ri=Si=0;try{E0()}finally{ri=0,T0(),Fe=0}}function x0(){var n=Ni.now(),t=n-On;t>xc&&(ur-=t,On=n)}function T0(){for(var n,t=Fn,e,i=1/0;t;)t._call?(i>t._time&&(i=t._time),n=t,t=t._next):(e=t._next,t._next=null,t=n?n._next=e:Fn=e);Ai=n,as(i)}function as(n){if(!ri){Si&&(Si=clearTimeout(Si));var t=n-Fe;t>24?(n<1/0&&(Si=setTimeout(Ja,n-Ni.now()-ur)),Ei&&(Ei=clearInterval(Ei))):(Ei||(On=Ni.now(),Ei=setInterval(x0,xc)),ri=1,Tc(Ja))}}function Za(n,t,e){var i=new Mn;return t=t==null?0:+t,i.restart(r=>{i.stop(),n(r+t)},t,e),i}var S0=ec("start","end","cancel","interrupt"),A0=[],Ac=0,to=1,os=2,pn=3,eo=4,ls=5,yn=6;function hr(n,t,e,i,r,s){var a=n.__transition;if(!a)n.__transition={};else if(e in a)return;L0(n,e,{name:t,index:i,group:r,on:S0,tween:A0,time:s.time,delay:s.delay,duration:s.duration,ease:s.ease,timer:null,state:Ac})}function Zs(n,t){var e=Ht(n,t);if(e.state>Ac)throw new Error("too late; already scheduled");return e}function se(n,t){var e=Ht(n,t);if(e.state>pn)throw new Error("too late; already running");return e}function Ht(n,t){var e=n.__transition;if(!e||!(e=e[t]))throw new Error("transition not found");return e}function L0(n,t,e){var i=n.__transition,r;i[t]=e,e.timer=Sc(s,0,e.time);function s(c){e.state=to,e.timer.restart(a,e.delay,e.time),e.delay<=c&&a(c-e.delay)}function a(c){var u,h,f,d;if(e.state!==to)return l();for(u in i)if(d=i[u],d.name===e.name){if(d.state===pn)return Za(a);d.state===eo?(d.state=yn,d.timer.stop(),d.on.call("interrupt",n,n.__data__,d.index,d.group),delete i[u]):+u<t&&(d.state=yn,d.timer.stop(),d.on.call("cancel",n,n.__data__,d.index,d.group),delete i[u])}if(Za(function(){e.state===pn&&(e.state=eo,e.timer.restart(o,e.delay,e.time),o(c))}),e.state=os,e.on.call("start",n,n.__data__,e.index,e.group),e.state===os){for(e.state=pn,r=new Array(f=e.tween.length),u=0,h=-1;u<f;++u)(d=e.tween[u].value.call(n,n.__data__,e.index,e.group))&&(r[++h]=d);r.length=h+1}}function o(c){for(var u=c<e.duration?e.ease.call(null,c/e.duration):(e.timer.restart(l),e.state=ls,1),h=-1,f=r.length;++h<f;)r[h].call(n,u);e.state===ls&&(e.on.call("end",n,n.__data__,e.index,e.group),l())}function l(){e.state=yn,e.timer.stop(),delete i[t];for(var c in i)return;delete n.__transition}}function R0(n,t){var e=n.__transition,i,r,s=!0,a;if(e){t=t==null?null:t+"";for(a in e){if((i=e[a]).name!==t){s=!1;continue}r=i.state>os&&i.state<ls,i.state=yn,i.timer.stop(),i.on.call(r?"interrupt":"cancel",n,n.__data__,i.index,i.group),delete e[a]}s&&delete n.__transition}}function _0(n){return this.each(function(){R0(this,n)})}function I0(n,t){var e,i;return function(){var r=se(this,n),s=r.tween;if(s!==e){i=e=s;for(var a=0,o=i.length;a<o;++a)if(i[a].name===t){i=i.slice(),i.splice(a,1);break}}r.tween=i}}function b0(n,t,e){var i,r;if(typeof e!="function")throw new Error;return function(){var s=se(this,n),a=s.tween;if(a!==i){r=(i=a).slice();for(var o={name:t,value:e},l=0,c=r.length;l<c;++l)if(r[l].name===t){r[l]=o;break}l===c&&r.push(o)}s.tween=r}}function w0(n,t){var e=this._id;if(n+="",arguments.length<2){for(var i=Ht(this.node(),e).tween,r=0,s=i.length,a;r<s;++r)if((a=i[r]).name===n)return a.value;return null}return this.each((t==null?I0:b0)(e,n,t))}function ta(n,t,e){var i=n._id;return n.each(function(){var r=se(this,i);(r.value||(r.value={}))[t]=e.apply(this,arguments)}),function(r){return Ht(r,i).value[t]}}function Lc(n,t){var e;return(typeof t=="number"?ve:t instanceof Mi?ja:(e=Mi(t))?(t=e,ja):g0)(n,t)}function D0(n){return function(){this.removeAttribute(n)}}function C0(n){return function(){this.removeAttributeNS(n.space,n.local)}}function k0(n,t,e){var i,r=e+"",s;return function(){var a=this.getAttribute(n);return a===r?null:a===i?s:s=t(i=a,e)}}function P0(n,t,e){var i,r=e+"",s;return function(){var a=this.getAttributeNS(n.space,n.local);return a===r?null:a===i?s:s=t(i=a,e)}}function F0(n,t,e){var i,r,s;return function(){var a,o=e(this),l;return o==null?void this.removeAttribute(n):(a=this.getAttribute(n),l=o+"",a===l?null:a===i&&l===r?s:(r=l,s=t(i=a,o)))}}function O0(n,t,e){var i,r,s;return function(){var a,o=e(this),l;return o==null?void this.removeAttributeNS(n.space,n.local):(a=this.getAttributeNS(n.space,n.local),l=o+"",a===l?null:a===i&&l===r?s:(r=l,s=t(i=a,o)))}}function M0(n,t){var e=cr(n),i=e==="transform"?Ec:Lc;return this.attrTween(n,typeof t=="function"?(e.local?O0:F0)(e,i,ta(this,"attr."+n,t)):t==null?(e.local?C0:D0)(e):(e.local?P0:k0)(e,i,t))}function N0(n,t){return function(e){this.setAttribute(n,t.call(this,e))}}function U0(n,t){return function(e){this.setAttributeNS(n.space,n.local,t.call(this,e))}}function B0(n,t){var e,i;function r(){var s=t.apply(this,arguments);return s!==i&&(e=(i=s)&&U0(n,s)),e}return r._value=t,r}function $0(n,t){var e,i;function r(){var s=t.apply(this,arguments);return s!==i&&(e=(i=s)&&N0(n,s)),e}return r._value=t,r}function G0(n,t){var e="attr."+n;if(arguments.length<2)return(e=this.tween(e))&&e._value;if(t==null)return this.tween(e,null);if(typeof t!="function")throw new Error;var i=cr(n);return this.tween(e,(i.local?B0:$0)(i,t))}function K0(n,t){return function(){Zs(this,n).delay=+t.apply(this,arguments)}}function H0(n,t){return t=+t,function(){Zs(this,n).delay=t}}function V0(n){var t=this._id;return arguments.length?this.each((typeof n=="function"?K0:H0)(t,n)):Ht(this.node(),t).delay}function Y0(n,t){return function(){se(this,n).duration=+t.apply(this,arguments)}}function W0(n,t){return t=+t,function(){se(this,n).duration=t}}function q0(n){var t=this._id;return arguments.length?this.each((typeof n=="function"?Y0:W0)(t,n)):Ht(this.node(),t).duration}function z0(n,t){if(typeof t!="function")throw new Error;return function(){se(this,n).ease=t}}function X0(n){var t=this._id;return arguments.length?this.each(z0(t,n)):Ht(this.node(),t).ease}function j0(n,t){return function(){var e=t.apply(this,arguments);if(typeof e!="function")throw new Error;se(this,n).ease=e}}function Q0(n){if(typeof n!="function")throw new Error;return this.each(j0(this._id,n))}function J0(n){typeof n!="function"&&(n=rc(n));for(var t=this._groups,e=t.length,i=new Array(e),r=0;r<e;++r)for(var s=t[r],a=s.length,o=i[r]=[],l,c=0;c<a;++c)(l=s[c])&&n.call(l,l.__data__,c,s)&&o.push(l);return new me(i,this._parents,this._name,this._id)}function Z0(n){if(n._id!==this._id)throw new Error;for(var t=this._groups,e=n._groups,i=t.length,r=e.length,s=Math.min(i,r),a=new Array(i),o=0;o<s;++o)for(var l=t[o],c=e[o],u=l.length,h=a[o]=new Array(u),f,d=0;d<u;++d)(f=l[d]||c[d])&&(h[d]=f);for(;o<i;++o)a[o]=t[o];return new me(a,this._parents,this._name,this._id)}function tg(n){return(n+"").trim().split(/^|\s+/).every(function(t){var e=t.indexOf(".");return e>=0&&(t=t.slice(0,e)),!t||t==="start"})}function eg(n,t,e){var i,r,s=tg(t)?Zs:se;return function(){var a=s(this,n),o=a.on;o!==i&&(r=(i=o).copy()).on(t,e),a.on=r}}function ig(n,t){var e=this._id;return arguments.length<2?Ht(this.node(),e).on.on(n):this.each(eg(e,n,t))}function ng(n){return function(){var t=this.parentNode;for(var e in this.__transition)if(+e!==n)return;t&&t.removeChild(this)}}function rg(){return this.on("end.remove",ng(this._id))}function sg(n){var t=this._name,e=this._id;typeof n!="function"&&(n=Xs(n));for(var i=this._groups,r=i.length,s=new Array(r),a=0;a<r;++a)for(var o=i[a],l=o.length,c=s[a]=new Array(l),u,h,f=0;f<l;++f)(u=o[f])&&(h=n.call(u,u.__data__,f,o))&&("__data__"in u&&(h.__data__=u.__data__),c[f]=h,hr(c[f],t,e,f,c,Ht(u,e)));return new me(s,this._parents,t,e)}function ag(n){var t=this._name,e=this._id;typeof n!="function"&&(n=nc(n));for(var i=this._groups,r=i.length,s=[],a=[],o=0;o<r;++o)for(var l=i[o],c=l.length,u,h=0;h<c;++h)if(u=l[h]){for(var f=n.call(u,u.__data__,h,l),d,g=Ht(u,e),m=0,p=f.length;m<p;++m)(d=f[m])&&hr(d,t,e,m,f,g);s.push(f),a.push(u)}return new me(s,a,t,e)}var og=pi.prototype.constructor;function lg(){return new og(this._groups,this._parents)}function cg(n,t){var e,i,r;return function(){var s=ni(this,n),a=(this.style.removeProperty(n),ni(this,n));return s===a?null:s===e&&a===i?r:r=t(e=s,i=a)}}function Rc(n){return function(){this.style.removeProperty(n)}}function ug(n,t,e){var i,r=e+"",s;return function(){var a=ni(this,n);return a===r?null:a===i?s:s=t(i=a,e)}}function hg(n,t,e){var i,r,s;return function(){var a=ni(this,n),o=e(this),l=o+"";return o==null&&(l=o=(this.style.removeProperty(n),ni(this,n))),a===l?null:a===i&&l===r?s:(r=l,s=t(i=a,o))}}function fg(n,t){var e,i,r,s="style."+t,a="end."+s,o;return function(){var l=se(this,n),c=l.on,u=l.value[s]==null?o||(o=Rc(t)):void 0;(c!==e||r!==u)&&(i=(e=c).copy()).on(a,r=u),l.on=i}}function dg(n,t,e){var i=(n+="")=="transform"?y0:Lc;return t==null?this.styleTween(n,cg(n,i)).on("end.style."+n,Rc(n)):typeof t=="function"?this.styleTween(n,hg(n,i,ta(this,"style."+n,t))).each(fg(this._id,n)):this.styleTween(n,ug(n,i,t),e).on("end.style."+n,null)}function gg(n,t,e){return function(i){this.style.setProperty(n,t.call(this,i),e)}}function mg(n,t,e){var i,r;function s(){var a=t.apply(this,arguments);return a!==r&&(i=(r=a)&&gg(n,a,e)),i}return s._value=t,s}function pg(n,t,e){var i="style."+(n+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(t==null)return this.tween(i,null);if(typeof t!="function")throw new Error;return this.tween(i,mg(n,t,e??""))}function yg(n){return function(){this.textContent=n}}function vg(n){return function(){var t=n(this);this.textContent=t??""}}function Eg(n){return this.tween("text",typeof n=="function"?vg(ta(this,"text",n)):yg(n==null?"":n+""))}function xg(n){return function(t){this.textContent=n.call(this,t)}}function Tg(n){var t,e;function i(){var r=n.apply(this,arguments);return r!==e&&(t=(e=r)&&xg(r)),t}return i._value=n,i}function Sg(n){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(n==null)return this.tween(t,null);if(typeof n!="function")throw new Error;return this.tween(t,Tg(n))}function Ag(){for(var n=this._name,t=this._id,e=Ic(),i=this._groups,r=i.length,s=0;s<r;++s)for(var a=i[s],o=a.length,l,c=0;c<o;++c)if(l=a[c]){var u=Ht(l,t);hr(l,n,e,c,a,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new me(i,this._parents,n,e)}function Lg(){var n,t,e=this,i=e._id,r=e.size();return new Promise(function(s,a){var o={value:a},l={value:function(){--r===0&&s()}};e.each(function(){var c=se(this,i),u=c.on;u!==n&&(t=(n=u).copy(),t._.cancel.push(o),t._.interrupt.push(o),t._.end.push(l)),c.on=t}),r===0&&s()})}var Rg=0;function me(n,t,e,i){this._groups=n,this._parents=t,this._name=e,this._id=i}function _c(n){return pi().transition(n)}function Ic(){return++Rg}var le=pi.prototype;me.prototype=_c.prototype={constructor:me,select:sg,selectAll:ag,selectChild:le.selectChild,selectChildren:le.selectChildren,filter:J0,merge:Z0,selection:lg,transition:Ag,call:le.call,nodes:le.nodes,node:le.node,size:le.size,empty:le.empty,each:le.each,on:ig,attr:M0,attrTween:G0,style:dg,styleTween:pg,text:Eg,textTween:Sg,remove:rg,tween:w0,delay:V0,duration:q0,ease:X0,easeVarying:Q0,end:Lg,[Symbol.iterator]:le[Symbol.iterator]};function _g(n){return((n*=2)<=1?n*n*n:(n-=2)*n*n+2)/2}var Ig={time:null,delay:0,duration:250,ease:_g};function bg(n,t){for(var e;!(e=n.__transition)||!(e=e[t]);)if(!(n=n.parentNode))throw new Error(`transition ${t} not found`);return e}function wg(n){var t,e;n instanceof me?(t=n._id,n=n._name):(t=Ic(),(e=Ig).time=Js(),n=n==null?null:n+"");for(var i=this._groups,r=i.length,s=0;s<r;++s)for(var a=i[s],o=a.length,l,c=0;c<o;++c)(l=a[c])&&hr(l,n,t,c,a,e||bg(l,t));return new me(i,this._parents,n,t)}pi.prototype.interrupt=_0;pi.prototype.transition=wg;function Dg(n){if(!n.ok)throw new Error(n.status+" "+n.statusText);if(!(n.status===204||n.status===205))return n.json()}function Cg(n,t){return fetch(n,t).then(Dg)}var it=1e-6,kg=1e-12,J=Math.PI,Ct=J/2,io=J/4,Pt=J*2,ce=180/J,_t=J/180,ht=Math.abs,Pg=Math.atan,si=Math.atan2,ut=Math.cos,lt=Math.sin,Fg=Math.sign||function(n){return n>0?1:n<0?-1:0},Re=Math.sqrt;function Og(n){return n>1?0:n<-1?J:Math.acos(n)}function Oe(n){return n>1?Ct:n<-1?-Ct:Math.asin(n)}function kt(){}function Nn(n,t){n&&ro.hasOwnProperty(n.type)&&ro[n.type](n,t)}var no={Feature:function(n,t){Nn(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,i=-1,r=e.length;++i<r;)Nn(e[i].geometry,t)}},ro={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var e=n.coordinates,i=-1,r=e.length;++i<r;)n=e[i],t.point(n[0],n[1],n[2])},LineString:function(n,t){cs(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,i=-1,r=e.length;++i<r;)cs(e[i],t,0)},Polygon:function(n,t){so(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,i=-1,r=e.length;++i<r;)so(e[i],t)},GeometryCollection:function(n,t){for(var e=n.geometries,i=-1,r=e.length;++i<r;)Nn(e[i],t)}};function cs(n,t,e){var i=-1,r=n.length-e,s;for(t.lineStart();++i<r;)s=n[i],t.point(s[0],s[1],s[2]);t.lineEnd()}function so(n,t){var e=-1,i=n.length;for(t.polygonStart();++e<i;)cs(n[e],t,1);t.polygonEnd()}function qe(n,t){n&&no.hasOwnProperty(n.type)?no[n.type](n,t):Nn(n,t)}function us(n){return[si(n[1],n[0]),Oe(n[2])]}function ai(n){var t=n[0],e=n[1],i=ut(e);return[i*ut(t),i*lt(t),lt(e)]}function Zi(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function Un(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function xr(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function tn(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function hs(n){var t=Re(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function fs(n,t){function e(i,r){return i=n(i,r),t(i[0],i[1])}return n.invert&&t.invert&&(e.invert=function(i,r){return i=t.invert(i,r),i&&n.invert(i[0],i[1])}),e}function ds(n,t){return ht(n)>J&&(n-=Math.round(n/Pt)*Pt),[n,t]}ds.invert=ds;function Mg(n,t,e){return(n%=Pt)?t||e?fs(oo(n),lo(t,e)):oo(n):t||e?lo(t,e):ds}function ao(n){return function(t,e){return t+=n,ht(t)>J&&(t-=Math.round(t/Pt)*Pt),[t,e]}}function oo(n){var t=ao(n);return t.invert=ao(-n),t}function lo(n,t){var e=ut(n),i=lt(n),r=ut(t),s=lt(t);function a(o,l){var c=ut(l),u=ut(o)*c,h=lt(o)*c,f=lt(l),d=f*e+u*i;return[si(h*r-d*s,u*e-f*i),Oe(d*r+h*s)]}return a.invert=function(o,l){var c=ut(l),u=ut(o)*c,h=lt(o)*c,f=lt(l),d=f*r-h*s;return[si(h*r+f*s,u*e+d*i),Oe(d*e-u*i)]},a}function Ng(n,t,e,i,r,s){if(e){var a=ut(t),o=lt(t),l=i*e;r==null?(r=t+i*Pt,s=t-l/2):(r=co(a,r),s=co(a,s),(i>0?r<s:r>s)&&(r+=i*Pt));for(var c,u=r;i>0?u>s:u<s;u-=l)c=us([a,-o*ut(u),-o*lt(u)]),n.point(c[0],c[1])}}function co(n,t){t=ai(t),t[0]-=n,hs(t);var e=Og(-t[1]);return((-t[2]<0?-e:e)+Pt-it)%Pt}function bc(){var n=[],t;return{point:function(e,i,r){t.push([e,i,r])},lineStart:function(){n.push(t=[])},lineEnd:kt,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var e=n;return n=[],t=null,e}}}function vn(n,t){return ht(n[0]-t[0])<it&&ht(n[1]-t[1])<it}function en(n,t,e,i){this.x=n,this.z=t,this.o=e,this.e=i,this.v=!1,this.n=this.p=null}function wc(n,t,e,i,r){var s=[],a=[],o,l;if(n.forEach(function(g){if(!((m=g.length-1)<=0)){var m,p=g[0],v=g[m],x;if(vn(p,v)){if(!p[2]&&!v[2]){for(r.lineStart(),o=0;o<m;++o)r.point((p=g[o])[0],p[1]);r.lineEnd();return}v[0]+=2*it}s.push(x=new en(p,g,null,!0)),a.push(x.o=new en(p,null,x,!1)),s.push(x=new en(v,g,null,!1)),a.push(x.o=new en(v,null,x,!0))}}),!!s.length){for(a.sort(t),uo(s),uo(a),o=0,l=a.length;o<l;++o)a[o].e=e=!e;for(var c=s[0],u,h;;){for(var f=c,d=!0;f.v;)if((f=f.n)===c)return;u=f.z,r.lineStart();do{if(f.v=f.o.v=!0,f.e){if(d)for(o=0,l=u.length;o<l;++o)r.point((h=u[o])[0],h[1]);else i(f.x,f.n.x,1,r);f=f.n}else{if(d)for(u=f.p.z,o=u.length-1;o>=0;--o)r.point((h=u[o])[0],h[1]);else i(f.x,f.p.x,-1,r);f=f.p}f=f.o,u=f.z,d=!d}while(!f.v);r.lineEnd()}}}function uo(n){if(t=n.length){for(var t,e=0,i=n[0],r;++e<t;)i.n=r=n[e],r.p=i,i=r;i.n=r=n[0],r.p=i}}function Tr(n){return ht(n[0])<=J?n[0]:Fg(n[0])*((ht(n[0])+J)%Pt-J)}function Ug(n,t){var e=Tr(t),i=t[1],r=lt(i),s=[lt(e),-ut(e),0],a=0,o=0,l=new Pe;r===1?i=Ct+it:r===-1&&(i=-Ct-it);for(var c=0,u=n.length;c<u;++c)if(f=(h=n[c]).length)for(var h,f,d=h[f-1],g=Tr(d),m=d[1]/2+io,p=lt(m),v=ut(m),x=0;x<f;++x,g=S,p=R,v=A,d=T){var T=h[x],S=Tr(T),E=T[1]/2+io,R=lt(E),A=ut(E),C=S-g,k=C>=0?1:-1,I=k*C,b=I>J,$=p*R;if(l.add(si($*k*lt(I),v*A+$*ut(I))),a+=b?C+k*Pt:C,b^g>=e^S>=e){var F=Un(ai(d),ai(T));hs(F);var M=Un(s,F);hs(M);var w=(b^C>=0?-1:1)*Oe(M[2]);(i>w||i===w&&(F[0]||F[1]))&&(o+=b^C>=0?1:-1)}}return(a<-it||a<it&&l<-kg)^o&1}function Dc(n,t,e,i){return function(r){var s=t(r),a=bc(),o=t(a),l=!1,c,u,h,f={point:d,lineStart:m,lineEnd:p,polygonStart:function(){f.point=v,f.lineStart=x,f.lineEnd=T,u=[],c=[]},polygonEnd:function(){f.point=d,f.lineStart=m,f.lineEnd=p,u=tc(u);var S=Ug(c,i);u.length?(l||(r.polygonStart(),l=!0),wc(u,$g,S,e,r)):S&&(l||(r.polygonStart(),l=!0),r.lineStart(),e(null,null,1,r),r.lineEnd()),l&&(r.polygonEnd(),l=!1),u=c=null},sphere:function(){r.polygonStart(),r.lineStart(),e(null,null,1,r),r.lineEnd(),r.polygonEnd()}};function d(S,E){n(S,E)&&r.point(S,E)}function g(S,E){s.point(S,E)}function m(){f.point=g,s.lineStart()}function p(){f.point=d,s.lineEnd()}function v(S,E){h.push([S,E]),o.point(S,E)}function x(){o.lineStart(),h=[]}function T(){v(h[0][0],h[0][1]),o.lineEnd();var S=o.clean(),E=a.result(),R,A=E.length,C,k,I;if(h.pop(),c.push(h),h=null,!!A){if(S&1){if(k=E[0],(C=k.length-1)>0){for(l||(r.polygonStart(),l=!0),r.lineStart(),R=0;R<C;++R)r.point((I=k[R])[0],I[1]);r.lineEnd()}return}A>1&&S&2&&E.push(E.pop().concat(E.shift())),u.push(E.filter(Bg))}}return f}}function Bg(n){return n.length>1}function $g(n,t){return((n=n.x)[0]<0?n[1]-Ct-it:Ct-n[1])-((t=t.x)[0]<0?t[1]-Ct-it:Ct-t[1])}const ho=Dc(function(){return!0},Gg,Hg,[-J,-Ct]);function Gg(n){var t=NaN,e=NaN,i=NaN,r;return{lineStart:function(){n.lineStart(),r=1},point:function(s,a){var o=s>0?J:-J,l=ht(s-t);ht(l-J)<it?(n.point(t,e=(e+a)/2>0?Ct:-Ct),n.point(i,e),n.lineEnd(),n.lineStart(),n.point(o,e),n.point(s,e),r=0):i!==o&&l>=J&&(ht(t-i)<it&&(t-=i*it),ht(s-o)<it&&(s-=o*it),e=Kg(t,e,s,a),n.point(i,e),n.lineEnd(),n.lineStart(),n.point(o,e),r=0),n.point(t=s,e=a),i=o},lineEnd:function(){n.lineEnd(),t=e=NaN},clean:function(){return 2-r}}}function Kg(n,t,e,i){var r,s,a=lt(n-e);return ht(a)>it?Pg((lt(t)*(s=ut(i))*lt(e)-lt(i)*(r=ut(t))*lt(n))/(r*s*a)):(t+i)/2}function Hg(n,t,e,i){var r;if(n==null)r=e*Ct,i.point(-J,r),i.point(0,r),i.point(J,r),i.point(J,0),i.point(J,-r),i.point(0,-r),i.point(-J,-r),i.point(-J,0),i.point(-J,r);else if(ht(n[0]-t[0])>it){var s=n[0]<t[0]?J:-J;r=e*s/2,i.point(-s,r),i.point(0,r),i.point(s,r)}else i.point(t[0],t[1])}function Vg(n){var t=ut(n),e=2*_t,i=t>0,r=ht(t)>it;function s(u,h,f,d){Ng(d,n,e,f,u,h)}function a(u,h){return ut(u)*ut(h)>t}function o(u){var h,f,d,g,m;return{lineStart:function(){g=d=!1,m=1},point:function(p,v){var x=[p,v],T,S=a(p,v),E=i?S?0:c(p,v):S?c(p+(p<0?J:-J),v):0;if(!h&&(g=d=S)&&u.lineStart(),S!==d&&(T=l(h,x),(!T||vn(h,T)||vn(x,T))&&(x[2]=1)),S!==d)m=0,S?(u.lineStart(),T=l(x,h),u.point(T[0],T[1])):(T=l(h,x),u.point(T[0],T[1],2),u.lineEnd()),h=T;else if(r&&h&&i^S){var R;!(E&f)&&(R=l(x,h,!0))&&(m=0,i?(u.lineStart(),u.point(R[0][0],R[0][1]),u.point(R[1][0],R[1][1]),u.lineEnd()):(u.point(R[1][0],R[1][1]),u.lineEnd(),u.lineStart(),u.point(R[0][0],R[0][1],3)))}S&&(!h||!vn(h,x))&&u.point(x[0],x[1]),h=x,d=S,f=E},lineEnd:function(){d&&u.lineEnd(),h=null},clean:function(){return m|(g&&d)<<1}}}function l(u,h,f){var d=ai(u),g=ai(h),m=[1,0,0],p=Un(d,g),v=Zi(p,p),x=p[0],T=v-x*x;if(!T)return!f&&u;var S=t*v/T,E=-t*x/T,R=Un(m,p),A=tn(m,S),C=tn(p,E);xr(A,C);var k=R,I=Zi(A,k),b=Zi(k,k),$=I*I-b*(Zi(A,A)-1);if(!($<0)){var F=Re($),M=tn(k,(-I-F)/b);if(xr(M,A),M=us(M),!f)return M;var w=u[0],O=h[0],V=u[1],q=h[1],N;O<w&&(N=w,w=O,O=N);var U=O-w,X=ht(U-J)<it,W=X||U<it;if(!X&&q<V&&(N=V,V=q,q=N),W?X?V+q>0^M[1]<(ht(M[0]-w)<it?V:q):V<=M[1]&&M[1]<=q:U>J^(w<=M[0]&&M[0]<=O)){var j=tn(k,(-I+F)/b);return xr(j,A),[M,us(j)]}}}function c(u,h){var f=i?n:J-n,d=0;return u<-f?d|=1:u>f&&(d|=2),h<-f?d|=4:h>f&&(d|=8),d}return Dc(a,o,s,i?[0,-n]:[-J,n-J])}function Yg(n,t,e,i,r,s){var a=n[0],o=n[1],l=t[0],c=t[1],u=0,h=1,f=l-a,d=c-o,g;if(g=e-a,!(!f&&g>0)){if(g/=f,f<0){if(g<u)return;g<h&&(h=g)}else if(f>0){if(g>h)return;g>u&&(u=g)}if(g=r-a,!(!f&&g<0)){if(g/=f,f<0){if(g>h)return;g>u&&(u=g)}else if(f>0){if(g<u)return;g<h&&(h=g)}if(g=i-o,!(!d&&g>0)){if(g/=d,d<0){if(g<u)return;g<h&&(h=g)}else if(d>0){if(g>h)return;g>u&&(u=g)}if(g=s-o,!(!d&&g<0)){if(g/=d,d<0){if(g>h)return;g>u&&(u=g)}else if(d>0){if(g<u)return;g<h&&(h=g)}return u>0&&(n[0]=a+u*f,n[1]=o+u*d),h<1&&(t[0]=a+h*f,t[1]=o+h*d),!0}}}}}var Li=1e9,nn=-Li;function Wg(n,t,e,i){function r(c,u){return n<=c&&c<=e&&t<=u&&u<=i}function s(c,u,h,f){var d=0,g=0;if(c==null||(d=a(c,h))!==(g=a(u,h))||l(c,u)<0^h>0)do f.point(d===0||d===3?n:e,d>1?i:t);while((d=(d+h+4)%4)!==g);else f.point(u[0],u[1])}function a(c,u){return ht(c[0]-n)<it?u>0?0:3:ht(c[0]-e)<it?u>0?2:1:ht(c[1]-t)<it?u>0?1:0:u>0?3:2}function o(c,u){return l(c.x,u.x)}function l(c,u){var h=a(c,1),f=a(u,1);return h!==f?h-f:h===0?u[1]-c[1]:h===1?c[0]-u[0]:h===2?c[1]-u[1]:u[0]-c[0]}return function(c){var u=c,h=bc(),f,d,g,m,p,v,x,T,S,E,R,A={point:C,lineStart:$,lineEnd:F,polygonStart:I,polygonEnd:b};function C(w,O){r(w,O)&&u.point(w,O)}function k(){for(var w=0,O=0,V=d.length;O<V;++O)for(var q=d[O],N=1,U=q.length,X=q[0],W,j,st=X[0],at=X[1];N<U;++N)W=st,j=at,X=q[N],st=X[0],at=X[1],j<=i?at>i&&(st-W)*(i-j)>(at-j)*(n-W)&&++w:at<=i&&(st-W)*(i-j)<(at-j)*(n-W)&&--w;return w}function I(){u=h,f=[],d=[],R=!0}function b(){var w=k(),O=R&&w,V=(f=tc(f)).length;(O||V)&&(c.polygonStart(),O&&(c.lineStart(),s(null,null,1,c),c.lineEnd()),V&&wc(f,o,w,s,c),c.polygonEnd()),u=c,f=d=g=null}function $(){A.point=M,d&&d.push(g=[]),E=!0,S=!1,x=T=NaN}function F(){f&&(M(m,p),v&&S&&h.rejoin(),f.push(h.result())),A.point=C,S&&u.lineEnd()}function M(w,O){var V=r(w,O);if(d&&g.push([w,O]),E)m=w,p=O,v=V,E=!1,V&&(u.lineStart(),u.point(w,O));else if(V&&S)u.point(w,O);else{var q=[x=Math.max(nn,Math.min(Li,x)),T=Math.max(nn,Math.min(Li,T))],N=[w=Math.max(nn,Math.min(Li,w)),O=Math.max(nn,Math.min(Li,O))];Yg(q,N,n,t,e,i)?(S||(u.lineStart(),u.point(q[0],q[1])),u.point(N[0],N[1]),V||u.lineEnd(),R=!1):V&&(u.lineStart(),u.point(w,O),R=!1)}x=w,T=O,S=V}return A}}const gs=n=>n;var Sr=new Pe,ms=new Pe,Cc,kc,ps,ys,ge={point:kt,lineStart:kt,lineEnd:kt,polygonStart:function(){ge.lineStart=qg,ge.lineEnd=Xg},polygonEnd:function(){ge.lineStart=ge.lineEnd=ge.point=kt,Sr.add(ht(ms)),ms=new Pe},result:function(){var n=Sr/2;return Sr=new Pe,n}};function qg(){ge.point=zg}function zg(n,t){ge.point=Pc,Cc=ps=n,kc=ys=t}function Pc(n,t){ms.add(ys*n-ps*t),ps=n,ys=t}function Xg(){Pc(Cc,kc)}var oi=1/0,Bn=oi,Ui=-oi,$n=Ui,Gn={point:jg,lineStart:kt,lineEnd:kt,polygonStart:kt,polygonEnd:kt,result:function(){var n=[[oi,Bn],[Ui,$n]];return Ui=$n=-(Bn=oi=1/0),n}};function jg(n,t){n<oi&&(oi=n),n>Ui&&(Ui=n),t<Bn&&(Bn=t),t>$n&&($n=t)}var vs=0,Es=0,Ri=0,Kn=0,Hn=0,Xe=0,xs=0,Ts=0,_i=0,Fc,Oc,zt,Xt,Dt={point:Me,lineStart:fo,lineEnd:go,polygonStart:function(){Dt.lineStart=Zg,Dt.lineEnd=tm},polygonEnd:function(){Dt.point=Me,Dt.lineStart=fo,Dt.lineEnd=go},result:function(){var n=_i?[xs/_i,Ts/_i]:Xe?[Kn/Xe,Hn/Xe]:Ri?[vs/Ri,Es/Ri]:[NaN,NaN];return vs=Es=Ri=Kn=Hn=Xe=xs=Ts=_i=0,n}};function Me(n,t){vs+=n,Es+=t,++Ri}function fo(){Dt.point=Qg}function Qg(n,t){Dt.point=Jg,Me(zt=n,Xt=t)}function Jg(n,t){var e=n-zt,i=t-Xt,r=Re(e*e+i*i);Kn+=r*(zt+n)/2,Hn+=r*(Xt+t)/2,Xe+=r,Me(zt=n,Xt=t)}function go(){Dt.point=Me}function Zg(){Dt.point=em}function tm(){Mc(Fc,Oc)}function em(n,t){Dt.point=Mc,Me(Fc=zt=n,Oc=Xt=t)}function Mc(n,t){var e=n-zt,i=t-Xt,r=Re(e*e+i*i);Kn+=r*(zt+n)/2,Hn+=r*(Xt+t)/2,Xe+=r,r=Xt*n-zt*t,xs+=r*(zt+n),Ts+=r*(Xt+t),_i+=r*3,Me(zt=n,Xt=t)}function Nc(n){this._context=n}Nc.prototype={_radius:4.5,pointRadius:function(n){return this._radius=n,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){this._line===0&&this._context.closePath(),this._point=NaN},point:function(n,t){switch(this._point){case 0:{this._context.moveTo(n,t),this._point=1;break}case 1:{this._context.lineTo(n,t);break}default:{this._context.moveTo(n+this._radius,t),this._context.arc(n,t,this._radius,0,Pt);break}}},result:kt};var Ss=new Pe,Ar,Uc,Bc,Ii,bi,Bi={point:kt,lineStart:function(){Bi.point=im},lineEnd:function(){Ar&&$c(Uc,Bc),Bi.point=kt},polygonStart:function(){Ar=!0},polygonEnd:function(){Ar=null},result:function(){var n=+Ss;return Ss=new Pe,n}};function im(n,t){Bi.point=$c,Uc=Ii=n,Bc=bi=t}function $c(n,t){Ii-=n,bi-=t,Ss.add(Re(Ii*Ii+bi*bi)),Ii=n,bi=t}let mo,Vn,po,yo;class vo{constructor(t){this._append=t==null?Gc:nm(t),this._radius=4.5,this._=""}pointRadius(t){return this._radius=+t,this}polygonStart(){this._line=0}polygonEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){this._line===0&&(this._+="Z"),this._point=NaN}point(t,e){switch(this._point){case 0:{this._append`M${t},${e}`,this._point=1;break}case 1:{this._append`L${t},${e}`;break}default:{if(this._append`M${t},${e}`,this._radius!==po||this._append!==Vn){const i=this._radius,r=this._;this._="",this._append`m0,${i}a${i},${i} 0 1,1 0,${-2*i}a${i},${i} 0 1,1 0,${2*i}z`,po=i,Vn=this._append,yo=this._,this._=r}this._+=yo;break}}}result(){const t=this._;return this._="",t.length?t:null}}function Gc(n){let t=1;this._+=n[0];for(const e=n.length;t<e;++t)this._+=arguments[t]+n[t]}function nm(n){const t=Math.floor(n);if(!(t>=0))throw new RangeError(`invalid digits: ${n}`);if(t>15)return Gc;if(t!==mo){const e=10**t;mo=t,Vn=function(r){let s=1;this._+=r[0];for(const a=r.length;s<a;++s)this._+=Math.round(arguments[s]*e)/e+r[s]}}return Vn}function rm(n,t){let e=3,i=4.5,r,s;function a(o){return o&&(typeof i=="function"&&s.pointRadius(+i.apply(this,arguments)),qe(o,r(s))),s.result()}return a.area=function(o){return qe(o,r(ge)),ge.result()},a.measure=function(o){return qe(o,r(Bi)),Bi.result()},a.bounds=function(o){return qe(o,r(Gn)),Gn.result()},a.centroid=function(o){return qe(o,r(Dt)),Dt.result()},a.projection=function(o){return arguments.length?(r=o==null?(n=null,gs):(n=o).stream,a):n},a.context=function(o){return arguments.length?(s=o==null?(t=null,new vo(e)):new Nc(t=o),typeof i!="function"&&s.pointRadius(i),a):t},a.pointRadius=function(o){return arguments.length?(i=typeof o=="function"?o:(s.pointRadius(+o),+o),a):i},a.digits=function(o){if(!arguments.length)return e;if(o==null)e=null;else{const l=Math.floor(o);if(!(l>=0))throw new RangeError(`invalid digits: ${o}`);e=l}return t===null&&(s=new vo(e)),a},a.projection(n).digits(e).context(t)}function ea(n){return function(t){var e=new As;for(var i in n)e[i]=n[i];return e.stream=t,e}}function As(){}As.prototype={constructor:As,point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function ia(n,t,e){var i=n.clipExtent&&n.clipExtent();return n.scale(150).translate([0,0]),i!=null&&n.clipExtent(null),qe(e,n.stream(Gn)),t(Gn.result()),i!=null&&n.clipExtent(i),n}function Kc(n,t,e){return ia(n,function(i){var r=t[1][0]-t[0][0],s=t[1][1]-t[0][1],a=Math.min(r/(i[1][0]-i[0][0]),s/(i[1][1]-i[0][1])),o=+t[0][0]+(r-a*(i[1][0]+i[0][0]))/2,l=+t[0][1]+(s-a*(i[1][1]+i[0][1]))/2;n.scale(150*a).translate([o,l])},e)}function sm(n,t,e){return Kc(n,[[0,0],t],e)}function am(n,t,e){return ia(n,function(i){var r=+t,s=r/(i[1][0]-i[0][0]),a=(r-s*(i[1][0]+i[0][0]))/2,o=-s*i[0][1];n.scale(150*s).translate([a,o])},e)}function om(n,t,e){return ia(n,function(i){var r=+t,s=r/(i[1][1]-i[0][1]),a=-s*i[0][0],o=(r-s*(i[1][1]+i[0][1]))/2;n.scale(150*s).translate([a,o])},e)}var Eo=16,lm=ut(30*_t);function xo(n,t){return+t?um(n,t):cm(n)}function cm(n){return ea({point:function(t,e){t=n(t,e),this.stream.point(t[0],t[1])}})}function um(n,t){function e(i,r,s,a,o,l,c,u,h,f,d,g,m,p){var v=c-i,x=u-r,T=v*v+x*x;if(T>4*t&&m--){var S=a+f,E=o+d,R=l+g,A=Re(S*S+E*E+R*R),C=Oe(R/=A),k=ht(ht(R)-1)<it||ht(s-h)<it?(s+h)/2:si(E,S),I=n(k,C),b=I[0],$=I[1],F=b-i,M=$-r,w=x*F-v*M;(w*w/T>t||ht((v*F+x*M)/T-.5)>.3||a*f+o*d+l*g<lm)&&(e(i,r,s,a,o,l,b,$,k,S/=A,E/=A,R,m,p),p.point(b,$),e(b,$,k,S,E,R,c,u,h,f,d,g,m,p))}}return function(i){var r,s,a,o,l,c,u,h,f,d,g,m,p={point:v,lineStart:x,lineEnd:S,polygonStart:function(){i.polygonStart(),p.lineStart=E},polygonEnd:function(){i.polygonEnd(),p.lineStart=x}};function v(C,k){C=n(C,k),i.point(C[0],C[1])}function x(){h=NaN,p.point=T,i.lineStart()}function T(C,k){var I=ai([C,k]),b=n(C,k);e(h,f,u,d,g,m,h=b[0],f=b[1],u=C,d=I[0],g=I[1],m=I[2],Eo,i),i.point(h,f)}function S(){p.point=v,i.lineEnd()}function E(){x(),p.point=R,p.lineEnd=A}function R(C,k){T(r=C,k),s=h,a=f,o=d,l=g,c=m,p.point=T}function A(){e(h,f,u,d,g,m,s,a,r,o,l,c,Eo,i),p.lineEnd=S,S()}return p}}var hm=ea({point:function(n,t){this.stream.point(n*_t,t*_t)}});function fm(n){return ea({point:function(t,e){var i=n(t,e);return this.stream.point(i[0],i[1])}})}function dm(n,t,e,i,r){function s(a,o){return a*=i,o*=r,[t+n*a,e-n*o]}return s.invert=function(a,o){return[(a-t)/n*i,(e-o)/n*r]},s}function To(n,t,e,i,r,s){if(!s)return dm(n,t,e,i,r);var a=ut(s),o=lt(s),l=a*n,c=o*n,u=a/n,h=o/n,f=(o*e-a*t)/n,d=(o*t+a*e)/n;function g(m,p){return m*=i,p*=r,[l*m-c*p+t,e-c*m-l*p]}return g.invert=function(m,p){return[i*(u*m-h*p+f),r*(d-h*m-u*p)]},g}function gm(n){return mm(function(){return n})()}function mm(n){var t,e=150,i=480,r=250,s=0,a=0,o=0,l=0,c=0,u,h=0,f=1,d=1,g=null,m=ho,p=null,v,x,T,S=gs,E=.5,R,A,C,k,I;function b(w){return C(w[0]*_t,w[1]*_t)}function $(w){return w=C.invert(w[0],w[1]),w&&[w[0]*ce,w[1]*ce]}b.stream=function(w){return k&&I===w?k:k=hm(fm(u)(m(R(S(I=w)))))},b.preclip=function(w){return arguments.length?(m=w,g=void 0,M()):m},b.postclip=function(w){return arguments.length?(S=w,p=v=x=T=null,M()):S},b.clipAngle=function(w){return arguments.length?(m=+w?Vg(g=w*_t):(g=null,ho),M()):g*ce},b.clipExtent=function(w){return arguments.length?(S=w==null?(p=v=x=T=null,gs):Wg(p=+w[0][0],v=+w[0][1],x=+w[1][0],T=+w[1][1]),M()):p==null?null:[[p,v],[x,T]]},b.scale=function(w){return arguments.length?(e=+w,F()):e},b.translate=function(w){return arguments.length?(i=+w[0],r=+w[1],F()):[i,r]},b.center=function(w){return arguments.length?(s=w[0]%360*_t,a=w[1]%360*_t,F()):[s*ce,a*ce]},b.rotate=function(w){return arguments.length?(o=w[0]%360*_t,l=w[1]%360*_t,c=w.length>2?w[2]%360*_t:0,F()):[o*ce,l*ce,c*ce]},b.angle=function(w){return arguments.length?(h=w%360*_t,F()):h*ce},b.reflectX=function(w){return arguments.length?(f=w?-1:1,F()):f<0},b.reflectY=function(w){return arguments.length?(d=w?-1:1,F()):d<0},b.precision=function(w){return arguments.length?(R=xo(A,E=w*w),M()):Re(E)},b.fitExtent=function(w,O){return Kc(b,w,O)},b.fitSize=function(w,O){return sm(b,w,O)},b.fitWidth=function(w,O){return am(b,w,O)},b.fitHeight=function(w,O){return om(b,w,O)};function F(){var w=To(e,0,0,f,d,h).apply(null,t(s,a)),O=To(e,i-w[0],r-w[1],f,d,h);return u=Mg(o,l,c),A=fs(t,O),C=fs(u,A),R=xo(A,E),M()}function M(){return k=I=null,b}return function(){return t=n.apply(this,arguments),b.invert=t.invert&&$,F()}}function pm(n){return function(t,e){var i=Re(t*t+e*e),r=n(i),s=lt(r),a=ut(r);return[si(t*s,i*a),Oe(i&&e*s/i)]}}function Hc(n,t){return[ut(t)*lt(n),lt(t)]}Hc.invert=pm(Oe);function ym(){return gm(Hc).scale(249.5).clipAngle(90+it)}function je(n,t,e){this.k=n,this.x=t,this.y=e}je.prototype={constructor:je,scale:function(n){return n===1?this:new je(this.k*n,this.x,this.y)},translate:function(n,t){return n===0&t===0?this:new je(this.k,this.x+this.k*n,this.y+this.k*t)},apply:function(n){return[n[0]*this.k+this.x,n[1]*this.k+this.y]},applyX:function(n){return n*this.k+this.x},applyY:function(n){return n*this.k+this.y},invert:function(n){return[(n[0]-this.x)/this.k,(n[1]-this.y)/this.k]},invertX:function(n){return(n-this.x)/this.k},invertY:function(n){return(n-this.y)/this.k},rescaleX:function(n){return n.copy().domain(n.range().map(this.invertX,this).map(n.invert,n))},rescaleY:function(n){return n.copy().domain(n.range().map(this.invertY,this).map(n.invert,n))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Lr=new je(1,0,0);je.prototype;function vm(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Vc={exports:{}};(function(n,t){(function(e){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var h=o.parseURL(l);if(!h)throw new Error("Error trying to parse base URL.");return h.path=o.normalizePath(h.path),o.buildURLFromParts(h)}var f=o.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=o.normalizePath(f.path),o.buildURLFromParts(f)):c;var d=o.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var g=r.exec(d.path);d.netLoc=g[1],d.path=g[2]}d.netLoc&&!d.path&&(d.path="/");var m={scheme:d.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(m.netLoc=d.netLoc,f.path[0]!=="/"))if(!f.path)m.path=d.path,f.params||(m.params=d.params,f.query||(m.query=d.query));else{var p=d.path,v=p.substring(0,p.lastIndexOf("/")+1)+f.path;m.path=o.normalizePath(v)}return m.path===null&&(m.path=u.alwaysNormalize?o.normalizePath(f.path):f.path),o.buildURLFromParts(m)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(s,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};n.exports=o})()})(Vc);var na=Vc.exports;function So(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function pt(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?So(Object(e),!0).forEach(function(i){Tm(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):So(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function Em(n,t){if(typeof n!="object"||!n)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var i=e.call(n,t||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(n)}function xm(n){var t=Em(n,"string");return typeof t=="symbol"?t:String(t)}function Tm(n,t,e){return t=xm(t),t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}function ft(){return ft=Object.assign?Object.assign.bind():function(n){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i])}return n},ft.apply(this,arguments)}const B=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},Sm=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=Am},Am=Number.MAX_SAFE_INTEGER||9007199254740991;let y=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n}({}),Y=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),D=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.UNKNOWN="unknown",n}({});const Ie=function(){},Ls={trace:Ie,debug:Ie,log:Ie,warn:Ie,info:Ie,error:Ie};let Ci=Ls;function Lm(n){const t=self.console[n];return t?t.bind(self.console,`[${n}] >`):Ie}function Rm(n,...t){t.forEach(function(e){Ci[e]=n[e]?n[e].bind(n):Lm(e)})}function _m(n,t){if(typeof console=="object"&&n===!0||typeof n=="object"){Rm(n,"debug","log","info","warn","error");try{Ci.log(`Debug logs enabled for "${t}" in hls.js version 1.5.17`)}catch{Ci=Ls}}else Ci=Ls}const L=Ci,Im=/^(\d+)x(\d+)$/,Ao=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ct{constructor(t){typeof t=="string"&&(t=ct.parseAttrList(t)),ft(this,t)}get clientAttrs(){return Object.keys(this).filter(t=>t.substring(0,2)==="X-")}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(e.length&1?"0":"")+e;const i=new Uint8Array(e.length/2);for(let r=0;r<e.length/2;r++)i[r]=parseInt(e.slice(r*2,r*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}bool(t){return this[t]==="YES"}decimalResolution(t){const e=Im.exec(this[t]);if(e!==null)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;const i={},r='"';for(Ao.lastIndex=0;(e=Ao.exec(t))!==null;){let s=e[2];s.indexOf(r)===0&&s.lastIndexOf(r)===s.length-1&&(s=s.slice(1,-1));const a=e[1].trim();i[a]=s}return i}}function bm(n){return n!=="ID"&&n!=="CLASS"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function wm(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"}class Yc{constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){const i=e.attr;for(const r in i)if(Object.prototype.hasOwnProperty.call(t,r)&&t[r]!==i[r]){L.warn(`DATERANGE tag attribute: "${r}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=r;break}t=ft(new ct({}),i,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);B(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const t=this.duration;return t!==null?new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if(B(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&B(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class fr{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var tt={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Wc{constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[tt.AUDIO]:null,[tt.VIDEO]:null,[tt.AUDIOVIDEO]:null},this.baseurl=t}setByteRange(t,e){const i=t.split("@",2);let r;i.length===1?r=(e==null?void 0:e.byteRangeEndOffset)||0:r=parseInt(i[1]),this._byteRange=[r,parseInt(i[0])+r]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=na.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}}class Rr extends Wc{constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new fr,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get decryptdata(){const{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!B(this.programDateTime))return null;const t=B(this.duration)?this.duration:0;return this.programDateTime+t*1e3}get encrypted(){var t;if((t=this._decryptdata)!=null&&t.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),i=e.length;if(i>1||i===1&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){const e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;(t=this.loader)==null||t.abort(),(e=this.keyLoader)==null||e.abort()}setElementaryStreamInfo(t,e,i,r,s,a=!1){const{elementaryStreams:o}=this,l=o[t];if(!l){o[t]={startPTS:e,endPTS:i,startDTS:r,endDTS:s,partial:a};return}l.startPTS=Math.min(l.startPTS,e),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,r),l.endDTS=Math.max(l.endDTS,s)}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[tt.AUDIO]=null,t[tt.VIDEO]=null,t[tt.AUDIOVIDEO]=null}}class Dm extends Wc{constructor(t,e,i,r,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new fr,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=r;const a=t.enumeratedString("BYTERANGE");a&&this.setByteRange(a,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}const Cm=10;class km{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}const e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||e===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(t.misses*.6):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?B(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Cm}get drift(){const t=this.driftEndTime-this.driftStartTime;return t>0?(this.driftEnd-this.driftStart)*1e3/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return(t=this.fragments)!=null&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function ra(n){return Uint8Array.from(atob(n),t=>t.charCodeAt(0))}function Pm(n){const t=Rs(n).subarray(0,16),e=new Uint8Array(16);return e.set(t,16-t.length),e}function Fm(n){const t=function(i,r,s){const a=i[r];i[r]=i[s],i[s]=a};t(n,0,3),t(n,1,2),t(n,4,5),t(n,6,7)}function Om(n){const t=n.split(":");let e=null;if(t[0]==="data"&&t.length===2){const i=t[1].split(";"),r=i[i.length-1].split(",");if(r.length===2){const s=r[0]==="base64",a=r[1];s?(i.splice(-1,1),e=ra(a)):e=Pm(a)}}return e}function Rs(n){return Uint8Array.from(unescape(encodeURIComponent(n)),t=>t.charCodeAt(0))}const li=typeof self<"u"?self:void 0;var rt={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},At={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Lo(n){switch(n){case At.FAIRPLAY:return rt.FAIRPLAY;case At.PLAYREADY:return rt.PLAYREADY;case At.WIDEVINE:return rt.WIDEVINE;case At.CLEARKEY:return rt.CLEARKEY}}var wi={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",FAIRPLAY:"94ce86fb07ff4f43adb893d2fa968ca2",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Ro(n){if(n===wi.WIDEVINE)return rt.WIDEVINE;if(n===wi.PLAYREADY)return rt.PLAYREADY;if(n===wi.CENC||n===wi.CLEARKEY)return rt.CLEARKEY}function _o(n){switch(n){case rt.FAIRPLAY:return At.FAIRPLAY;case rt.PLAYREADY:return At.PLAYREADY;case rt.WIDEVINE:return At.WIDEVINE;case rt.CLEARKEY:return At.CLEARKEY}}function _r(n){const{drmSystems:t,widevineLicenseUrl:e}=n,i=t?[rt.FAIRPLAY,rt.WIDEVINE,rt.PLAYREADY,rt.CLEARKEY].filter(r=>!!t[r]):[];return!i[rt.WIDEVINE]&&e&&i.push(rt.WIDEVINE),i}const qc=function(n){return li!=null&&(n=li.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Mm(n,t,e,i){let r;switch(n){case rt.FAIRPLAY:r=["cenc","sinf"];break;case rt.WIDEVINE:case rt.PLAYREADY:r=["cenc"];break;case rt.CLEARKEY:r=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return Nm(r,t,e,i)}function Nm(n,t,e,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:t.map(s=>({contentType:`audio/mp4; codecs="${s}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:e.map(s=>({contentType:`video/mp4; codecs="${s}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function ke(n,t,e){return Uint8Array.prototype.slice?n.slice(t,e):new Uint8Array(Array.prototype.slice.call(n,t,e))}const sa=(n,t)=>t+10<=n.length&&n[t]===73&&n[t+1]===68&&n[t+2]===51&&n[t+3]<255&&n[t+4]<255&&n[t+6]<128&&n[t+7]<128&&n[t+8]<128&&n[t+9]<128,zc=(n,t)=>t+10<=n.length&&n[t]===51&&n[t+1]===68&&n[t+2]===73&&n[t+3]<255&&n[t+4]<255&&n[t+6]<128&&n[t+7]<128&&n[t+8]<128&&n[t+9]<128,$i=(n,t)=>{const e=t;let i=0;for(;sa(n,t);){i+=10;const r=dr(n,t+6);i+=r,zc(n,t+10)&&(i+=10),t+=i}if(i>0)return n.subarray(e,e+i)},dr=(n,t)=>{let e=0;return e=(n[t]&127)<<21,e|=(n[t+1]&127)<<14,e|=(n[t+2]&127)<<7,e|=n[t+3]&127,e},Um=(n,t)=>sa(n,t)&&dr(n,t+6)+10<=n.length-t,aa=n=>{const t=jc(n);for(let e=0;e<t.length;e++){const i=t[e];if(Xc(i))return Vm(i)}},Xc=n=>n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp",Bm=n=>{const t=String.fromCharCode(n[0],n[1],n[2],n[3]),e=dr(n,4),i=10;return{type:t,size:e,data:n.subarray(i,i+e)}},jc=n=>{let t=0;const e=[];for(;sa(n,t);){const i=dr(n,t+6);t+=10;const r=t+i;for(;t+8<r;){const s=Bm(n.subarray(t)),a=$m(s);a&&e.push(a),t+=s.size+10}zc(n,t)&&(t+=10)}return e},$m=n=>n.type==="PRIV"?Gm(n):n.type[0]==="W"?Hm(n):Km(n),Gm=n=>{if(n.size<2)return;const t=ie(n.data,!0),e=new Uint8Array(n.data.subarray(t.length+1));return{key:n.type,info:t,data:e.buffer}},Km=n=>{if(n.size<2)return;if(n.type==="TXXX"){let e=1;const i=ie(n.data.subarray(e),!0);e+=i.length+1;const r=ie(n.data.subarray(e));return{key:n.type,info:i,data:r}}const t=ie(n.data.subarray(1));return{key:n.type,data:t}},Hm=n=>{if(n.type==="WXXX"){if(n.size<2)return;let e=1;const i=ie(n.data.subarray(e),!0);e+=i.length+1;const r=ie(n.data.subarray(e));return{key:n.type,info:i,data:r}}const t=ie(n.data);return{key:n.type,data:t}},Vm=n=>{if(n.data.byteLength===8){const t=new Uint8Array(n.data),e=t[3]&1;let i=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return i/=45,e&&(i+=4772185884e-2),Math.round(i)}},ie=(n,t=!1)=>{const e=Ym();if(e){const c=e.decode(n);if(t){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const i=n.length;let r,s,a,o="",l=0;for(;l<i;){if(r=n[l++],r===0&&t)return o;if(r===0||r===3)continue;switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(r);break;case 12:case 13:s=n[l++],o+=String.fromCharCode((r&31)<<6|s&63);break;case 14:s=n[l++],a=n[l++],o+=String.fromCharCode((r&15)<<12|(s&63)<<6|(a&63)<<0);break}}return o};let Ir;function Ym(){if(!navigator.userAgent.includes("PlayStation 4"))return!Ir&&typeof self.TextDecoder<"u"&&(Ir=new self.TextDecoder("utf-8")),Ir}const Wt={hexDump:function(n){let t="";for(let e=0;e<n.length;e++){let i=n[e].toString(16);i.length<2&&(i="0"+i),t+=i}return t}},Yn=Math.pow(2,32)-1,Wm=[].push,Qc={video:1,audio:2,id3:3,text:4};function dt(n){return String.fromCharCode.apply(null,n)}function Jc(n,t){const e=n[t]<<8|n[t+1];return e<0?65536+e:e}function K(n,t){const e=Zc(n,t);return e<0?4294967296+e:e}function Io(n,t){let e=K(n,t);return e*=Math.pow(2,32),e+=K(n,t+4),e}function Zc(n,t){return n[t]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3]}function br(n,t,e){n[t]=e>>24,n[t+1]=e>>16&255,n[t+2]=e>>8&255,n[t+3]=e&255}function qm(n){const t=n.byteLength;for(let e=0;e<t;){const i=K(n,e);if(i>8&&n[e+4]===109&&n[e+5]===111&&n[e+6]===111&&n[e+7]===102)return!0;e=i>1?e+i:t}return!1}function z(n,t){const e=[];if(!t.length)return e;const i=n.byteLength;for(let r=0;r<i;){const s=K(n,r),a=dt(n.subarray(r+4,r+8)),o=s>1?r+s:i;if(a===t[0])if(t.length===1)e.push(n.subarray(r+8,o));else{const l=z(n.subarray(r+8,o),t.slice(1));l.length&&Wm.apply(e,l)}r=o}return e}function zm(n){const t=[],e=n[0];let i=8;const r=K(n,i);i+=4;let s=0,a=0;e===0?(s=K(n,i),a=K(n,i+4),i+=8):(s=Io(n,i),a=Io(n,i+8),i+=16),i+=2;let o=n.length+a;const l=Jc(n,i);i+=2;for(let c=0;c<l;c++){let u=i;const h=K(n,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return L.warn("SIDX has hierarchical references (not supported)"),null;const g=K(n,u);u+=4,t.push({referenceSize:f,subsegmentDuration:g,info:{duration:g/r,start:o,end:o+f-1}}),o+=f,u+=4,i=u}return{earliestPresentationTime:s,timescale:r,version:e,referencesCount:l,references:t}}function tu(n){const t=[],e=z(n,["moov","trak"]);for(let r=0;r<e.length;r++){const s=e[r],a=z(s,["tkhd"])[0];if(a){let o=a[0];const l=K(a,o===0?12:20),c=z(s,["mdia","mdhd"])[0];if(c){o=c[0];const u=K(c,o===0?12:20),h=z(s,["mdia","hdlr"])[0];if(h){const f=dt(h.subarray(8,12)),d={soun:tt.AUDIO,vide:tt.VIDEO}[f];if(d){const g=z(s,["mdia","minf","stbl","stsd"])[0],m=Xm(g);t[l]={timescale:u,type:d},t[d]=pt({timescale:u,id:l},m)}}}}}return z(n,["moov","mvex","trex"]).forEach(r=>{const s=K(r,4),a=t[s];a&&(a.default={duration:K(r,12),flags:K(r,20)})}),t}function Xm(n){const t=n.subarray(8),e=t.subarray(86),i=dt(t.subarray(4,8));let r=i;const s=i==="enca"||i==="encv";if(s){const o=z(t,[i])[0].subarray(i==="enca"?28:78);z(o,["sinf"]).forEach(c=>{const u=z(c,["schm"])[0];if(u){const h=dt(u.subarray(4,8));if(h==="cbcs"||h==="cenc"){const f=z(c,["frma"])[0];f&&(r=dt(f))}}})}switch(r){case"avc1":case"avc2":case"avc3":case"avc4":{const a=z(e,["avcC"])[0];r+="."+rn(a[1])+rn(a[2])+rn(a[3]);break}case"mp4a":{const a=z(t,[i])[0],o=z(a.subarray(28),["esds"])[0];if(o&&o.length>12){let l=4;if(o[l++]!==3)break;l=wr(o,l),l+=2;const c=o[l++];if(c&128&&(l+=2),c&64&&(l+=o[l++]),o[l++]!==4)break;l=wr(o,l);const u=o[l++];if(u===64)r+="."+rn(u);else break;if(l+=12,o[l++]!==5)break;l=wr(o,l);const h=o[l++];let f=(h&248)>>3;f===31&&(f+=1+((h&7)<<3)+((o[l]&224)>>5)),r+="."+f}break}case"hvc1":case"hev1":{const a=z(e,["hvcC"])[0],o=a[1],l=["","A","B","C"][o>>6],c=o&31,u=K(a,2),h=(o&32)>>5?"H":"L",f=a[12],d=a.subarray(6,12);r+="."+l+c,r+="."+u.toString(16).toUpperCase(),r+="."+h+f;let g="";for(let m=d.length;m--;){const p=d[m];(p||g)&&(g="."+p.toString(16).toUpperCase()+g)}r+=g;break}case"dvh1":case"dvhe":{const a=z(e,["dvcC"])[0],o=a[2]>>1&127,l=a[2]<<5&32|a[3]>>3&31;r+="."+Yt(o)+"."+Yt(l);break}case"vp09":{const a=z(e,["vpcC"])[0],o=a[4],l=a[5],c=a[6]>>4&15;r+="."+Yt(o)+"."+Yt(l)+"."+Yt(c);break}case"av01":{const a=z(e,["av1C"])[0],o=a[1]>>>5,l=a[1]&31,c=a[2]>>>7?"H":"M",u=(a[2]&64)>>6,h=(a[2]&32)>>5,f=o===2&&u?h?12:10:u?10:8,d=(a[2]&16)>>4,g=(a[2]&8)>>3,m=(a[2]&4)>>2,p=a[2]&3;r+="."+o+"."+Yt(l)+c+"."+Yt(f)+"."+d+"."+g+m+p+"."+Yt(1)+"."+Yt(1)+"."+Yt(1)+"."+0;break}}return{codec:r,encrypted:s}}function wr(n,t){const e=t+5;for(;n[t++]&128&&t<e;);return t}function rn(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Yt(n){return(n<10?"0":"")+n}function jm(n,t){if(!n||!t)return n;const e=t.keyId;return e&&t.isCommonEncryption&&z(n,["moov","trak"]).forEach(r=>{const a=z(r,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=z(a,["enca"]);const l=o.length>0;l||(o=z(a,["encv"])),o.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);z(u,["sinf"]).forEach(f=>{const d=eu(f);if(d){const g=d.subarray(8,24);g.some(m=>m!==0)||(L.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${Wt.hexDump(g)} -> ${Wt.hexDump(e)}`),d.set(e,8))}})})}),n}function eu(n){const t=z(n,["schm"])[0];if(t){const e=dt(t.subarray(4,8));if(e==="cbcs"||e==="cenc")return z(n,["schi","tenc"])[0]}return null}function Qm(n,t){return z(t,["moof","traf"]).reduce((e,i)=>{const r=z(i,["tfdt"])[0],s=r[0],a=z(i,["tfhd"]).reduce((o,l)=>{const c=K(l,4),u=n[c];if(u){let h=K(r,4);if(s===1){if(h===Yn)return L.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;h*=Yn+1,h+=K(r,8)}const f=u.timescale||9e4,d=h/f;if(B(d)&&(o===null||d<o))return d}return o},null);return a!==null&&B(a)&&(e===null||a<e)?a:e},null)}function Jm(n,t){let e=0,i=0,r=0;const s=z(n,["moof","traf"]);for(let a=0;a<s.length;a++){const o=s[a],l=z(o,["tfhd"])[0],c=K(l,4),u=t[c];if(!u)continue;const h=u.default,f=K(l,0)|(h==null?void 0:h.flags);let d=h==null?void 0:h.duration;f&8&&(f&2?d=K(l,12):d=K(l,8));const g=u.timescale||9e4,m=z(o,["trun"]);for(let p=0;p<m.length;p++){if(e=Zm(m[p]),!e&&d){const v=K(m[p],4);e=d*v}u.type===tt.VIDEO?i+=e/g:u.type===tt.AUDIO&&(r+=e/g)}}if(i===0&&r===0){let a=1/0,o=0,l=0;const c=z(n,["sidx"]);for(let u=0;u<c.length;u++){const h=zm(c[u]);if(h!=null&&h.references){a=Math.min(a,h.earliestPresentationTime/h.timescale);const f=h.references.reduce((d,g)=>d+g.info.duration||0,0);o=Math.max(o,f+h.earliestPresentationTime/h.timescale),l=o-a}}if(l&&B(l))return l}return i||r}function Zm(n){const t=K(n,0);let e=8;t&1&&(e+=4),t&4&&(e+=4);let i=0;const r=K(n,4);for(let s=0;s<r;s++){if(t&256){const a=K(n,e);i+=a,e+=4}t&512&&(e+=4),t&1024&&(e+=4),t&2048&&(e+=4)}return i}function tp(n,t,e){z(t,["moof","traf"]).forEach(i=>{z(i,["tfhd"]).forEach(r=>{const s=K(r,4),a=n[s];if(!a)return;const o=a.timescale||9e4;z(i,["tfdt"]).forEach(l=>{const c=l[0],u=e*o;if(u){let h=K(l,4);if(c===0)h-=u,h=Math.max(h,0),br(l,4,h);else{h*=Math.pow(2,32),h+=K(l,8),h-=u,h=Math.max(h,0);const f=Math.floor(h/(Yn+1)),d=Math.floor(h%(Yn+1));br(l,4,f),br(l,8,d)}}})})})}function ep(n){const t={valid:null,remainder:null},e=z(n,["moof"]);if(e.length<2)return t.remainder=n,t;const i=e[e.length-1];return t.valid=ke(n,0,i.byteOffset-8),t.remainder=ke(n,i.byteOffset-8),t}function Ft(n,t){const e=new Uint8Array(n.length+t.length);return e.set(n),e.set(t,n.length),e}function bo(n,t){const e=[],i=t.samples,r=t.timescale,s=t.id;let a=!1;return z(i,["moof"]).map(l=>{const c=l.byteOffset-8;z(l,["traf"]).map(h=>{const f=z(h,["tfdt"]).map(d=>{const g=d[0];let m=K(d,4);return g===1&&(m*=Math.pow(2,32),m+=K(d,8)),m/r})[0];return f!==void 0&&(n=f),z(h,["tfhd"]).map(d=>{const g=K(d,4),m=K(d,0)&16777215,p=(m&1)!==0,v=(m&2)!==0,x=(m&8)!==0;let T=0;const S=(m&16)!==0;let E=0;const R=(m&32)!==0;let A=8;g===s&&(p&&(A+=8),v&&(A+=4),x&&(T=K(d,A),A+=4),S&&(E=K(d,A),A+=4),R&&(A+=4),t.type==="video"&&(a=ip(t.codec)),z(h,["trun"]).map(C=>{const k=C[0],I=K(C,0)&16777215,b=(I&1)!==0;let $=0;const F=(I&4)!==0,M=(I&256)!==0;let w=0;const O=(I&512)!==0;let V=0;const q=(I&1024)!==0,N=(I&2048)!==0;let U=0;const X=K(C,4);let W=8;b&&($=K(C,W),W+=4),F&&(W+=4);let j=$+c;for(let st=0;st<X;st++){if(M?(w=K(C,W),W+=4):w=T,O?(V=K(C,W),W+=4):V=E,q&&(W+=4),N&&(k===0?U=K(C,W):U=Zc(C,W),W+=4),t.type===tt.VIDEO){let at=0;for(;at<V;){const yt=K(i,j);if(j+=4,np(a,i[j])){const It=i.subarray(j,j+yt);iu(It,a?2:1,n+U/r,e)}j+=yt,at+=yt+4}}n+=w/r}}))})})}),e}function ip(n){if(!n)return!1;const t=n.indexOf("."),e=t<0?n:n.substring(0,t);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function np(n,t){if(n){const e=t>>1&63;return e===39||e===40}else return(t&31)===6}function iu(n,t,e,i){const r=nu(n);let s=0;s+=t;let a=0,o=0,l=0;for(;s<r.length;){a=0;do{if(s>=r.length)break;l=r[s++],a+=l}while(l===255);o=0;do{if(s>=r.length)break;l=r[s++],o+=l}while(l===255);const c=r.length-s;let u=s;if(o<c)s+=o;else if(o>c){L.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(r[u++]===181){const f=Jc(r,u);if(u+=2,f===49){const d=K(r,u);if(u+=4,d===1195456820){const g=r[u++];if(g===3){const m=r[u++],p=31&m,v=64&m,x=v?2+p*3:0,T=new Uint8Array(x);if(v){T[0]=m;for(let S=1;S<x;S++)T[S]=r[u++]}i.push({type:g,payloadType:a,pts:e,bytes:T})}}}}}else if(a===5&&o>16){const h=[];for(let g=0;g<16;g++){const m=r[u++].toString(16);h.push(m.length==1?"0"+m:m),(g===3||g===5||g===7||g===9)&&h.push("-")}const f=o-16,d=new Uint8Array(f);for(let g=0;g<f;g++)d[g]=r[u++];i.push({payloadType:a,pts:e,uuid:h.join(""),userData:ie(d),userDataBytes:d})}}}function nu(n){const t=n.byteLength,e=[];let i=1;for(;i<t-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(e.push(i+2),i+=2):i++;if(e.length===0)return n;const r=t-e.length,s=new Uint8Array(r);let a=0;for(i=0;i<r;a++,i++)a===e[0]&&(a++,e.shift()),s[i]=n[a];return s}function rp(n){const t=n[0];let e="",i="",r=0,s=0,a=0,o=0,l=0,c=0;if(t===0){for(;dt(n.subarray(c,c+1))!=="\0";)e+=dt(n.subarray(c,c+1)),c+=1;for(e+=dt(n.subarray(c,c+1)),c+=1;dt(n.subarray(c,c+1))!=="\0";)i+=dt(n.subarray(c,c+1)),c+=1;i+=dt(n.subarray(c,c+1)),c+=1,r=K(n,12),s=K(n,16),o=K(n,20),l=K(n,24),c=28}else if(t===1){c+=4,r=K(n,c),c+=4;const h=K(n,c);c+=4;const f=K(n,c);for(c+=4,a=2**32*h+f,Sm(a)||(a=Number.MAX_SAFE_INTEGER,L.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=K(n,c),c+=4,l=K(n,c),c+=4;dt(n.subarray(c,c+1))!=="\0";)e+=dt(n.subarray(c,c+1)),c+=1;for(e+=dt(n.subarray(c,c+1)),c+=1;dt(n.subarray(c,c+1))!=="\0";)i+=dt(n.subarray(c,c+1)),c+=1;i+=dt(n.subarray(c,c+1)),c+=1}const u=n.subarray(c,n.byteLength);return{schemeIdUri:e,value:i,timeScale:r,presentationTime:a,presentationTimeDelta:s,eventDuration:o,id:l,payload:u}}function sp(n,...t){const e=t.length;let i=8,r=e;for(;r--;)i+=t[r].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=i&255,s.set(n,4),r=0,i=8;r<e;r++)s.set(t[r],i),i+=t[r].byteLength;return s}function ap(n,t,e){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,r;i=0,r=new Uint8Array;let s;i>0?(s=new Uint8Array(4),t.length>0&&new DataView(s.buffer).setUint32(0,t.length,!1)):s=new Uint8Array;const a=new Uint8Array(4);return e&&e.byteLength>0&&new DataView(a.buffer).setUint32(0,e.byteLength,!1),sp([112,115,115,104],new Uint8Array([i,0,0,0]),n,s,r,a,e||new Uint8Array)}function op(n){const t=[];if(n instanceof ArrayBuffer){const e=n.byteLength;let i=0;for(;i+32<e;){const r=new DataView(n,i),s=lp(r);t.push(s),i+=s.size}}return t}function lp(n){const t=n.getUint32(0),e=n.byteOffset,i=n.byteLength;if(i<t)return{offset:e,size:i};if(n.getUint32(4)!==1886614376)return{offset:e,size:t};const s=n.getUint32(8)>>>24;if(s!==0&&s!==1)return{offset:e,size:t};const a=n.buffer,o=Wt.hexDump(new Uint8Array(a,e+12,16)),l=n.getUint32(28);let c=null,u=null;if(s===0){if(t-32<l||l<22)return{offset:e,size:t};u=new Uint8Array(a,e+32,l)}else if(s===1){if(!l||i<e+32+l*16+16)return{offset:e,size:t};c=[];for(let h=0;h<l;h++)c.push(new Uint8Array(a,e+32+h*16,16))}return{version:s,systemId:o,kids:c,data:u,offset:e,size:t}}let sn={};class Gi{static clearKeyUriToKeyIdMap(){sn={}}constructor(t,e,i,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=r,this.iv=s,this.encrypted=t?t!=="NONE":!1,this.isCommonEncryption=this.encrypted&&t!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case At.FAIRPLAY:case At.WIDEVINE:case At.PLAYREADY:case At.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof t!="number"&&(this.method==="AES-128"&&!this.iv&&L.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);const i=cp(t);return new Gi(this.method,this.uri,"identity",this.keyFormatVersions,i)}const e=Om(this.uri);if(e)switch(this.keyFormat){case At.WIDEVINE:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case At.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=ap(i,null,e);const r=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),s=String.fromCharCode.apply(null,Array.from(r)),a=s.substring(s.indexOf("<"),s.length),c=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("KID")[0];if(c){const u=c.childNodes[0]?c.childNodes[0].nodeValue:c.getAttribute("VALUE");if(u){const h=ra(u).subarray(0,16);Fm(h),this.keyId=h}}break}default:{let i=e.subarray(0,16);if(i.length!==16){const r=new Uint8Array(16);r.set(i,16-i.length),i=r}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=sn[this.uri];if(!i){const r=Object.keys(sn).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,r),sn[this.uri]=i}this.keyId=i}return this}}function cp(n){const t=new Uint8Array(16);for(let e=12;e<16;e++)t[e]=n>>8*(15-e)&255;return t}const ru=/\{\$([a-zA-Z0-9-_]+)\}/g;function wo(n){return ru.test(n)}function St(n,t,e){if(n.variableList!==null||n.hasVariableRefs)for(let i=e.length;i--;){const r=e[i],s=t[r];s&&(t[r]=_s(n,s))}}function _s(n,t){if(n.variableList!==null||n.hasVariableRefs){const e=n.variableList;return t.replace(ru,i=>{const r=i.substring(2,i.length-1),s=e==null?void 0:e[r];return s===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),i):s})}return t}function Do(n,t,e){let i=n.variableList;i||(n.variableList=i={});let r,s;if("QUERYPARAM"in t){r=t.QUERYPARAM;try{const a=new self.URL(e).searchParams;if(a.has(r))s=a.get(r);else throw new Error(`"${r}" does not match any query parameter in URI: "${e}"`)}catch(a){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${a.message}`))}}else r=t.NAME,s=t.VALUE;r in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):i[r]=s||""}function up(n,t,e){const i=t.IMPORT;if(e&&i in e){let r=n.variableList;r||(n.variableList=r={}),r[i]=e[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function Ne(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function hp(n){return typeof self<"u"&&n===self.ManagedMediaSource}const Wn={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function fp(n,t){const e=Wn[t];return!!e&&!!e[n.slice(0,4)]}function Dr(n,t,e=!0){return!n.split(",").some(i=>!su(i,t,e))}function su(n,t,e=!0){var i;const r=Ne(e);return(i=r==null?void 0:r.isTypeSupported(Ki(n,t)))!=null?i:!1}function Ki(n,t){return`${t}/mp4;codecs="${n}"`}function Co(n){if(n){const t=n.substring(0,4);return Wn.video[t]}return 2}function qn(n){return n.split(",").reduce((t,e)=>{const i=Wn.video[e];return i?(i*2+t)/(t?3:2):(Wn.audio[e]+t)/(t?2:1)},0)}const Cr={};function dp(n,t=!0){if(Cr[n])return Cr[n];const e={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[n];for(let i=0;i<e.length;i++)if(su(e[i],"audio",t))return Cr[n]=e[i],e[i];return n}const gp=/flac|opus/i;function zn(n,t=!0){return n.replace(gp,e=>dp(e.toLowerCase(),t))}function ko(n,t){return n&&n!=="mp4a"?n:t&&t.split(",")[0]}function mp(n){const t=n.split(",");for(let e=0;e<t.length;e++){const i=t[e].split(".");if(i.length>2){let r=i.shift()+".";r+=parseInt(i.shift()).toString(16),r+=("000"+parseInt(i.shift()).toString(16)).slice(-4),t[e]=r}}return t.join(",")}const Po=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Fo=/#EXT-X-MEDIA:(.*)/g,pp=/^#EXT(?:INF|-X-TARGETDURATION):/m,Oo=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),yp=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class jt{static findGroup(t,e){for(let i=0;i<t.length;i++){const r=t[i];if(r.id===e)return r}}static resolve(t,e){return na.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return pp.test(t)}static parseMasterPlaylist(t,e){const i=wo(t),r={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},s=[];Po.lastIndex=0;let a;for(;(a=Po.exec(t))!=null;)if(a[1]){var o;const c=new ct(a[1]);St(r,c,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const u=_s(r,a[2]),h={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:jt.resolve(u,e)},f=c.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),vp(c.CODECS,h),(o=h.unknownCodecs)!=null&&o.length||s.push(h),r.levels.push(h)}else if(a[3]){const c=a[3],u=a[4];switch(c){case"SESSION-DATA":{const h=new ct(u);St(r,h,["DATA-ID","LANGUAGE","VALUE","URI"]);const f=h["DATA-ID"];f&&(r.sessionData===null&&(r.sessionData={}),r.sessionData[f]=h);break}case"SESSION-KEY":{const h=Mo(u,e,r);h.encrypted&&h.isSupported()?(r.sessionKeys===null&&(r.sessionKeys=[]),r.sessionKeys.push(h)):L.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new ct(u);St(r,h,["NAME","VALUE","QUERYPARAM"]),Do(r,h,e)}break}case"CONTENT-STEERING":{const h=new ct(u);St(r,h,["SERVER-URI","PATHWAY-ID"]),r.contentSteering={uri:jt.resolve(h["SERVER-URI"],e),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{r.startTimeOffset=No(u);break}}}const l=s.length>0&&s.length<r.levels.length;return r.levels=l?s:r.levels,r.levels.length===0&&(r.playlistParsingError=new Error("no levels found in manifest")),r}static parseMasterPlaylistMedia(t,e,i){let r;const s={},a=i.levels,o={AUDIO:a.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:a.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(Fo.lastIndex=0;(r=Fo.exec(t))!==null;){const c=new ct(r[1]),u=c.TYPE;if(u){const h=o[u],f=s[u]||[];s[u]=f,St(i,c,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const d=c.LANGUAGE,g=c["ASSOC-LANGUAGE"],m=c.CHANNELS,p=c.CHARACTERISTICS,v=c["INSTREAM-ID"],x={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||d||"",type:u,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:d,url:c.URI?jt.resolve(c.URI,e):""};if(g&&(x.assocLang=g),m&&(x.channels=m),p&&(x.characteristics=p),v&&(x.instreamId=v),h!=null&&h.length){const T=jt.findGroup(h,x.groupId)||h[0];Uo(x,T,"audioCodec"),Uo(x,T,"textCodec")}f.push(x)}}return s}static parseLevelPlaylist(t,e,i,r,s,a){const o=new km(e),l=o.fragments;let c=null,u=0,h=0,f=0,d=0,g=null,m=new Rr(r,e),p,v,x,T=-1,S=!1,E=null;for(Oo.lastIndex=0,o.m3u8=t,o.hasVariableRefs=wo(t);(p=Oo.exec(t))!==null;){S&&(S=!1,m=new Rr(r,e),m.start=f,m.sn=u,m.cc=d,m.level=i,c&&(m.initSegment=c,m.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null,E&&(m.setByteRange(E),E=null)));const k=p[1];if(k){m.duration=parseFloat(k);const I=(" "+p[2]).slice(1);m.title=I||null,m.tagList.push(I?["INF",k,I]:["INF",k])}else if(p[3]){if(B(m.duration)){m.start=f,x&&Go(m,x,o),m.sn=u,m.level=i,m.cc=d,l.push(m);const I=(" "+p[3]).slice(1);m.relurl=_s(o,I),Bo(m,g),g=m,f+=m.duration,u++,h=0,S=!0}}else if(p[4]){const I=(" "+p[4]).slice(1);g?m.setByteRange(I,g):m.setByteRange(I)}else if(p[5])m.rawProgramDateTime=(" "+p[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),T===-1&&(T=l.length);else{if(p=p[0].match(yp),!p){L.warn("No matches on slow regex match for level playlist!");continue}for(v=1;v<p.length&&!(typeof p[v]<"u");v++);const I=(" "+p[v]).slice(1),b=(" "+p[v+1]).slice(1),$=p[v+2]?(" "+p[v+2]).slice(1):"";switch(I){case"PLAYLIST-TYPE":o.type=b.toUpperCase();break;case"MEDIA-SEQUENCE":u=o.startSN=parseInt(b);break;case"SKIP":{const F=new ct(b);St(o,F,["RECENTLY-REMOVED-DATERANGES"]);const M=F.decimalInteger("SKIPPED-SEGMENTS");if(B(M)){o.skippedSegments=M;for(let O=M;O--;)l.unshift(null);u+=M}const w=F.enumeratedString("RECENTLY-REMOVED-DATERANGES");w&&(o.recentlyRemovedDateranges=w.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(b),1);break;case"VERSION":o.version=parseInt(b);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(b||$)&&m.tagList.push($?[b,$]:[b]);break;case"DISCONTINUITY":d++,m.tagList.push(["DIS"]);break;case"GAP":m.gap=!0,m.tagList.push([I]);break;case"BITRATE":m.tagList.push([I,b]);break;case"DATERANGE":{const F=new ct(b);St(o,F,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),St(o,F,F.clientAttrs);const M=new Yc(F,o.dateRanges[F.ID]);M.isValid||o.skippedSegments?o.dateRanges[M.id]=M:L.warn(`Ignoring invalid DATERANGE tag: "${b}"`),m.tagList.push(["EXT-X-DATERANGE",b]);break}case"DEFINE":{{const F=new ct(b);St(o,F,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in F?up(o,F,a):Do(o,F,e)}break}case"DISCONTINUITY-SEQUENCE":d=parseInt(b);break;case"KEY":{const F=Mo(b,e,o);if(F.isSupported()){if(F.method==="NONE"){x=void 0;break}x||(x={}),x[F.keyFormat]&&(x=ft({},x)),x[F.keyFormat]=F}else L.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${b}"`);break}case"START":o.startTimeOffset=No(b);break;case"MAP":{const F=new ct(b);if(St(o,F,["BYTERANGE","URI"]),m.duration){const M=new Rr(r,e);$o(M,F,i,x),c=M,m.initSegment=c,c.rawProgramDateTime&&!m.rawProgramDateTime&&(m.rawProgramDateTime=c.rawProgramDateTime)}else{const M=m.byteRangeEndOffset;if(M){const w=m.byteRangeStartOffset;E=`${M-w}@${w}`}else E=null;$o(m,F,i,x),c=m,S=!0}break}case"SERVER-CONTROL":{const F=new ct(b);o.canBlockReload=F.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=F.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&F.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=F.optionalFloat("PART-HOLD-BACK",0),o.holdBack=F.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const F=new ct(b);o.partTarget=F.decimalFloatingPoint("PART-TARGET");break}case"PART":{let F=o.partList;F||(F=o.partList=[]);const M=h>0?F[F.length-1]:void 0,w=h++,O=new ct(b);St(o,O,["BYTERANGE","URI"]);const V=new Dm(O,m,e,w,M);F.push(V),m.duration+=V.duration;break}case"PRELOAD-HINT":{const F=new ct(b);St(o,F,["URI"]),o.preloadHint=F;break}case"RENDITION-REPORT":{const F=new ct(b);St(o,F,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(F);break}default:L.warn(`line parsed but not handled: ${p}`);break}}}g&&!g.relurl?(l.pop(),f-=g.duration,o.partList&&(o.fragmentHint=g)):o.partList&&(Bo(m,g),m.cc=d,o.fragmentHint=m,x&&Go(m,x,o));const R=l.length,A=l[0],C=l[R-1];if(f+=o.skippedSegments*o.targetduration,f>0&&R&&C){o.averagetargetduration=f/R;const k=C.sn;o.endSN=k!=="initSegment"?k:0,o.live||(C.endList=!0),A&&(o.startCC=A.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(f+=o.fragmentHint.duration),o.totalduration=f,o.endCC=d,T>0&&Ep(l,T),o}}function Mo(n,t,e){var i,r;const s=new ct(n);St(e,s,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=(i=s.METHOD)!=null?i:"",o=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,u=(r=s.KEYFORMAT)!=null?r:"identity";o&&s.IV&&!l&&L.error(`Invalid IV: ${s.IV}`);const h=o?jt.resolve(o,t):"",f=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Gi(a,h,u,f,l)}function No(n){const e=new ct(n).decimalFloatingPoint("TIME-OFFSET");return B(e)?e:null}function vp(n,t){let e=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const r=e.filter(s=>fp(s,i));r.length&&(t[`${i}Codec`]=r.join(","),e=e.filter(s=>r.indexOf(s)===-1))}),t.unknownCodecs=e}function Uo(n,t,e){const i=t[e];i&&(n[e]=i)}function Ep(n,t){let e=n[t];for(let i=t;i--;){const r=n[i];if(!r)return;r.programDateTime=e.programDateTime-r.duration*1e3,e=r}}function Bo(n,t){n.rawProgramDateTime?n.programDateTime=Date.parse(n.rawProgramDateTime):t!=null&&t.programDateTime&&(n.programDateTime=t.endProgramDateTime),B(n.programDateTime)||(n.programDateTime=null,n.rawProgramDateTime=null)}function $o(n,t,e,i){n.relurl=t.URI,t.BYTERANGE&&n.setByteRange(t.BYTERANGE),n.level=e,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function Go(n,t,e){n.levelkeys=t;const{encryptedFragments:i}=e;(!i.length||i[i.length-1].levelkeys!==t)&&Object.keys(t).some(r=>t[r].isCommonEncryption)&&i.push(n)}var Q={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},H={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function Ko(n){const{type:t}=n;switch(t){case Q.AUDIO_TRACK:return H.AUDIO;case Q.SUBTITLE_TRACK:return H.SUBTITLE;default:return H.MAIN}}function kr(n,t){let e=n.url;return(e===void 0||e.indexOf("data:")===0)&&(e=t.url),e}class xp{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){const e=this.hls.config,i=e.pLoader,r=e.loader,s=i||r,a=new s(e);return this.loaders[t.type]=a,a}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Q.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(t,e){const{id:i,level:r,pathwayId:s,url:a,deliveryDirectives:o}=e;this.load({id:i,level:r,pathwayId:s,responseType:"text",type:Q.LEVEL,url:a,deliveryDirectives:o})}onAudioTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:a}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:Q.AUDIO_TRACK,url:s,deliveryDirectives:a})}onSubtitleTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:a}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:Q.SUBTITLE_TRACK,url:s,deliveryDirectives:a})}load(t){var e;const i=this.hls.config;let r=this.getInternalLoader(t);if(r){const c=r.context;if(c&&c.url===t.url&&c.level===t.level){L.trace("[playlist-loader]: playlist request ongoing");return}L.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),r.abort()}let s;if(t.type===Q.MANIFEST?s=i.manifestLoadPolicy.default:s=ft({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),r=this.createInternalLoader(t),B((e=t.deliveryDirectives)==null?void 0:e.part)){let c;if(t.type===Q.LEVEL&&t.level!==null?c=this.hls.levels[t.level].details:t.type===Q.AUDIO_TRACK&&t.id!==null?c=this.hls.audioTracks[t.id].details:t.type===Q.SUBTITLE_TRACK&&t.id!==null&&(c=this.hls.subtitleTracks[t.id].details),c){const u=c.partTarget,h=c.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;s=ft({},s,{maxTimeToFirstByteMs:Math.min(f,s.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,s.maxTimeToFirstByteMs)})}}}const a=s.errorRetry||s.timeoutRetry||{},o={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(c,u,h,f)=>{const d=this.getInternalLoader(h);this.resetInternalLoader(h.type);const g=c.data;if(g.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(c,h,new Error("no EXTM3U delimiter"),f||null,u);return}u.parsing.start=performance.now(),jt.isMediaPlaylist(g)?this.handleTrackOrLevelPlaylist(c,u,h,f||null,d):this.handleMasterPlaylist(c,u,h,f)},onError:(c,u,h,f)=>{this.handleNetworkError(u,h,!1,c,f)},onTimeout:(c,u,h)=>{this.handleNetworkError(u,h,!0,void 0,c)}};r.load(t,o,l)}handleMasterPlaylist(t,e,i,r){const s=this.hls,a=t.data,o=kr(t,i),l=jt.parseMasterPlaylist(a,o);if(l.playlistParsingError){this.handleManifestParsingError(t,i,l.playlistParsingError,r,e);return}const{contentSteering:c,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:g}=l;this.variableList=g;const{AUDIO:m=[],SUBTITLES:p,"CLOSED-CAPTIONS":v}=jt.parseMasterPlaylistMedia(a,o,l);m.length&&!m.some(T=>!T.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(L.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ct({}),bitrate:0,url:""})),s.trigger(y.MANIFEST_LOADED,{levels:u,audioTracks:m,subtitles:p,captions:v,contentSteering:c,url:o,stats:e,networkDetails:r,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:g})}handleTrackOrLevelPlaylist(t,e,i,r,s){const a=this.hls,{id:o,level:l,type:c}=i,u=kr(t,i),h=0,f=B(l)?l:B(o)?o:0,d=Ko(i),g=jt.parseLevelPlaylist(t.data,u,f,d,h,this.variableList);if(c===Q.MANIFEST){const m={attrs:new ct({}),bitrate:0,details:g,name:"",url:u};a.trigger(y.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:e,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=g,this.handlePlaylistLoaded(g,t,e,i,r,s)}handleManifestParsingError(t,e,i,r,s){this.hls.trigger(y.ERROR,{type:Y.NETWORK_ERROR,details:D.MANIFEST_PARSING_ERROR,fatal:e.type===Q.MANIFEST,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:r,stats:s})}handleNetworkError(t,e,i=!1,r,s){let a=`A network ${i?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${t.type}`;t.type===Q.LEVEL?a+=`: ${t.level} id: ${t.id}`:(t.type===Q.AUDIO_TRACK||t.type===Q.SUBTITLE_TRACK)&&(a+=` id: ${t.id} group-id: "${t.groupId}"`);const o=new Error(a);L.warn(`[playlist-loader]: ${a}`);let l=D.UNKNOWN,c=!1;const u=this.getInternalLoader(t);switch(t.type){case Q.MANIFEST:l=i?D.MANIFEST_LOAD_TIMEOUT:D.MANIFEST_LOAD_ERROR,c=!0;break;case Q.LEVEL:l=i?D.LEVEL_LOAD_TIMEOUT:D.LEVEL_LOAD_ERROR,c=!1;break;case Q.AUDIO_TRACK:l=i?D.AUDIO_TRACK_LOAD_TIMEOUT:D.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case Q.SUBTITLE_TRACK:l=i?D.SUBTITLE_TRACK_LOAD_TIMEOUT:D.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(t.type);const h={type:Y.NETWORK_ERROR,details:l,fatal:c,url:t.url,loader:u,context:t,error:o,networkDetails:e,stats:s};if(r){const f=(e==null?void 0:e.url)||t.url;h.response=pt({url:f,data:void 0},r)}this.hls.trigger(y.ERROR,h)}handlePlaylistLoaded(t,e,i,r,s,a){const o=this.hls,{type:l,level:c,id:u,groupId:h,deliveryDirectives:f}=r,d=kr(e,r),g=Ko(r),m=typeof r.level=="number"&&g===H.MAIN?c:void 0;if(!t.fragments.length){const v=new Error("No Segments found in Playlist");o.trigger(y.ERROR,{type:Y.NETWORK_ERROR,details:D.LEVEL_EMPTY_ERROR,fatal:!1,url:d,error:v,reason:v.message,response:e,context:r,level:m,parent:g,networkDetails:s,stats:i});return}t.targetduration||(t.playlistParsingError=new Error("Missing Target Duration"));const p=t.playlistParsingError;if(p){o.trigger(y.ERROR,{type:Y.NETWORK_ERROR,details:D.LEVEL_PARSING_ERROR,fatal:!1,url:d,error:p,reason:p.message,response:e,context:r,level:m,parent:g,networkDetails:s,stats:i});return}switch(t.live&&a&&(a.getCacheAge&&(t.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),l){case Q.MANIFEST:case Q.LEVEL:o.trigger(y.LEVEL_LOADED,{details:t,level:m||0,id:u||0,stats:i,networkDetails:s,deliveryDirectives:f});break;case Q.AUDIO_TRACK:o.trigger(y.AUDIO_TRACK_LOADED,{details:t,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break;case Q.SUBTITLE_TRACK:o.trigger(y.SUBTITLE_TRACK_LOADED,{details:t,id:u||0,groupId:h||"",stats:i,networkDetails:s,deliveryDirectives:f});break}}}function au(n,t){let e;try{e=new Event("addtrack")}catch{e=document.createEvent("Event"),e.initEvent("addtrack",!1,!1)}e.track=n,t.dispatchEvent(e)}function ou(n,t){const e=n.mode;if(e==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(t.id))try{if(n.addCue(t),!n.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(i){L.debug(`[texttrack-utils]: ${i}`);try{const r=new self.TextTrackCue(t.startTime,t.endTime,t.text);r.id=t.id,n.addCue(r)}catch(r){L.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${r}`)}}e==="disabled"&&(n.mode=e)}function Qe(n){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues)for(let e=n.cues.length;e--;)n.removeCue(n.cues[e]);t==="disabled"&&(n.mode=t)}function Is(n,t,e,i){const r=n.mode;if(r==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const s=Sp(n.cues,t,e);for(let a=0;a<s.length;a++)(!i||i(s[a]))&&n.removeCue(s[a])}r==="disabled"&&(n.mode=r)}function Tp(n,t){if(t<n[0].startTime)return 0;const e=n.length-1;if(t>n[e].endTime)return-1;let i=0,r=e;for(;i<=r;){const s=Math.floor((r+i)/2);if(t<n[s].startTime)r=s-1;else if(t>n[s].startTime&&i<e)i=s+1;else return s}return n[i].startTime-t<t-n[r].startTime?i:r}function Sp(n,t,e){const i=[],r=Tp(n,t);if(r>-1)for(let s=r,a=n.length;s<a;s++){const o=n[s];if(o.startTime>=t&&o.endTime<=e)i.push(o);else if(o.startTime>e)return i}return i}function En(n){const t=[];for(let e=0;e<n.length;e++){const i=n[e];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&t.push(n[e])}return t}var Ut={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const Ap=.25;function bs(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Ho(n,t,e,i,r){let s=new n(t,e,"");try{s.value=i,r&&(s.type=r)}catch{s=new n(t,e,JSON.stringify(r?pt({type:r},i):i))}return s}const an=(()=>{const n=bs();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function Pr(n,t){return n.getTime()/1e3-t}function Lp(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class Rp{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(Qe(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const i=t[e];if(i.kind==="metadata"&&i.label==="id3")return au(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;const{samples:s}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=bs();if(a)for(let o=0;o<s.length;o++){const l=s[o].type;if(l===Ut.emsg&&!i||!r)continue;const c=jc(s[o].data);if(c){const u=s[o].pts;let h=u+s[o].duration;h>an&&(h=an),h-u<=0&&(h=u+Ap);for(let d=0;d<c.length;d++){const g=c[d];if(!Xc(g)){this.updateId3CueEnds(u,l);const m=Ho(a,u,h,g,l);m&&this.id3Track.addCue(m)}}}}}updateId3CueEnds(t,e){var i;const r=(i=this.id3Track)==null?void 0:i.cues;if(r)for(let s=r.length;s--;){const a=r[s];a.type===e&&a.startTime<t&&a.endTime===an&&(a.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:i,type:r}){const{id3Track:s,hls:a}=this;if(!a)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=a;if(s&&(o||l)){let c;r==="audio"?c=u=>u.type===Ut.audioId3&&l:r==="video"?c=u=>u.type===Ut.emsg&&o:c=u=>u.type===Ut.audioId3&&l||u.type===Ut.emsg&&o,Is(s,e,i,c)}}onLevelUpdated(t,{details:e}){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:r}=this,{dateRanges:s}=e,a=Object.keys(s);if(r){const u=Object.keys(i).filter(h=>!a.includes(h));for(let h=u.length;h--;){const f=u[h];Object.keys(i[f].cues).forEach(d=>{r.removeCue(i[f].cues[d])}),delete i[f]}}const o=e.fragments[e.fragments.length-1];if(a.length===0||!B(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,c=bs();for(let u=0;u<a.length;u++){const h=a[u],f=s[h],d=Pr(f.startDate,l),g=i[h],m=(g==null?void 0:g.cues)||{};let p=(g==null?void 0:g.durationKnown)||!1,v=an;const x=f.endDate;if(x)v=Pr(x,l),p=!0;else if(f.endOnNext&&!p){const S=a.reduce((E,R)=>{if(R!==f.id){const A=s[R];if(A.class===f.class&&A.startDate>f.startDate&&(!E||f.startDate<E.startDate))return A}return E},null);S&&(v=Pr(S.startDate,l),p=!0)}const T=Object.keys(f.attr);for(let S=0;S<T.length;S++){const E=T[S];if(!bm(E))continue;const R=m[E];if(R)p&&!g.durationKnown&&(R.endTime=v);else if(c){let A=f.attr[E];wm(E)&&(A=Lp(A));const C=Ho(c,d,v,{key:E,data:A},Ut.dateRange);C&&(C.id=h,this.id3Track.addCue(C),m[E]=C)}}i[h]={cues:m,dateRange:f,durationKnown:p}}}}class _p{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:t,levelDetails:e}=this;return t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const{levelDetails:t}=this;if(t===null)return null;const{holdBack:e,partHoldBack:i,targetduration:r}=t,{liveSyncDuration:s,liveSyncDurationCount:a,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let c=o&&i||e;(l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=s!==void 0?s:a*r);const u=r;return c+Math.min(this.stallCount*1,u)}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency,i=this.levelDetails;if(t===null||e===null||i===null)return null;const r=i.edge,s=t-e-this.edgeStalled,a=r-i.totalduration,o=r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(a,s),o)}get drift(){const{levelDetails:t}=this;return t===null?1:t.drift}get edgeStalled(){const{levelDetails:t}=this;if(t===null)return 0;const e=(this.config.lowLatencyMode&&t.partTarget||t.targetduration)*3;return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t,levelDetails:e}=this;if(!t||!e)return 0;const i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(y.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(y.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){this.levelDetails=e,e.advanced&&this.timeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var i;e.details===D.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&L.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||s===1||!e.live)return;const a=this.targetLatency;if(a===null)return;const o=i-a,l=Math.min(this.maxLatency,a+e.targetduration);if(o<l&&o>.05&&this.forwardBufferLength>1){const u=Math.min(2,Math.max(1,s)),h=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;t.playbackRate=Math.min(u,Math.max(1,h))}else t.playbackRate!==1&&t.playbackRate!==0&&(t.playbackRate=1)}estimateLiveEdge(){const{levelDetails:t}=this;return t===null?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return t===null?null:t-this.currentTime}}const ws=["NONE","TYPE-0","TYPE-1",null];function Ip(n){return ws.indexOf(n)>-1}const Xn=["SDR","PQ","HLG"];function bp(n){return!!n&&Xn.indexOf(n)>-1}var xn={No:"",Yes:"YES",v2:"v2"};function Vo(n){const{canSkipUntil:t,canSkipDateRanges:e,age:i}=n,r=i<t/2;return t&&r?e?xn.v2:xn.Yes:xn.No}class Yo{constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}addDirectives(t){const e=new self.URL(t);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class ci{constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return Wo(this._audioGroups,t)}hasSubtitleGroup(t){return Wo(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if(t==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(e)===-1&&i.push(e)}else if(t==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(e)===-1&&i.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return(t=this.audioGroups)==null?void 0:t[0]}get textGroupId(){var t;return(t=this.subtitleGroups)==null?void 0:t[0]}addFallback(){}}function Wo(n,t){return!t||!n?!1:n.indexOf(t)!==-1}function Fr(n,t){const e=t.startPTS;if(B(e)){let i=0,r;t.sn>n.sn?(i=e-n.start,r=n):(i=n.start-e,r=t),r.duration!==i&&(r.duration=i)}else t.sn>n.sn?n.cc===t.cc&&n.minEndPTS?t.start=n.start+(n.minEndPTS-n.start):t.start=n.start+n.duration:t.start=Math.max(n.start-t.duration,0)}function lu(n,t,e,i,r,s){i-e<=0&&(L.warn("Fragment should have a positive duration",t),i=e+t.duration,s=r+t.duration);let o=e,l=i;const c=t.startPTS,u=t.endPTS;if(B(c)){const p=Math.abs(c-e);B(t.deltaPTS)?t.deltaPTS=Math.max(p,t.deltaPTS):t.deltaPTS=p,o=Math.max(e,c),e=Math.min(e,c),r=Math.min(r,t.startDTS),l=Math.min(i,u),i=Math.max(i,u),s=Math.max(s,t.endDTS)}const h=e-t.start;t.start!==0&&(t.start=e),t.duration=i-t.start,t.startPTS=e,t.maxStartPTS=o,t.startDTS=r,t.endPTS=i,t.minEndPTS=l,t.endDTS=s;const f=t.sn;if(!n||f<n.startSN||f>n.endSN)return 0;let d;const g=f-n.startSN,m=n.fragments;for(m[g]=t,d=g;d>0;d--)Fr(m[d],m[d-1]);for(d=g;d<m.length-1;d++)Fr(m[d],m[d+1]);return n.fragmentHint&&Fr(m[m.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,h}function wp(n,t){let e=null;const i=n.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){e=c;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let r=0,s;if(kp(n,t,(l,c)=>{l.relurl&&(r=l.cc-c.cc),B(l.startPTS)&&B(l.endPTS)&&(c.start=c.startPTS=l.startPTS,c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.duration=l.endPTS-l.startPTS,c.duration&&(s=c),t.PTSKnown=t.alignedSliding=!0),c.elementaryStreams=l.elementaryStreams,c.loader=l.loader,c.stats=l.stats,l.initSegment&&(c.initSegment=l.initSegment,e=l.initSegment)}),e&&(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach(c=>{var u;c&&(!c.initSegment||c.initSegment.relurl===((u=e)==null?void 0:u.relurl))&&(c.initSegment=e)}),t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some(l=>!l),t.deltaUpdateFailed){L.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=t.skippedSegments;l--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=Dp(n.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));const a=t.fragments;if(r){L.warn("discontinuity sliding from playlist, take drift into account");for(let l=0;l<a.length;l++)a[l].cc+=r}t.skippedSegments&&(t.startCC=t.fragments[0].cc),Cp(n.partList,t.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),s?lu(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):cu(n,t),a.length&&(t.totalduration=t.edge-a[0].start),t.driftStartTime=n.driftStartTime,t.driftStart=n.driftStart;const o=t.advancedDateTime;if(t.advanced&&o){const l=t.edge;t.driftStart||(t.driftStartTime=o,t.driftStart=l),t.driftEndTime=o,t.driftEnd=l}else t.driftEndTime=n.driftEndTime,t.driftEnd=n.driftEnd,t.advancedDateTime=n.advancedDateTime}function Dp(n,t,e){const i=ft({},n);return e&&e.forEach(r=>{delete i[r]}),Object.keys(t).forEach(r=>{const s=new Yc(t[r].attr,i[r]);s.isValid?i[r]=s:L.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[r].attr)}"`)}),i}function Cp(n,t,e){if(n&&t){let i=0;for(let r=0,s=n.length;r<=s;r++){const a=n[r],o=t[r+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?e(a,o):i--}}}function kp(n,t,e){const i=t.skippedSegments,r=Math.max(n.startSN,t.startSN)-t.startSN,s=(n.fragmentHint?1:0)+(i?t.endSN:Math.min(n.endSN,t.endSN))-t.startSN,a=t.startSN-n.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let c=r;c<=s;c++){const u=l[a+c];let h=o[c];i&&!h&&c<i&&(h=t.fragments[c]=u),u&&h&&e(u,h)}}function cu(n,t){const e=t.startSN+t.skippedSegments-n.startSN,i=n.fragments;e<0||e>=i.length||Ds(t,i[e].start)}function Ds(n,t){if(t){const e=n.fragments;for(let i=n.skippedSegments;i<e.length;i++)e[i].start+=t;n.fragmentHint&&(n.fragmentHint.start+=t)}}function Pp(n,t=1/0){let e=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&e*4>t){const s=i[i.length-1].duration*1e3;s<e&&(e=s)}}else e/=2;return Math.round(e)}function Fp(n,t,e){if(!(n!=null&&n.details))return null;const i=n.details;let r=i.fragments[t-i.startSN];return r||(r=i.fragmentHint,r&&r.sn===t)?r:t<i.startSN&&e&&e.sn===t?e:null}function qo(n,t,e){var i;return n!=null&&n.details?uu((i=n.details)==null?void 0:i.partList,t,e):null}function uu(n,t,e){if(n)for(let i=n.length;i--;){const r=n[i];if(r.index===e&&r.fragment.sn===t)return r}return null}function hu(n){n.forEach((t,e)=>{const{details:i}=t;i!=null&&i.fragments&&i.fragments.forEach(r=>{r.level=e})})}function jn(n){switch(n.details){case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_TIMEOUT:case D.LEVEL_LOAD_TIMEOUT:case D.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function zo(n,t){const e=jn(t);return n.default[`${e?"timeout":"error"}Retry`]}function oa(n,t){const e=n.backoff==="linear"?1:Math.pow(2,t);return Math.min(e*n.retryDelayMs,n.maxRetryDelayMs)}function Xo(n){return pt(pt({},n),{errorRetry:null,timeoutRetry:null})}function Qn(n,t,e,i){if(!n)return!1;const r=i==null?void 0:i.code,s=t<n.maxNumRetry&&(Op(r)||!!e);return n.shouldRetry?n.shouldRetry(n,t,e,i,s):s}function Op(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}const fu={search:function(n,t){let e=0,i=n.length-1,r=null,s=null;for(;e<=i;){r=(e+i)/2|0,s=n[r];const a=t(s);if(a>0)e=r+1;else if(a<0)i=r-1;else return s}return null}};function Mp(n,t,e){if(t===null||!Array.isArray(n)||!n.length||!B(t))return null;const i=n[0].programDateTime;if(t<(i||0))return null;const r=n[n.length-1].endProgramDateTime;if(t>=(r||0))return null;e=e||0;for(let s=0;s<n.length;++s){const a=n[s];if(Up(t,e,a))return a}return null}function Jn(n,t,e=0,i=0,r=.005){let s=null;if(n){s=t[n.sn-t[0].sn+1]||null;const o=n.endDTS-e;o>0&&o<15e-7&&(e+=15e-7)}else e===0&&t[0].start===0&&(s=t[0]);if(s&&((!n||n.level===s.level)&&Cs(e,i,s)===0||Np(s,n,Math.min(r,i))))return s;const a=fu.search(t,Cs.bind(null,e,i));return a&&(a!==n||!s)?a:s}function Np(n,t,e){if(t&&t.start===0&&t.level<n.level&&(t.endPTS||0)>0){const i=t.tagList.reduce((r,s)=>(s[0]==="INF"&&(r+=parseFloat(s[1])),r),e);return n.start<=i}return!1}function Cs(n=0,t=0,e){if(e.start<=n&&e.start+e.duration>n)return 0;const i=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0));return e.start+e.duration-i<=n?1:e.start-i>n&&e.start?-1:0}function Up(n,t,e){const i=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0))*1e3;return(e.endProgramDateTime||0)-i>n}function Bp(n,t){return fu.search(n,e=>e.cc<t?1:e.cc>t?-1:0)}var vt={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Ot={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class $p{constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=L.log.bind(L,"[info]:"),this.warn=L.warn.bind(L,"[warning]:"),this.error=L.error.bind(L,"[error]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(y.ERROR,this.onError,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const t=this.hls;t&&(t.off(y.ERROR,this.onError,this),t.off(y.ERROR,this.onErrorOut,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(t==null?void 0:t.type)===H.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var i,r;if(e.fatal)return;const s=this.hls,a=e.context;switch(e.details){case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case D.FRAG_PARSING_ERROR:if((i=e.frag)!=null&&i.gap){e.errorAction={action:vt.DoNothing,flags:Ot.None};return}case D.FRAG_GAP:case D.FRAG_DECRYPT_ERROR:{e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=vt.SendAlternateToPenaltyBox;return}case D.LEVEL_EMPTY_ERROR:case D.LEVEL_PARSING_ERROR:{var o,l;const c=e.parent===H.MAIN?e.level:s.loadLevel;e.details===D.LEVEL_EMPTY_ERROR&&((o=e.context)!=null&&(l=o.levelDetails)!=null&&l.live)?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,c):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,c))}return;case D.LEVEL_LOAD_ERROR:case D.LEVEL_LOAD_TIMEOUT:typeof(a==null?void 0:a.level)=="number"&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,a.level));return;case D.AUDIO_TRACK_LOAD_ERROR:case D.AUDIO_TRACK_LOAD_TIMEOUT:case D.SUBTITLE_LOAD_ERROR:case D.SUBTITLE_TRACK_LOAD_TIMEOUT:if(a){const c=s.levels[s.loadLevel];if(c&&(a.type===Q.AUDIO_TRACK&&c.hasAudioGroup(a.groupId)||a.type===Q.SUBTITLE_TRACK&&c.hasSubtitleGroup(a.groupId))){e.errorAction=this.getPlaylistRetryOrSwitchAction(e,s.loadLevel),e.errorAction.action=vt.SendAlternateToPenaltyBox,e.errorAction.flags=Ot.MoveAllAlternatesMatchingHost;return}}return;case D.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=s.levels[s.loadLevel],u=c==null?void 0:c.attrs["HDCP-LEVEL"];u?e.errorAction={action:vt.SendAlternateToPenaltyBox,flags:Ot.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(e)}return;case D.BUFFER_ADD_CODEC_ERROR:case D.REMUX_ALLOC_ERROR:case D.BUFFER_APPEND_ERROR:e.errorAction=this.getLevelSwitchAction(e,(r=e.level)!=null?r:s.loadLevel);return;case D.INTERNAL_EXCEPTION:case D.BUFFER_APPENDING_ERROR:case D.BUFFER_FULL_ERROR:case D.LEVEL_SWITCH_ERROR:case D.BUFFER_STALLED_ERROR:case D.BUFFER_SEEK_OVER_HOLE:case D.BUFFER_NUDGE_ON_STALL:e.errorAction={action:vt.DoNothing,flags:Ot.None};return}e.type===Y.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){const e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){const i=this.hls,r=zo(i.config.playlistLoadPolicy,t),s=this.playlistError++;if(Qn(r,s,jn(t),t.response))return{action:vt.RetryRequest,flags:Ot.None,retryConfig:r,retryCount:s};const o=this.getLevelSwitchAction(t,e);return r&&(o.retryConfig=r,o.retryCount=s),o}getFragRetryOrSwitchAction(t){const e=this.hls,i=this.getVariantLevelIndex(t.frag),r=e.levels[i],{fragLoadPolicy:s,keyLoadPolicy:a}=e.config,o=zo(t.details.startsWith("key")?a:s,t),l=e.levels.reduce((u,h)=>u+h.fragmentError,0);if(r&&(t.details!==D.FRAG_GAP&&r.fragmentError++,Qn(o,l,jn(t),t.response)))return{action:vt.RetryRequest,flags:Ot.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(t,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(t,e){const i=this.hls;e==null&&(e=i.loadLevel);const r=this.hls.levels[e];if(r){var s,a;const c=t.details;r.loadError++,c===D.BUFFER_APPEND_ERROR&&r.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:d,maxAutoLevel:g}=i;i.autoLevelEnabled||(i.loadLevel=-1);const m=(s=t.frag)==null?void 0:s.type,v=(m===H.AUDIO&&c===D.FRAG_PARSING_ERROR||t.sourceBufferName==="audio"&&(c===D.BUFFER_ADD_CODEC_ERROR||c===D.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:R})=>r.audioCodec!==R),T=t.sourceBufferName==="video"&&(c===D.BUFFER_ADD_CODEC_ERROR||c===D.BUFFER_APPEND_ERROR)&&h.some(({codecSet:R,audioCodec:A})=>r.codecSet!==R&&r.audioCodec===A),{type:S,groupId:E}=(a=t.context)!=null?a:{};for(let R=h.length;R--;){const A=(R+f)%h.length;if(A!==f&&A>=d&&A<=g&&h[A].loadError===0){var o,l;const C=h[A];if(c===D.FRAG_GAP&&m===H.MAIN&&t.frag){const k=h[A].details;if(k){const I=Jn(t.frag,k.fragments,t.frag.start);if(I!=null&&I.gap)continue}}else{if(S===Q.AUDIO_TRACK&&C.hasAudioGroup(E)||S===Q.SUBTITLE_TRACK&&C.hasSubtitleGroup(E))continue;if(m===H.AUDIO&&(o=r.audioGroups)!=null&&o.some(k=>C.hasAudioGroup(k))||m===H.SUBTITLE&&(l=r.subtitleGroups)!=null&&l.some(k=>C.hasSubtitleGroup(k))||v&&r.audioCodec===C.audioCodec||!v&&r.audioCodec!==C.audioCodec||T&&r.codecSet===C.codecSet)continue}u=A;break}}if(u>-1&&i.loadLevel!==u)return t.levelRetry=!0,this.playlistError=0,{action:vt.SendAlternateToPenaltyBox,flags:Ot.None,nextAutoLevel:u}}return{action:vt.SendAlternateToPenaltyBox,flags:Ot.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var i;switch((i=e.errorAction)==null?void 0:i.action){case vt.DoNothing:break;case vt.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),!e.errorAction.resolved&&e.details!==D.FRAG_GAP?e.fatal=!0:/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(e.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(t){const e=this.hls,i=t.errorAction;if(!i)return;const{flags:r,hdcpLevel:s,nextAutoLevel:a}=i;switch(r){case Ot.None:this.switchLevel(t,a);break;case Ot.MoveAllAlternatesMatchingHDCP:s&&(e.maxHdcpLevel=ws[ws.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(t,a)}switchLevel(t,e){e!==void 0&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class la{constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=L.log.bind(L,`${e}:`),this.warn=L.warn.bind(L,`${e}:`),this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,i){const r=e==null?void 0:e.renditionReports;if(r){let s=-1;for(let a=0;a<r.length;a++){const o=r[a];let l;try{l=new self.URL(o.URI,e.url).href}catch(c){L.warn(`Could not construct new URL for Rendition Report: ${c}`),l=o.URI||""}if(l===t){s=a;break}else l===t.substring(0,l.length)&&(s=a)}if(s!==-1){const a=r[s],o=parseInt(a["LAST-MSN"])||(e==null?void 0:e.lastPartSn);let l=parseInt(a["LAST-PART"])||(e==null?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){const u=Math.min(e.age-e.partTarget,e.targetduration);l>=0&&u>e.partTarget&&(l+=1)}const c=i&&Vo(i);return new Yo(o,l>=0?l:void 0,c)}}}loadPlaylist(t){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,i){const{details:r,stats:s}=e,a=self.performance.now(),o=s.loading.first?Math.max(0,a-s.loading.first):0;if(r.advancedDateTime=Date.now()-o,r.live||i!=null&&i.live){if(r.reloaded(i),i&&this.log(`live playlist ${t} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),i&&r.fragments.length>0&&wp(i,r),!this.canLoad||!r.live)return;let l,c,u;if(r.canBlockReload&&r.endSN&&r.advanced){const p=this.hls.config.lowLatencyMode,v=r.lastPartSn,x=r.endSN,T=r.lastPartIndex,S=T!==-1,E=v===x,R=p?0:T;S?(c=E?x+1:v,u=E?R:T+1):c=x+1;const A=r.age,C=A+r.ageHeader;let k=Math.min(C-r.partTarget,r.targetduration*1.5);if(k>0){if(i&&k>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${k} with playlist age: ${r.age}`),k=0;else{const I=Math.floor(k/r.targetduration);if(c+=I,u!==void 0){const b=Math.round(k%r.targetduration/r.partTarget);u+=b}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${A.toFixed(2)}s goal: ${k} skip sn ${I} to part ${u}`)}r.tuneInGoal=k}if(l=this.getDeliveryDirectives(r,e.deliveryDirectives,c,u),p||!E){this.loadPlaylist(l);return}}else(r.canBlockReload||r.canSkipUntil)&&(l=this.getDeliveryDirectives(r,e.deliveryDirectives,c,u));const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,d=(r.edge-f)*1e3,g=Pp(r,d);r.updated&&a>this.requestScheduled+g&&(this.requestScheduled=s.loading.start),c!==void 0&&r.canBlockReload?this.requestScheduled=s.loading.first+g-(r.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+g<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=g);let m=this.requestScheduled-a;m=Math.max(0,m),this.log(`reload live playlist ${t} in ${Math.round(m)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),m)}else this.clearTimer()}getDeliveryDirectives(t,e,i,r){let s=Vo(t);return e!=null&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,r=e.part,s=xn.No),new Yo(i,r,s)}checkRetry(t){const e=t.details,i=jn(t),r=t.errorAction,{action:s,retryCount:a=0,retryConfig:o}=r||{},l=!!r&&!!o&&(s===vt.RetryRequest||!r.resolved&&s===vt.SendAlternateToPenaltyBox);if(l){var c;if(this.requestScheduled=-1,a>=o.maxNumRetry)return!1;if(i&&(c=t.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const u=oa(o,a);this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${e}" in ${u}ms`)}t.levelRetry=!0,r.resolved=!0}return l}}class Ke{constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}sample(t,e){const i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class Gp{constructor(t,e,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Ke(t),this.fast_=new Ke(e),this.defaultTTFB_=r,this.ttfb_=new Ke(t)}update(t,e){const{slow_:i,fast_:r,ttfb_:s}=this;i.halfLife!==t&&(this.slow_=new Ke(t,i.getEstimate(),i.getTotalWeight())),r.halfLife!==e&&(this.fast_=new Ke(e,r.getEstimate(),r.getTotalWeight())),s.halfLife!==t&&(this.ttfb_=new Ke(t,s.getEstimate(),s.getTotalWeight()))}sample(t,e){t=Math.max(t,this.minDelayMs_);const i=8*e,r=t/1e3,s=i/r;this.fast_.sample(r,s),this.slow_.sample(r,s)}sampleTTFB(t){const e=t/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(i,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const du={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},jo={};function Kp(n,t,e,i,r,s){const a=n.audioCodec?n.audioGroups:null,o=s==null?void 0:s.audioCodec,l=s==null?void 0:s.channels,c=l?parseInt(l):o?1/0:2;let u=null;if(a!=null&&a.length)try{a.length===1&&a[0]?u=t.groups[a[0]].channels:u=a.reduce((h,f)=>{if(f){const d=t.groups[f];if(!d)throw new Error(`Audio track group ${f} not found`);Object.keys(d.channels).forEach(g=>{h[g]=(h[g]||0)+d.channels[g]})}return h},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==e||n.bitrate>Math.max(r,8e6))||!!u&&B(c)&&Object.keys(u).some(h=>parseInt(h)>c)}function Hp(n,t,e){const i=n.videoCodec,r=n.audioCodec;if(!i||!r||!e)return Promise.resolve(du);const s={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},a=n.videoRange;a!=="SDR"&&(s.transferFunction=a.toLowerCase());const o=i.split(",").map(l=>({type:"media-source",video:pt(pt({},s),{},{contentType:Ki(l,"video")})}));return r&&n.audioGroups&&n.audioGroups.forEach(l=>{var c;l&&((c=t.groups[l])==null||c.tracks.forEach(u=>{if(u.groupId===l){const h=u.channels||"",f=parseFloat(h);B(f)&&f>2&&o.push.apply(o,r.split(",").map(d=>({type:"media-source",audio:{contentType:Ki(d,"audio"),channels:""+f}})))}}))}),Promise.all(o.map(l=>{const c=Vp(l);return jo[c]||(jo[c]=e.decodingInfo(l))})).then(l=>({supported:!l.some(c=>!c.supported),configurations:o,decodingInfoResults:l})).catch(l=>({supported:!1,configurations:o,decodingInfoResults:[],error:l}))}function Vp(n){const{audio:t,video:e}=n,i=e||t;if(i){const r=i.contentType.split('"')[1];if(e)return`r${e.height}x${e.width}f${Math.ceil(e.framerate)}${e.transferFunction||"sd"}_${r}_${Math.ceil(e.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${r}`}return""}function Yp(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(n.media!==t.media)return n.matches===!0}return!1}function Wp(n,t){let e=!1,i=[];return n&&(e=n!=="SDR",i=[n]),t&&(i=t.allowedVideoRanges||Xn.slice(0),e=t.preferHDR!==void 0?t.preferHDR:Yp(),e?i=i.filter(r=>r!=="SDR"):i=["SDR"]),{preferHDR:e,allowedVideoRanges:i}}function qp(n,t,e,i,r){const s=Object.keys(n),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=a&&parseInt(a)===2;let c=!0,u=!1,h=1/0,f=1/0,d=1/0,g=0,m=[];const{preferHDR:p,allowedVideoRanges:v}=Wp(t,r);for(let E=s.length;E--;){const R=n[s[E]];c=R.channels[2]>0,h=Math.min(h,R.minHeight),f=Math.min(f,R.minFramerate),d=Math.min(d,R.minBitrate);const A=v.filter(C=>R.videoRanges[C]>0);A.length>0&&(u=!0,m=A)}h=B(h)?h:0,f=B(f)?f:0;const x=Math.max(1080,h),T=Math.max(30,f);return d=B(d)?d:e,e=Math.max(d,e),u||(t=void 0,m=[]),{codecSet:s.reduce((E,R)=>{const A=n[R];if(R===E)return E;if(A.minBitrate>e)return ue(R,`min bitrate of ${A.minBitrate} > current estimate of ${e}`),E;if(!A.hasDefaultAudio)return ue(R,"no renditions with default or auto-select sound found"),E;if(o&&R.indexOf(o.substring(0,4))%5!==0)return ue(R,`audio codec preference "${o}" not found`),E;if(a&&!l){if(!A.channels[a])return ue(R,`no renditions with ${a} channel sound found (channels options: ${Object.keys(A.channels)})`),E}else if((!o||l)&&c&&A.channels[2]===0)return ue(R,"no renditions with stereo sound found"),E;return A.minHeight>x?(ue(R,`min resolution of ${A.minHeight} > maximum of ${x}`),E):A.minFramerate>T?(ue(R,`min framerate of ${A.minFramerate} > maximum of ${T}`),E):m.some(C=>A.videoRanges[C]>0)?A.maxScore<g?(ue(R,`max score of ${A.maxScore} < selected max of ${g}`),E):E&&(qn(R)>=qn(E)||A.fragmentError>n[E].fragmentError)?E:(g=A.maxScore,R):(ue(R,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),E)},void 0),videoRanges:m,preferHDR:p,minFramerate:f,minBitrate:d}}function ue(n,t){L.log(`[abr] start candidates with "${n}" ignored because ${t}`)}function zp(n){return n.reduce((t,e)=>{let i=t.groups[e.groupId];i||(i=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(e);const r=e.channels||"2";return i.channels[r]=(i.channels[r]||0)+1,i.hasDefault=i.hasDefault||e.default,i.hasAutoSelect=i.hasAutoSelect||e.autoselect,i.hasDefault&&(t.hasDefaultAudio=!0),i.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Xp(n,t,e,i){return n.slice(e,i+1).reduce((r,s)=>{if(!s.codecSet)return r;const a=s.audioGroups;let o=r[s.codecSet];o||(r[s.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,s.bitrate);const l=Math.min(s.height,s.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,s.frameRate),o.maxScore=Math.max(o.maxScore,s.score),o.fragmentError+=s.fragmentError,o.videoRanges[s.videoRange]=(o.videoRanges[s.videoRange]||0)+1,a&&a.forEach(c=>{if(!c)return;const u=t.groups[c];u&&(o.hasDefaultAudio=o.hasDefaultAudio||t.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(u.channels).forEach(h=>{o.channels[h]=(o.channels[h]||0)+u.channels[h]}))}),r},{})}function Qt(n,t,e){if("attrs"in n){const i=t.indexOf(n);if(i!==-1)return i}for(let i=0;i<t.length;i++){const r=t[i];if(ti(n,r,e))return i}return-1}function ti(n,t,e){const{groupId:i,name:r,lang:s,assocLang:a,characteristics:o,default:l}=n,c=n.forced;return(i===void 0||t.groupId===i)&&(r===void 0||t.name===r)&&(s===void 0||t.lang===s)&&(s===void 0||t.assocLang===a)&&(l===void 0||t.default===l)&&(c===void 0||t.forced===c)&&(o===void 0||jp(o,t.characteristics))&&(e===void 0||e(n,t))}function jp(n,t=""){const e=n.split(","),i=t.split(",");return e.length===i.length&&!e.some(r=>i.indexOf(r)===-1)}function He(n,t){const{audioCodec:e,channels:i}=n;return(e===void 0||(t.audioCodec||"").substring(0,4)===e.substring(0,4))&&(i===void 0||i===(t.channels||"2"))}function Qp(n,t,e,i,r){const s=t[i],o=t.reduce((f,d,g)=>{const m=d.uri;return(f[m]||(f[m]=[])).push(g),f},{})[s.uri];o.length>1&&(i=Math.max.apply(Math,o));const l=s.videoRange,c=s.frameRate,u=s.codecSet.substring(0,4),h=Qo(t,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const d=f.audioGroups,g=e.filter(m=>!d||d.indexOf(m.groupId)!==-1);return Qt(n,g,r)>-1});return h>-1?h:Qo(t,i,f=>{const d=f.audioGroups,g=e.filter(m=>!d||d.indexOf(m.groupId)!==-1);return Qt(n,g,r)>-1})}function Qo(n,t,e){for(let i=t;i>-1;i--)if(e(n[i]))return i;for(let i=t+1;i<n.length;i++)if(e(n[i]))return i;return-1}class Jp{constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:i,hls:r}=this,{autoLevelEnabled:s,media:a}=r;if(!e||!a)return;const o=performance.now(),l=i?i.stats:e.stats,c=i?i.duration:e.duration,u=o-l.loading.start,h=r.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||e.level<=h){this.clearTimer(),this._nextAutoLevel=-1;return}if(!s||a.paused||!a.playbackRate||!a.readyState)return;const f=r.mainForwardBufferInfo;if(f===null)return;const d=this.bwEstimator.getEstimateTTFB(),g=Math.abs(a.playbackRate);if(u<=Math.max(d,1e3*(c/(g*2))))return;const m=f.len/g,p=l.loading.first?l.loading.first-l.loading.start:-1,v=l.loaded&&p>-1,x=this.getBwEstimate(),T=r.levels,S=T[e.level],E=l.total||Math.max(l.loaded,Math.round(c*S.averageBitrate/8));let R=v?u-p:u;R<1&&v&&(R=Math.min(u,l.loaded*8/x));const A=v?l.loaded*1e3/R:0,C=A?(E-l.loaded)/A:E*8/x+d/1e3;if(C<=m)return;const k=A?A*8:x;let I=Number.POSITIVE_INFINITY,b;for(b=e.level-1;b>h;b--){const F=T[b].maxBitrate;if(I=this.getTimeToLoadFrag(d/1e3,k,c*F,!T[b].details),I<m)break}if(I>=C||I>c*10)return;r.nextLoadLevel=r.nextAutoLevel=b,v?this.bwEstimator.sample(u-Math.min(d,p),l.loaded):this.bwEstimator.sampleTTFB(u);const $=T[b].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>$&&this.resetEstimator($),this.clearTimer(),L.warn(`[abr] Fragment ${e.sn}${i?" part "+i.index:""} of level ${e.level} is loading too slowly;
      Time to underbuffer: ${m.toFixed(3)} s
      Estimated load time for current fragment: ${C.toFixed(3)} s
      Estimated load time for down switch fragment: ${I.toFixed(3)} s
      TTFB estimate: ${p|0} ms
      Current BW estimate: ${B(x)?x|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${b} @ ${$|0} bps`),r.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:i,stats:l})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(L.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const t=this.hls.config;return new Gp(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.FRAG_LOADING,this.onFragLoading,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.FRAG_LOADING,this.onFragLoading,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(y.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){const i=e.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var r;this.fragCurrent=i,this.partCurrent=(r=e.part)!=null?r:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case D.BUFFER_ADD_CODEC_ERROR:case D.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case D.FRAG_LOAD_TIMEOUT:{const i=e.frag,{fragCurrent:r,partCurrent:s}=this;if(i&&r&&i.sn===r.sn&&i.level===r.level){const a=performance.now(),o=s?s.stats:i.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(h,c),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(t,e,i,r){const s=t+i/e,a=r?this.lastLevelLoadSec:0;return s+a}onLevelLoaded(t,e){const i=this.hls.config,{loading:r}=e.stats,s=r.end-r.start;B(s)&&(this.lastLevelLoadSec=s/1e3),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(t,{frag:e,part:i}){const r=i?i.stats:e.stats;if(e.type===H.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const s=i?i.duration:e.duration,a=this.hls.levels[e.level],o=(a.loaded?a.loaded.bytes:0)+r.loaded,l=(a.loaded?a.loaded.duration:0)+s;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(e.bitrateTest){const s={stats:r,frag:e,part:i,id:e.type};this.onFragBuffered(y.FRAG_BUFFERED,s),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){const{frag:i,part:r}=e,s=r!=null&&r.stats.loaded?r.stats:i.stats;if(s.aborted||this.ignoreFragment(i))return;const a=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==H.MAIN||t.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:t,minAutoLevel:e}=this.hls,i=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,e,t,0,r,1,1);if(s>-1)return s;const a=this.hls.firstLevel,o=Math.min(Math.max(a,e),t);return L.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const t=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),r=this.lastLoadedFragLevel>-1;if(t!==-1&&(!i||!r||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;const s=i&&r?this.getNextABRAutoLevel():this.firstAutoLevel;if(t!==-1){const a=this.hls.levels;if(a.length>Math.max(t,s)&&a[t].loadError<=a[s].loadError)return t}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:i}=this,{maxAutoLevel:r,config:s,minAutoLevel:a}=i,o=e?e.duration:t?t.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=s.abrBandWidthFactor,h=s.abrBandWidthUpFactor;if(c){const p=this.findBestLevel(l,a,r,c,0,u,h);if(p>=0)return p}let f=o?Math.min(o,s.maxStarvationDelay):s.maxStarvationDelay;if(!c){const p=this.bitrateTestDelay;p&&(f=(o?Math.min(o,s.maxLoadingDelay):s.maxLoadingDelay)-p,L.info(`[abr] bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const d=this.findBestLevel(l,a,r,c,f,u,h);if(L.info(`[abr] ${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`),d>-1)return d;const g=i.levels[a],m=i.levels[i.loadLevel];return(g==null?void 0:g.bitrate)<(m==null?void 0:m.bitrate)?a:i.loadLevel}getStarvationDelay(){const t=this.hls,e=t.media;if(!e)return 1/0;const i=e&&e.playbackRate!==0?Math.abs(e.playbackRate):1,r=t.mainForwardBufferInfo;return(r?r.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,i,r,s,a,o){var l;const c=r+s,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:d}=this,{levels:g,allAudioTracks:m,loadLevel:p,config:v}=this.hls;if(g.length===1)return 0;const x=g[h],T=!!(x!=null&&(l=x.details)!=null&&l.live),S=p===-1||u===-1;let E,R="SDR",A=(x==null?void 0:x.frameRate)||0;const{audioPreference:C,videoPreference:k}=v,I=this.audioTracksByGroup||(this.audioTracksByGroup=zp(m));if(S){if(this.firstSelection!==-1)return this.firstSelection;const w=this.codecTiers||(this.codecTiers=Xp(g,I,e,i)),O=qp(w,R,t,C,k),{codecSet:V,videoRanges:q,minFramerate:N,minBitrate:U,preferHDR:X}=O;E=V,R=X?q[q.length-1]:q[0],A=N,t=Math.max(t,U),L.log(`[abr] picked start tier ${JSON.stringify(O)}`)}else E=x==null?void 0:x.codecSet,R=x==null?void 0:x.videoRange;const b=d?d.duration:f?f.duration:0,$=this.bwEstimator.getEstimateTTFB()/1e3,F=[];for(let w=i;w>=e;w--){var M;const O=g[w],V=w>h;if(!O)continue;if(v.useMediaCapabilities&&!O.supportedResult&&!O.supportedPromise){const st=navigator.mediaCapabilities;typeof(st==null?void 0:st.decodingInfo)=="function"&&Kp(O,I,R,A,t,C)?(O.supportedPromise=Hp(O,I,st),O.supportedPromise.then(at=>{if(!this.hls)return;O.supportedResult=at;const yt=this.hls.levels,It=yt.indexOf(O);at.error?L.warn(`[abr] MediaCapabilities decodingInfo error: "${at.error}" for level ${It} ${JSON.stringify(at)}`):at.supported||(L.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${It} ${JSON.stringify(at)}`),It>-1&&yt.length>1&&(L.log(`[abr] Removing unsupported level ${It}`),this.hls.removeLevel(It)))})):O.supportedResult=du}if(E&&O.codecSet!==E||R&&O.videoRange!==R||V&&A>O.frameRate||!V&&A>0&&A<O.frameRate||O.supportedResult&&!((M=O.supportedResult.decodingInfoResults)!=null&&M[0].smooth)){F.push(w);continue}const q=O.details,N=(d?q==null?void 0:q.partTarget:q==null?void 0:q.averagetargetduration)||b;let U;V?U=o*t:U=a*t;const X=b&&r>=b*2&&s===0?g[w].averageBitrate:g[w].maxBitrate,W=this.getTimeToLoadFrag($,U,X*N,q===void 0);if(U>=X&&(w===u||O.loadError===0&&O.fragmentError===0)&&(W<=$||!B(W)||T&&!this.bitrateTestDelay||W<c)){const st=this.forcedAutoLevel;return w!==p&&(st===-1||st!==p)&&(F.length&&L.trace(`[abr] Skipped level(s) ${F.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${g[F[0]].codecs}" ${g[F[0]].videoRange}; not compatible with "${x.codecs}" ${R}`),L.info(`[abr] switch candidate:${h}->${w} adjustedbw(${Math.round(U)})-bitrate=${Math.round(U-X)} ttfb:${$.toFixed(1)} avgDuration:${N.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${W.toFixed(1)} firstSelection:${S} codecSet:${E} videoRange:${R} hls.loadLevel:${p}`)),S&&(this.firstSelection=w),w}}return-1}set nextAutoLevel(t){const{maxAutoLevel:e,minAutoLevel:i}=this.hls,r=Math.min(Math.max(t,i),e);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}}class Zp{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var mt={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class ty{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(y.BUFFER_APPENDED,this.onBufferAppended,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.BUFFER_APPENDED,this.onBufferAppended,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){const i=this.activePartLists[e];if(i)for(let r=i.length;r--;){const s=i[r];if(!s)break;const a=s.end;if(s.start<=t&&a!==null&&t<=a)return s}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){const{fragments:i}=this,r=Object.keys(i);for(let s=r.length;s--;){const a=i[r[s]];if((a==null?void 0:a.body.type)===e&&a.buffered){const o=a.body;if(o.start<=t&&t<=o.end)return o}}return null}detectEvictedFragments(t,e,i,r){this.timeRanges&&(this.timeRanges[t]=e);const s=(r==null?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o||s>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===i&&this.removeFragment(o.body);return}const l=o.range[t];l&&l.time.some(c=>{const u=!this.isTimeBuffered(c.startPTS,c.endPTS,e);return u&&this.removeFragment(o.body),u})})}detectPartialFragments(t){const e=this.timeRanges,{frag:i,part:r}=t;if(!e||i.sn==="initSegment")return;const s=Ve(i),a=this.fragments[s];if(!a||a.buffered&&i.gap)return;const o=!i.relurl;Object.keys(e).forEach(l=>{const c=i.elementaryStreams[l];if(!c)return;const u=e[l],h=o||c.partial===!0;a.range[l]=this.getBufferedTimes(i,r,h,u)}),a.loaded=null,Object.keys(a.range).length?(a.buffered=!0,(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),on(a)||this.removeParts(i.sn-1,i.type)):this.removeFragment(a.body)}removeParts(t,e){const i=this.activePartLists[e];i&&(this.activePartLists[e]=i.filter(r=>r.fragment.sn>=t))}fragBuffered(t,e){const i=Ve(t);let r=this.fragments[i];!r&&e&&(r=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(t,e,i,r){const s={time:[],partial:i},a=t.start,o=t.end,l=t.minEndPTS||o,c=t.maxStartPTS||a;for(let u=0;u<r.length;u++){const h=r.start(u)-this.bufferPadding,f=r.end(u)+this.bufferPadding;if(c>=h&&l<=f){s.time.push({startPTS:Math.max(a,r.start(u)),endPTS:Math.min(o,r.end(u))});break}else if(a<f&&o>h){const d=Math.max(a,r.start(u)),g=Math.min(o,r.end(u));g>d&&(s.partial=!0,s.time.push({startPTS:d,endPTS:g}))}else if(o<=h)break}return s}getPartialFragment(t){let e=null,i,r,s,a=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(c=>{const u=l[c];u&&on(u)&&(r=u.body.start-o,s=u.body.end+o,t>=r&&t<=s&&(i=Math.min(t-r,s-t),a<=i&&(e=u.body,a=i)))}),e}isEndListAppended(t){const e=this.endListFragments[t];return e!==void 0&&(e.buffered||on(e))}getState(t){const e=Ve(t),i=this.fragments[e];return i?i.buffered?on(i)?mt.PARTIAL:mt.OK:mt.APPENDING:mt.NOT_LOADED}isTimeBuffered(t,e,i){let r,s;for(let a=0;a<i.length;a++){if(r=i.start(a)-this.bufferPadding,s=i.end(a)+this.bufferPadding,t>=r&&e<=s)return!0;if(e<=r)return!1}return!1}onFragLoaded(t,e){const{frag:i,part:r}=e;if(i.sn==="initSegment"||i.bitrateTest)return;const s=r?null:e,a=Ve(i);this.fragments[a]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:i,part:r,timeRanges:s}=e;if(i.sn==="initSegment")return;const a=i.type;if(r){let o=this.activePartLists[a];o||(this.activePartLists[a]=o=[]),o.push(r)}this.timeRanges=s,Object.keys(s).forEach(o=>{const l=s[o];this.detectEvictedFragments(o,l,a,r)})}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=Ve(t);return!!this.fragments[e]}hasParts(t){var e;return!!((e=this.activePartLists[t])!=null&&e.length)}removeFragmentsInRange(t,e,i,r,s){r&&!this.hasGaps||Object.keys(this.fragments).forEach(a=>{const o=this.fragments[a];if(!o)return;const l=o.body;l.type!==i||r&&!l.gap||l.start<e&&l.end>t&&(o.buffered||s)&&this.removeFragment(l)})}removeFragment(t){const e=Ve(t);t.stats.loaded=0,t.clearElementaryStreamInfo();const i=this.activePartLists[t.type];if(i){const r=t.sn;this.activePartLists[t.type]=i.filter(s=>s.fragment.sn!==r)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function on(n){var t,e,i;return n.buffered&&(n.body.gap||((t=n.range.video)==null?void 0:t.partial)||((e=n.range.audio)==null?void 0:e.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Ve(n){return`${n.type}_${n.level}_${n.sn}`}const ey={length:0,start:()=>0,end:()=>0};class nt{static isBuffered(t,e){try{if(t){const i=nt.getBuffered(t);for(let r=0;r<i.length;r++)if(e>=i.start(r)&&e<=i.end(r))return!0}}catch{}return!1}static bufferInfo(t,e,i){try{if(t){const r=nt.getBuffered(t),s=[];let a;for(a=0;a<r.length;a++)s.push({start:r.start(a),end:r.end(a)});return this.bufferedInfo(s,e,i)}}catch{}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,i){e=Math.max(0,e),t.sort(function(c,u){const h=c.start-u.start;return h||u.end-c.end});let r=[];if(i)for(let c=0;c<t.length;c++){const u=r.length;if(u){const h=r[u-1].end;t[c].start-h<i?t[c].end>h&&(r[u-1].end=t[c].end):r.push(t[c])}else r.push(t[c])}else r=t;let s=0,a,o=e,l=e;for(let c=0;c<r.length;c++){const u=r[c].start,h=r[c].end;if(e+i>=u&&e<h)o=u,l=h,s=l-e;else if(e+i<u){a=u;break}}return{len:s,start:o||0,end:l||0,nextStart:a}}static getBuffered(t){try{return t.buffered}catch(e){return L.log("failed to get media.buffered",e),ey}}}class ca{constructor(t,e,i,r=0,s=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=ln(),this.buffering={audio:ln(),video:ln(),audiovideo:ln()},this.level=t,this.sn=e,this.id=i,this.size=r,this.part=s,this.partial=a}}function ln(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Tn(n,t){for(let i=0,r=n.length;i<r;i++){var e;if(((e=n[i])==null?void 0:e.cc)===t)return n[i]}return null}function iy(n,t,e){return!!(t&&(e.endCC>e.startCC||n&&n.cc<e.startCC))}function ny(n,t){const e=n.fragments,i=t.fragments;if(!i.length||!e.length){L.log("No fragments to align");return}const r=Tn(e,i[0].cc);if(!r||r&&!r.startPTS){L.log("No frag in previous level to align on");return}return r}function Jo(n,t){if(n){const e=n.start+t;n.start=n.startPTS=e,n.endPTS=e+n.duration}}function gu(n,t){const e=t.fragments;for(let i=0,r=e.length;i<r;i++)Jo(e[i],n);t.fragmentHint&&Jo(t.fragmentHint,n),t.alignedSliding=!0}function ry(n,t,e){t&&(sy(n,e,t),!e.alignedSliding&&t&&Zn(e,t),!e.alignedSliding&&t&&!e.skippedSegments&&cu(t,e))}function sy(n,t,e){if(iy(n,e,t)){const i=ny(e,t);i&&B(i.start)&&(L.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),gu(i.start,t))}}function Zn(n,t){if(!n.hasProgramDateTime||!t.hasProgramDateTime)return;const e=n.fragments,i=t.fragments;if(!e.length||!i.length)return;let r,s;const a=Math.min(t.endCC,n.endCC);t.startCC<a&&n.startCC<a&&(r=Tn(i,a),s=Tn(e,a)),(!r||!s)&&(r=i[Math.floor(i.length/2)],s=Tn(e,r.cc)||e[Math.floor(e.length/2)]);const o=r.programDateTime,l=s.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(s.start-r.start);gu(c,n)}const Zo=Math.pow(2,17);class ay{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const i=t.url;if(!i)return Promise.reject(new fe({type:Y.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap)if(t.tagList.some(d=>d[0]==="GAP")){l(el(t));return}else t.gap=!1;const c=this.loader=t.loader=s?new s(r):new a(r),u=tl(t),h=Xo(r.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:t.sn==="initSegment"?1/0:Zo};t.stats=c.stats,c.load(u,f,{onSuccess:(d,g,m,p)=>{this.resetLoader(t,c);let v=d.data;m.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),o({frag:t,part:null,payload:v,networkDetails:p})},onError:(d,g,m,p)=>{this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:pt({url:i,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:m,stats:p}))},onAbort:(d,g,m)=>{this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:m,stats:d}))},onTimeout:(d,g,m)=>{this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:m,stats:d}))},onProgress:(d,g,m,p)=>{e&&e({frag:t,part:null,payload:m,networkDetails:p})}})})}loadPart(t,e,i){this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap){l(el(t,e));return}const c=this.loader=t.loader=s?new s(r):new a(r),u=tl(t,e),h=Xo(r.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Zo};e.stats=c.stats,c.load(u,f,{onSuccess:(d,g,m,p)=>{this.resetLoader(t,c),this.updateStatsFromPart(t,e);const v={frag:t,part:e,payload:d.data,networkDetails:p};i(v),o(v)},onError:(d,g,m,p)=>{this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:pt({url:u.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:m,stats:p}))},onAbort:(d,g,m)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:m,stats:d}))},onTimeout:(d,g,m)=>{this.resetLoader(t,c),l(new fe({type:Y.NETWORK_ERROR,details:D.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:m,stats:d}))}})})}updateStatsFromPart(t,e){const i=t.stats,r=e.stats,s=r.total;if(i.loaded+=r.loaded,s){const l=Math.round(t.duration/e.duration),c=Math.min(Math.round(i.loaded/s),l),h=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=r.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function tl(n,t=null){const e=t||n,i={frag:n,part:t,responseType:"arraybuffer",url:e.url,headers:{},rangeStart:0,rangeEnd:0},r=e.byteRangeStartOffset,s=e.byteRangeEndOffset;if(B(r)&&B(s)){var a;let o=r,l=s;if(n.sn==="initSegment"&&((a=n.decryptdata)==null?void 0:a.method)==="AES-128"){const c=s-r;c%16&&(l=s+(16-c%16)),r!==0&&(i.resetIV=!0,o=r-16)}i.rangeStart=o,i.rangeEnd=l}return i}function el(n,t){const e=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:Y.MEDIA_ERROR,details:D.FRAG_GAP,fatal:!1,frag:n,error:e,networkDetails:null};return t&&(i.part=t),(t||n).stats.aborted=!0,new fe(i)}class fe extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class oy{constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class ly{constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function cy(n){const t=n.byteLength,e=t&&new DataView(n.buffer).getUint8(t-1);return e?ke(n,0,t-e):n}class uy{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),i=new Uint32Array(4);for(let r=0;r<4;r++)i[r]=e.getUint32(r*4);return i}initTable(){const t=this.sBox,e=this.invSBox,i=this.subMix,r=i[0],s=i[1],a=i[2],o=i[3],l=this.invSubMix,c=l[0],u=l[1],h=l[2],f=l[3],d=new Uint32Array(256);let g=0,m=0,p=0;for(p=0;p<256;p++)p<128?d[p]=p<<1:d[p]=p<<1^283;for(p=0;p<256;p++){let v=m^m<<1^m<<2^m<<3^m<<4;v=v>>>8^v&255^99,t[g]=v,e[v]=g;const x=d[g],T=d[x],S=d[T];let E=d[v]*257^v*16843008;r[g]=E<<24|E>>>8,s[g]=E<<16|E>>>16,a[g]=E<<8|E>>>24,o[g]=E,E=S*16843009^T*65537^x*257^g*16843008,c[v]=E<<24|E>>>8,u[v]=E<<16|E>>>16,h[v]=E<<8|E>>>24,f[v]=E,g?(g=x^d[d[d[S^x]]],m^=d[d[m]]):g=m=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let i=!0,r=0;for(;r<e.length&&i;)i=e[r]===this.key[r],r++;if(i)return;this.key=e;const s=this.keySize=e.length;if(s!==4&&s!==6&&s!==8)throw new Error("Invalid aes key size="+s);const a=this.ksRows=(s+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),u=this.invKeySchedule=new Uint32Array(a),h=this.sBox,f=this.rcon,d=this.invSubMix,g=d[0],m=d[1],p=d[2],v=d[3];let x,T;for(o=0;o<a;o++){if(o<s){x=c[o]=e[o];continue}T=x,o%s===0?(T=T<<8|T>>>24,T=h[T>>>24]<<24|h[T>>>16&255]<<16|h[T>>>8&255]<<8|h[T&255],T^=f[o/s|0]<<24):s>6&&o%s===4&&(T=h[T>>>24]<<24|h[T>>>16&255]<<16|h[T>>>8&255]<<8|h[T&255]),c[o]=x=(c[o-s]^T)>>>0}for(l=0;l<a;l++)o=a-l,l&3?T=c[o]:T=c[o-4],l<4||o<=4?u[l]=T:u[l]=g[h[T>>>24]]^m[h[T>>>16&255]]^p[h[T>>>8&255]]^v[h[T&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(t){return t<<24|(t&65280)<<8|(t&16711680)>>8|t>>>24}decrypt(t,e,i){const r=this.keySize+6,s=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],u=o[2],h=o[3],f=this.uint8ArrayToUint32Array_(i);let d=f[0],g=f[1],m=f[2],p=f[3];const v=new Int32Array(t),x=new Int32Array(v.length);let T,S,E,R,A,C,k,I,b,$,F,M,w,O;const V=this.networkToHostOrderSwap;for(;e<v.length;){for(b=V(v[e]),$=V(v[e+1]),F=V(v[e+2]),M=V(v[e+3]),A=b^s[0],C=M^s[1],k=F^s[2],I=$^s[3],w=4,O=1;O<r;O++)T=l[A>>>24]^c[C>>16&255]^u[k>>8&255]^h[I&255]^s[w],S=l[C>>>24]^c[k>>16&255]^u[I>>8&255]^h[A&255]^s[w+1],E=l[k>>>24]^c[I>>16&255]^u[A>>8&255]^h[C&255]^s[w+2],R=l[I>>>24]^c[A>>16&255]^u[C>>8&255]^h[k&255]^s[w+3],A=T,C=S,k=E,I=R,w=w+4;T=a[A>>>24]<<24^a[C>>16&255]<<16^a[k>>8&255]<<8^a[I&255]^s[w],S=a[C>>>24]<<24^a[k>>16&255]<<16^a[I>>8&255]<<8^a[A&255]^s[w+1],E=a[k>>>24]<<24^a[I>>16&255]<<16^a[A>>8&255]<<8^a[C&255]^s[w+2],R=a[I>>>24]<<24^a[A>>16&255]<<16^a[C>>8&255]<<8^a[k&255]^s[w+3],x[e]=V(T^d),x[e+1]=V(R^g),x[e+2]=V(E^m),x[e+3]=V(S^p),d=b,g=$,m=F,p=M,e=e+4}return x.buffer}}const hy=16;class ua{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const i=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?cy(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i){return this.useSoftware?new Promise((r,s)=>{this.softwareDecrypt(new Uint8Array(t),e,i);const a=this.flush();a?r(a.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,i)}softwareDecrypt(t,e,i){const{currentIV:r,currentResult:s,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(t=Ft(a,t),this.remainderData=null);const o=this.getValidChunk(t);if(!o.length)return null;r&&(i=r);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new uy),l.expandKey(e);const c=s;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=ke(o,-16).buffer,c||null}webCryptoDecrypt(t,e,i){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,i));this.key=e,this.fastAesKey=new ly(this.subtle,e)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new oy(this.subtle,new Uint8Array(i)).decrypt(t.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(L.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(t,e,i)))}onWebCryptoError(t,e,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t;const i=t.length-t.length%hy;return i!==t.length&&(e=ke(t,0,i),this.remainderData=ke(t,i)),e}logOnce(t){this.logEnabled&&(L.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const fy={toString:function(n){let t="";const e=n.length;for(let i=0;i<e;i++)t+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return t}},P={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class ha extends Zp{constructor(t,e,i,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=P.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=L.log.bind(L,`${r}:`),this.warn=L.warn.bind(L,`${r}:`),this.hls=t,this.fragmentLoader=new ay(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new ua(t.config),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const t=this.fragCurrent;t!=null&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=P.STOPPED}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;const i=e.partList;if(i!=null&&i.length){const s=i[i.length-1];return nt.isBuffered(this.media,s.start+s.duration/2)}const r=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var t;return(t=this.levelLastLoaded)==null?void 0:t.details}}onMediaAttached(t,e){const i=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===P.STOPPED&&this.startLoad(r.startPosition)}onMediaDetaching(){const t=this.media;t!=null&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:t,fragCurrent:e,media:i,mediaBuffer:r,state:s}=this,a=i?i.currentTime:0,o=nt.bufferInfo(r||i,a,t.maxBufferHole);if(this.log(`media seeking to ${B(a)?a.toFixed(3):a}, state: ${s}`),this.state===P.ENDED)this.resetLoadingState();else if(e){const l=t.maxFragLookUpTolerance,c=e.start-l,u=e.start+e.duration+l;if(!o.len||u<o.start||c>o.end){const h=a>u;(a<c||h)&&(h&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=P.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){const r=s=>{if(this.fragContextChanged(t)){this.warn(`Fragment ${t.sn}${s.part?" p: "+s.part.index:""} of level ${t.level} was dropped during download.`),this.fragmentTracker.removeFragment(t);return}t.stats.chunkCount++,this._handleFragmentLoadProgress(s)};this._doFragLoad(t,e,i,r).then(s=>{if(!s)return;const a=this.state;if(this.fragContextChanged(t)){(a===P.FRAG_LOADING||!this.fragCurrent&&a===P.PARSING)&&(this.fragmentTracker.removeFragment(t),this.state=P.IDLE);return}"payload"in s&&(this.log(`Loaded fragment ${t.sn} of level ${t.level}`),this.hls.trigger(y.FRAG_LOADED,s)),this._handleFragmentLoadComplete(s)}).catch(s=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(`Frag error: ${(s==null?void 0:s.message)||s}`),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;const{fragmentTracker:i}=this;if(i.getState(t)===mt.APPENDING){const s=t.type,a=this.getFwdBufferInfo(this.mediaBuffer,s),o=Math.max(t.duration,a?a.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?t.sn-l.sn:0)===1||this.reduceMaxBufferLength(o,t.duration))&&i.removeFragment(t)}else((e=this.mediaBuffer)==null?void 0:e.buffered.length)===0?i.removeAllFragments():i.hasParts(t.type)&&(i.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),i.getState(t)===mt.PARTIAL&&i.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){const e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}flushMainBuffer(t,e,i=null){if(!(t-e))return;const r={startOffset:t,endOffset:e,type:i};this.hls.trigger(y.BUFFER_FLUSHING,r)}_loadInitSegment(t,e){this._doFragLoad(t,e).then(i=>{if(!i||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:r}=this,{payload:s}=i,a=t.decryptdata;if(s&&s.byteLength>0&&a!=null&&a.key&&a.iv&&a.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(s),a.key.buffer,a.iv.buffer).catch(l=>{throw r.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:t}),l}).then(l=>{const c=self.performance.now();return r.trigger(y.FRAG_DECRYPTED,{frag:t,payload:l,stats:{tstart:o,tdecrypt:c}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(i),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){const{levels:e}=this;if(!e)throw new Error("init load aborted, missing levels");const i=t.frag.stats;this.state=P.IDLE,t.frag.data=new Uint8Array(t.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){var i,r,s,a;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.playlistType===H.MAIN?"level":"track"} ${t.level} (frag:[${((i=t.startPTS)!=null?i:NaN).toFixed(3)}-${((r=t.endPTS)!=null?r:NaN).toFixed(3)}] > buffer:${o?fy.toString(nt.getBuffered(o)):"(detached)"})`),t.sn!=="initSegment"){var l;if(t.type!==H.SUBTITLE){const u=t.elementaryStreams;if(!Object.keys(u).some(h=>!!u[h])){this.state=P.IDLE;return}}const c=(l=this.levels)==null?void 0:l[t.level];c!=null&&c.fragmentError&&(this.log(`Resetting level fragment error count of ${c.fragmentError} on frag buffered`),c.fragmentError=0)}this.state=P.IDLE,o&&(!this.loadedmetadata&&t.type==H.MAIN&&o.buffered.length&&((s=this.fragCurrent)==null?void 0:s.sn)===((a=this.fragPrevious)==null?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:i,part:r,partsLoaded:s}=t,a=!s||s.length===0||s.some(l=>!l),o=new ca(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!a);e.flush(o)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,i=null,r){var s;const a=e==null?void 0:e.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;if(t.encrypted&&!((s=t.decryptdata)!=null&&s.key)?(this.log(`Loading key for ${t.sn} of [${a.startSN}-${a.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${t.level}`),this.state=P.KEY_LOADING,this.fragCurrent=t,o=this.keyLoader.load(t).then(u=>{if(!this.fragContextChanged(u.frag))return this.hls.trigger(y.KEY_LOADED,u),this.state===P.KEY_LOADING&&(this.state=P.IDLE),u}),this.hls.trigger(y.KEY_LOADING,{frag:t}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(t,a.encryptedFragments),i=Math.max(t.start,i||0),this.config.lowLatencyMode&&t.sn!=="initSegment"){const u=a.partList;if(u&&r){i>t.end&&a.fragmentHint&&(t=a.fragmentHint);const h=this.getNextPart(u,t,i);if(h>-1){const f=u[h];this.log(`Loading part sn: ${t.sn} p: ${f.index} cc: ${t.cc} of playlist [${a.startSN}-${a.endSN}] parts [0-${h}-${u.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=P.FRAG_LOADING;let d;return o?d=o.then(g=>!g||this.fragContextChanged(g.frag)?null:this.doFragPartsLoad(t,f,e,r)).catch(g=>this.handleFragLoadError(g)):d=this.doFragPartsLoad(t,f,e,r).catch(g=>this.handleFragLoadError(g)),this.hls.trigger(y.FRAG_LOADING,{frag:t,part:f,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):d}else if(!t.url||this.loadedEndOfParts(u,i))return Promise.resolve(null)}}this.log(`Loading fragment ${t.sn} cc: ${t.cc} ${a?"of ["+a.startSN+"-"+a.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),B(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=P.FRAG_LOADING;const l=this.config.progressive;let c;return l&&o?c=o.then(u=>!u||this.fragContextChanged(u==null?void 0:u.frag)?null:this.fragmentLoader.load(t,r)).catch(u=>this.handleFragLoadError(u)):c=Promise.all([this.fragmentLoader.load(t,l?r:void 0),o]).then(([u])=>(!l&&u&&r&&r(u),u)).catch(u=>this.handleFragLoadError(u)),this.hls.trigger(y.FRAG_LOADING,{frag:t,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):c}doFragPartsLoad(t,e,i,r){return new Promise((s,a)=>{var o;const l=[],c=(o=i.details)==null?void 0:o.partList,u=h=>{this.fragmentLoader.loadPart(t,h,r).then(f=>{l[h.index]=f;const d=f.part;this.hls.trigger(y.FRAG_LOADED,f);const g=qo(i,t.sn,h.index+1)||uu(c,t.sn,h.index+1);if(g)u(g);else return s({frag:t,part:d,partsLoaded:l})}).catch(a)};u(e)})}handleFragLoadError(t){if("data"in t){const e=t.data;t.data&&e.details===D.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(y.ERROR,e)}else this.hls.trigger(y.ERROR,{type:Y.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==P.PARSING){!this.fragCurrent&&this.state!==P.STOPPED&&this.state!==P.ERROR&&(this.state=P.IDLE);return}const{frag:i,part:r,level:s}=e,a=self.performance.now();i.stats.parsing.end=a,r&&(r.stats.parsing.end=a),this.updateLevelTiming(i,r,s,t.partial)}getCurrentContext(t){const{levels:e,fragCurrent:i}=this,{level:r,sn:s,part:a}=t;if(!(e!=null&&e[r]))return this.warn(`Levels object was unset while buffering fragment ${s} of level ${r}. The current chunk will not be buffered.`),null;const o=e[r],l=a>-1?qo(o,s,a):null,c=l?l.fragment:Fp(o,s,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:l,level:o}):null}bufferFragmentData(t,e,i,r,s){var a;if(!t||this.state!==P.PARSING)return;const{data1:o,data2:l}=t;let c=o;if(o&&l&&(c=Ft(o,l)),!((a=c)!=null&&a.length))return;const u={type:t.type,frag:e,part:i,chunkMeta:r,parent:e.type,data:c};if(this.hls.trigger(y.BUFFER_APPENDING,u),t.dropped&&t.independent&&!i){if(s)return;this.flushBufferGap(e)}}flushBufferGap(t){const e=this.media;if(!e)return;if(!nt.isBuffered(e,e.currentTime)){this.flushMainBuffer(0,t.start);return}const i=e.currentTime,r=nt.bufferInfo(e,i,0),s=t.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,s*.25),o=Math.max(Math.min(t.start-a,r.end-a),i+a);t.start-o>a&&this.flushMainBuffer(o,t.start)}getFwdBufferInfo(t,e){const i=this.getLoadPosition();return B(i)?this.getFwdBufferInfoAtPos(t,i,e):null}getFwdBufferInfoAtPos(t,e,i){const{config:{maxBufferHole:r}}=this,s=nt.bufferInfo(t,e,r);if(s.len===0&&s.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(e,i);if(a&&s.nextStart<a.end)return nt.bufferInfo(t,e,Math.max(s.nextStart,r))}return s}getMaxBufferLength(t){const{config:e}=this;let i;return t?i=Math.max(8*e.maxBufferSize/t,e.maxBufferLength):i=e.maxBufferLength,Math.min(i,e.maxMaxBufferLength)}reduceMaxBufferLength(t,e){const i=this.config,r=Math.max(Math.min(t-e,i.maxBufferLength),e),s=Math.max(t-e*3,i.maxMaxBufferLength/2,r);return s>=r?(i.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0):!1}getAppendedFrag(t,e=H.MAIN){const i=this.fragmentTracker.getAppendedFrag(t,H.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(t,e){const i=e.fragments,r=i.length;if(!r)return null;const{config:s}=this,a=i[0].start;let o;if(e.live){const l=s.initialLiveManifestSize;if(r<l)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${l})`),null;(!e.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||t<a)&&(o=this.getInitialLiveFragment(e,i),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:t)}else t<=a&&(o=i[0]);if(!o){const l=s.lowLatencyMode?e.partEnd:e.fragmentEnd;o=this.getFragmentAtPosition(t,l,e)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(t,e){const i=this.fragmentTracker.getState(t);return(i===mt.OK||i===mt.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,r,s){const a=t.gap,o=this.getNextFragment(this.nextLoadPosition,e);if(o===null)return o;if(t=o,a&&t&&!t.gap&&i.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r);if(l!==null&&i.len+l.len>=s)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${t.sn}`),null}return t}mapToInitFragWhenRequired(t){return t!=null&&t.initSegment&&!(t!=null&&t.initSegment.data)&&!this.bitrateTest?t.initSegment:t}getNextPart(t,e,i){let r=-1,s=!1,a=!0;for(let o=0,l=t.length;o<l;o++){const c=t[o];if(a=a&&!c.independent,r>-1&&i<c.start)break;const u=c.loaded;u?r=-1:(s||c.independent||a)&&c.fragment===e&&(r=o),s=u}return r}loadedEndOfParts(t,e){const i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t,e){const i=this.fragPrevious;let r=null;if(i){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),r=Mp(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const s=i.sn+1;if(s>=t.startSN&&s<=t.endSN){const a=e[s-t.startSN];i.cc===a.cc&&(r=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=Bp(e,i.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const s=this.hls.liveSyncPosition;s!==null&&(r=this.getFragmentAtPosition(s,this.bitrateTest?t.fragmentEnd:t.edge,t))}return r}getFragmentAtPosition(t,e,i){const{config:r}=this;let{fragPrevious:s}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=r,u=i.partList,h=!!(r.lowLatencyMode&&u!=null&&u.length&&l);h&&l&&!this.bitrateTest&&(a=a.concat(l),o=l.sn);let f;if(t<e){const d=t>e-c?0:c;f=Jn(s,a,t,d)}else f=a[a.length-1];if(f){const d=f.sn-i.startSN,g=this.fragmentTracker.getState(f);if((g===mt.OK||g===mt.PARTIAL&&f.gap)&&(s=f),s&&f.sn===s.sn&&(!h||u[0].fragment.sn>f.sn)&&s&&f.level===s.level){const p=a[d+1];f.sn<o&&this.fragmentTracker.getState(p)!==mt.OK?f=p:f=null}}return f}synchronizeToLiveEdge(t){const{config:e,media:i}=this;if(!i)return;const r=this.hls.liveSyncPosition,s=i.currentTime,a=t.fragments[0].start,o=t.edge,l=s>=a-e.maxFragLookUpTolerance&&s<=o;if(r!==null&&i.duration>r&&(s<r||!l)){const c=e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!l&&i.readyState<4||s<o-c)&&(this.loadedmetadata||(this.nextLoadPosition=r),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${r.toFixed(3)}`),i.currentTime=r))}}alignPlaylists(t,e,i){const r=t.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const s=t.fragments[0].start,a=!e,o=t.alignedSliding&&B(s);if(a||!o&&!s){const{fragPrevious:l}=this;ry(l,i,t);const c=t.fragments[0].start;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} prev-sn: ${l?l.sn:"na"} fragments: ${r}`),c}return s}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,t.partTarget*3)}setStartPosition(t,e){let i=this.startPosition;if(i<e&&(i=-1),i===-1||this.lastCurrentTime===-1){const r=this.startTimeOffset!==null,s=r?this.startTimeOffset:t.startTimeOffset;s!==null&&B(s)?(i=e+s,s<0&&(i+=t.totalduration),i=Math.min(Math.max(e,i),e+t.totalduration),this.log(`Start time offset ${s} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):t.live?i=this.hls.liveSyncPosition||e:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:t}=this;let e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&t.sn!=="initSegment"&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){(!this.fragCurrent||!this.fragContextChanged(t)&&this.state!==P.FRAG_LOADING_WAITING_RETRY)&&(this.state=P.IDLE)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){const u=this.getCurrentContext(e.chunkMeta);u&&(e.frag=u.frag)}const i=e.frag;if(!i||i.type!==t||!this.levels)return;if(this.fragContextChanged(i)){var r;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(r=this.fragCurrent)==null?void 0:r.url}`);return}const s=e.details===D.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const a=e.errorAction,{action:o,retryCount:l=0,retryConfig:c}=a||{};if(a&&o===vt.RetryRequest&&c){this.resetStartWhenNotLoaded(this.levelLastLoaded);const u=oa(c,l);this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${l+1}/${c.maxNumRetry} in ${u}ms`),a.resolved=!0,this.retryDate=self.performance.now()+u,this.state=P.FRAG_LOADING_WAITING_RETRY}else if(c&&a)if(this.resetFragmentErrors(t),l<c.maxNumRetry)!s&&o!==vt.RemoveAlternatePermanently&&(a.resolved=!0);else{L.warn(`${e.details} reached or exceeded max retry (${l})`);return}else(a==null?void 0:a.action)===vt.SendAlternateToPenaltyBox?this.state=P.WAITING_LEVEL:this.state=P.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===P.PARSING||this.state===P.PARSED){const e=t.frag,i=t.parent,r=this.getFwdBufferInfo(this.mediaBuffer,i),s=r&&r.len>.5;s&&this.reduceMaxBufferLength(r.len,(e==null?void 0:e.duration)||10);const a=!s;return a&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(t){t===H.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==P.STOPPED&&(this.state=P.IDLE)}afterBufferFlushed(t,e,i){if(!t)return;const r=nt.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,r,i),this.state===P.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=P.IDLE}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;const e=t?t.details:null;e!=null&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of level ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,r){var s;const a=i.details;if(!a){this.warn("level.details undefined");return}if(!Object.keys(t.elementaryStreams).reduce((l,c)=>{const u=t.elementaryStreams[c];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${t.sn} ${c} duration reliably (${h})`),l||!1;const f=r?0:lu(a,t,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:a,level:i,drift:f,type:c,frag:t,start:u.startPTS,end:u.endPTS}),!0}return l},!1)&&((s=this.transmuxer)==null?void 0:s.error)===null){const l=new Error(`Found no media in fragment ${t.sn} of level ${t.level} resetting transmuxer to fallback to playlist timing`);if(i.fragmentError===0&&(i.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)),this.warn(l.message),this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:t,reason:`Found no media in msn ${t.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=P.PARSED,this.hls.trigger(y.FRAG_PARSED,{frag:t,part:e})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){t.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}class mu{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let i;if(t.length)t.length===1?i=t[0]:i=dy(t,e);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function dy(n,t){const e=new Uint8Array(t);let i=0;for(let r=0;r<n.length;r++){const s=n[r];e.set(s,i),i+=s.length}return e}function gy(){return typeof __HLS_WORKER_BUNDLE__=="function"}function my(){const n=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(n);return{worker:new self.Worker(t),objectURL:t}}function py(n){const t=new self.URL(n,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}function qt(n="",t=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class fa{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){this.cachedData&&(t=Ft(this.cachedData,t),this.cachedData=null);let i=$i(t,0),r=i?i.length:0,s;const a=this._audioTrack,o=this._id3Track,l=i?aa(i):void 0,c=t.length;for((this.basePTS===null||this.frameIndex===0&&B(l))&&(this.basePTS=yy(l,e,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ut.audioId3,duration:Number.POSITIVE_INFINITY});r<c;){if(this.canParse(t,r)){const u=this.appendFrame(a,t,r);u?(this.frameIndex++,this.lastPTS=u.sample.pts,r+=u.length,s=r):r=c}else Um(t,r)?(i=$i(t,r),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ut.audioId3,duration:Number.POSITIVE_INFINITY}),r+=i.length,s=r):r++;if(r===c&&s!==c){const u=ke(t,s);this.cachedData?this.cachedData=Ft(this.cachedData,u):this.cachedData=u}}return{audioTrack:a,videoTrack:qt(),id3Track:o,textTrack:qt()}}demuxSampleAes(t,e,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:qt(),id3Track:this._id3Track,textTrack:qt()}}destroy(){}}const yy=(n,t,e)=>{if(B(n))return n*90;const i=e?e.baseTime*9e4/e.timescale:0;return t*9e4+i};function vy(n,t,e,i){let r,s,a,o;const l=navigator.userAgent.toLowerCase(),c=i,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r=((t[e+2]&192)>>>6)+1;const h=(t[e+2]&60)>>>2;if(h>u.length-1){const f=new Error(`invalid ADTS sampling index:${h}`);n.emit(y.ERROR,y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!0,error:f,reason:f.message});return}return a=(t[e+2]&1)<<2,a|=(t[e+3]&192)>>>6,L.log(`manifest codec:${i}, ADTS type:${r}, samplingIndex:${h}`),/firefox/i.test(l)?h>=6?(r=5,o=new Array(4),s=h-3):(r=2,o=new Array(2),s=h):l.indexOf("android")!==-1?(r=2,o=new Array(2),s=h):(r=5,o=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&h>=6?s=h-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(h>=6&&a===1||/vivaldi/i.test(l))||!i&&a===1)&&(r=2,o=new Array(2)),s=h)),o[0]=r<<3,o[0]|=(h&14)>>1,o[1]|=(h&1)<<7,o[1]|=a<<3,r===5&&(o[1]|=(s&14)>>1,o[2]=(s&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:u[h],channelCount:a,codec:"mp4a.40."+r,manifestCodec:c}}function pu(n,t){return n[t]===255&&(n[t+1]&246)===240}function yu(n,t){return n[t+1]&1?7:9}function da(n,t){return(n[t+3]&3)<<11|n[t+4]<<3|(n[t+5]&224)>>>5}function Ey(n,t){return t+5<n.length}function tr(n,t){return t+1<n.length&&pu(n,t)}function xy(n,t){return Ey(n,t)&&pu(n,t)&&da(n,t)<=n.length-t}function Ty(n,t){if(tr(n,t)){const e=yu(n,t);if(t+e>=n.length)return!1;const i=da(n,t);if(i<=e)return!1;const r=t+i;return r===n.length||tr(n,r)}return!1}function vu(n,t,e,i,r){if(!n.samplerate){const s=vy(t,e,i,r);if(!s)return;n.config=s.config,n.samplerate=s.samplerate,n.channelCount=s.channelCount,n.codec=s.codec,n.manifestCodec=s.manifestCodec,L.log(`parsed codec:${n.codec}, rate:${s.samplerate}, channels:${s.channelCount}`)}}function Eu(n){return 1024*9e4/n}function Sy(n,t){const e=yu(n,t);if(t+e<=n.length){const i=da(n,t)-e;if(i>0)return{headerLength:e,frameLength:i}}}function xu(n,t,e,i,r){const s=Eu(n.samplerate),a=i+r*s,o=Sy(t,e);let l;if(o){const{frameLength:h,headerLength:f}=o,d=f+h,g=Math.max(0,e+d-t.length);g?(l=new Uint8Array(d-f),l.set(t.subarray(e+f,t.length),0)):l=t.subarray(e+f,e+d);const m={unit:l,pts:a};return g||n.samples.push(m),{sample:m,length:d,missing:g}}const c=t.length-e;return l=new Uint8Array(c),l.set(t.subarray(e,t.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}let cn=null;const Ay=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Ly=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Ry=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],_y=[0,1,1,4];function Tu(n,t,e,i,r){if(e+24>t.length)return;const s=Su(t,e);if(s&&e+s.frameLength<=t.length){const a=s.samplesPerFrame*9e4/s.sampleRate,o=i+r*a,l={unit:t.subarray(e,e+s.frameLength),pts:o,dts:o};return n.config=[],n.channelCount=s.channelCount,n.samplerate=s.sampleRate,n.samples.push(l),{sample:l,length:s.frameLength,missing:0}}}function Su(n,t){const e=n[t+1]>>3&3,i=n[t+1]>>1&3,r=n[t+2]>>4&15,s=n[t+2]>>2&3;if(e!==1&&r!==0&&r!==15&&s!==3){const a=n[t+2]>>1&1,o=n[t+3]>>6,l=e===3?3-i:i===3?3:4,c=Ay[l*14+r-1]*1e3,h=Ly[(e===3?0:e===2?1:2)*3+s],f=o===3?1:2,d=Ry[e][i],g=_y[i],m=d*8*g,p=Math.floor(d*c/h+a)*g;if(cn===null){const T=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);cn=T?parseInt(T[1]):0}return!!cn&&cn<=87&&i===2&&c>=224e3&&o===0&&(n[t+3]=n[t+3]|128),{sampleRate:h,channelCount:f,frameLength:p,samplesPerFrame:m}}}function ga(n,t){return n[t]===255&&(n[t+1]&224)===224&&(n[t+1]&6)!==0}function Au(n,t){return t+1<n.length&&ga(n,t)}function Iy(n,t){return ga(n,t)&&4<=n.length-t}function Lu(n,t){if(t+1<n.length&&ga(n,t)){const i=Su(n,t);let r=4;i!=null&&i.frameLength&&(r=i.frameLength);const s=t+r;return s===n.length||Au(n,s)}return!1}class by extends fa{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=$i(t,0);let i=(e==null?void 0:e.length)||0;if(Lu(t,i))return!1;for(let r=t.length;i<r;i++)if(Ty(t,i))return L.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return xy(t,e)}appendFrame(t,e,i){vu(t,this.observer,e,i,t.manifestCodec);const r=xu(t,e,i,this.basePTS,this.frameIndex);if(r&&r.missing===0)return r}}const wy=/\/emsg[-/]ID3/i;class Dy{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,i,r){const s=this.videoTrack=qt("video",1),a=this.audioTrack=qt("audio",1),o=this.txtTrack=qt("text",1);if(this.id3Track=qt("id3",1),this.timeOffset=0,!(t!=null&&t.byteLength))return;const l=tu(t);if(l.video){const{id:c,timescale:u,codec:h}=l.video;s.id=c,s.timescale=o.timescale=u,s.codec=h}if(l.audio){const{id:c,timescale:u,codec:h}=l.audio;a.id=c,a.timescale=u,a.codec=h}o.id=Qc.text,s.sampleDuration=0,s.duration=a.duration=r}resetContiguity(){this.remainderData=null}static probe(t){return qm(t)}demux(t,e){this.timeOffset=e;let i=t;const r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Ft(this.remainderData,t));const o=ep(i);this.remainderData=o.remainder,r.samples=o.valid||new Uint8Array}else r.samples=i;const a=this.extractID3Track(r,e);return s.samples=bo(e,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(e,this.timeOffset);return i.samples=bo(t,e),{videoTrack:e,audioTrack:qt(),id3Track:r,textTrack:qt()}}extractID3Track(t,e){const i=this.id3Track;if(t.samples.length){const r=z(t.samples,["emsg"]);r&&r.forEach(s=>{const a=rp(s);if(wy.test(a.schemeIdUri)){const o=B(a.presentationTime)?a.presentationTime/a.timeScale:e+a.presentationTimeDelta/a.timeScale;let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;i.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:Ut.emsg,duration:l})}})}return i}demuxSampleAes(t,e,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const Ru=(n,t)=>{let e=0,i=5;t+=i;const r=new Uint32Array(1),s=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=n[t];const o=Math.min(i,8),l=8-o;s[0]=4278190080>>>24+l<<l,r[0]=(a[0]&s[0])>>l,e=e?e<<o|r[0]:r[0],t+=1,i-=o}return e};class Cy extends fa{constructor(t){super(),this.observer=void 0,this.observer=t}resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,i){const r=_u(t,e,i,this.basePTS,this.frameIndex);if(r!==-1)return{sample:t.samples[t.samples.length-1],length:r,missing:0}}static probe(t){if(!t)return!1;const e=$i(t,0);if(!e)return!1;const i=e.length;return t[i]===11&&t[i+1]===119&&aa(e)!==void 0&&Ru(t,i)<16}}function _u(n,t,e,i,r){if(e+8>t.length||t[e]!==11||t[e+1]!==119)return-1;const s=t[e+4]>>6;if(s>=3)return-1;const o=[48e3,44100,32e3][s],l=t[e+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+s]*2;if(e+u>t.length)return-1;const h=t[e+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const d=(t[e+6]<<8|t[e+7])>>12-f&1,m=[2,1,2,3,3,4,4,5][h]+d,p=t[e+5]>>3,v=t[e+5]&7,x=new Uint8Array([s<<6|p<<1|v>>2,(v&3)<<6|h<<3|d<<2|l>>4,l<<4&224]),T=1536/o*9e4,S=i+r*T,E=t.subarray(e,e+u);return n.config=x,n.channelCount=m,n.samplerate=o,n.samples.push({unit:E,pts:S}),u}class ky{constructor(){this.VideoSample=null}createVideoSample(t,e,i,r){return{key:t,frame:!1,pts:e,dts:i,units:[],debug:r,length:0}}getLastNalUnit(t){var e;let i=this.VideoSample,r;if((!i||i.units.length===0)&&(i=t[t.length-1]),(e=i)!=null&&e.units){const s=i.units;r=s[s.length-1]}return r}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(t.pts===void 0){const i=e.samples,r=i.length;if(r){const s=i[r-1];t.pts=s.pts,t.dts=s.dts}else{e.dropped++;return}}e.samples.push(t)}t.debug.length&&L.log(t.pts+"/"+t.dts+":"+t.debug)}}class il{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,i=t.byteLength-e,r=new Uint8Array(4),s=Math.min(4,e);if(s===0)throw new Error("no bytes available");r.set(t.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s}skipBits(t){let e;t=Math.min(t,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const i=this.word>>>32-e;if(t>32&&L.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return e=t-e,e>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if(this.word&2147483648>>>t)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e=8,i=8,r;for(let s=0;s<t;s++)i!==0&&(r=this.readEG(),i=(e+r+256)%256),e=i===0?e:i}readSPS(){let t=0,e=0,i=0,r=0,s,a,o;const l=this.readUByte.bind(this),c=this.readBits.bind(this),u=this.readUEG.bind(this),h=this.readBoolean.bind(this),f=this.skipBits.bind(this),d=this.skipEG.bind(this),g=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);l();const p=l();if(c(5),f(3),l(),g(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){const R=u();if(R===3&&f(1),g(),g(),f(1),h())for(a=R!==3?8:12,o=0;o<a;o++)h()&&(o<6?m(16):m(64))}g();const v=u();if(v===0)u();else if(v===1)for(f(1),d(),d(),s=u(),o=0;o<s;o++)d();g(),f(1);const x=u(),T=u(),S=c(1);S===0&&f(1),f(1),h()&&(t=u(),e=u(),i=u(),r=u());let E=[1,1];if(h()&&h())switch(l()){case 1:E=[1,1];break;case 2:E=[12,11];break;case 3:E=[10,11];break;case 4:E=[16,11];break;case 5:E=[40,33];break;case 6:E=[24,11];break;case 7:E=[20,11];break;case 8:E=[32,11];break;case 9:E=[80,33];break;case 10:E=[18,11];break;case 11:E=[15,11];break;case 12:E=[64,33];break;case 13:E=[160,99];break;case 14:E=[4,3];break;case 15:E=[3,2];break;case 16:E=[2,1];break;case 255:{E=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((x+1)*16-t*2-e*2),height:(2-S)*(T+1)*16-(S?2:4)*(i+r),pixelRatio:E}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Py extends ky{parseAVCPES(t,e,i,r,s){const a=this.parseAVCNALu(t,i.data);let o=this.VideoSample,l,c=!1;i.data=null,o&&a.length&&!t.audFound&&(this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),a.forEach(u=>{var h;switch(u.type){case 1:{let m=!1;l=!0;const p=u.data;if(c&&p.length>4){const v=new il(p).readSliceType();(v===2||v===4||v===7||v===9)&&(m=!0)}if(m){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=m;break}case 5:l=!0,(h=o)!=null&&h.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:{l=!0,iu(u.data,1,i.pts,e.samples);break}case 7:{var d,g;l=!0,c=!0;const m=u.data,v=new il(m).readSPS();if(!t.sps||t.width!==v.width||t.height!==v.height||((d=t.pixelRatio)==null?void 0:d[0])!==v.pixelRatio[0]||((g=t.pixelRatio)==null?void 0:g[1])!==v.pixelRatio[1]){t.width=v.width,t.height=v.height,t.pixelRatio=v.pixelRatio,t.sps=[m],t.duration=s;const x=m.subarray(1,4);let T="avc1.";for(let S=0;S<3;S++){let E=x[S].toString(16);E.length<2&&(E="0"+E),T+=E}t.codec=T}break}case 8:l=!0,t.pps=[u.data];break;case 9:l=!0,t.audFound=!0,o&&this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:l=!0;break;default:l=!1,o&&(o.debug+="unknown NAL "+u.type+" ");break}o&&l&&o.units.push(u)}),r&&o&&(this.pushAccessUnit(o,t),this.VideoSample=null)}parseAVCNALu(t,e){const i=e.byteLength;let r=t.naluState||0;const s=r,a=[];let o=0,l,c,u,h=-1,f=0;for(r===-1&&(h=0,f=e[0]&31,r=0,o=1);o<i;){if(l=e[o++],!r){r=l?0:1;continue}if(r===1){r=l?0:2;continue}if(!l)r=3;else if(l===1){if(c=o-r-1,h>=0){const d={data:e.subarray(h,c),type:f};a.push(d)}else{const d=this.getLastNalUnit(t.samples);d&&(s&&o<=4-s&&d.state&&(d.data=d.data.subarray(0,d.data.byteLength-s)),c>0&&(d.data=Ft(d.data,e.subarray(0,c)),d.state=0))}o<i?(u=e[o]&31,h=o,f=u,r=0):r=-1}else r=0}if(h>=0&&r>=0){const d={data:e.subarray(h,i),type:f,state:r};a.push(d)}if(a.length===0){const d=this.getLastNalUnit(t.samples);d&&(d.data=Ft(d.data,e))}return t.naluState=r,a}}class Fy{constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new ua(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,i){const r=t[e].unit;if(r.length<=16)return;const s=r.subarray(16,r.length-r.length%16),a=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);r.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)})}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length){i();return}if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){const e=Math.floor((t.length-48)/160)*16+16,i=new Int8Array(e);let r=0;for(let s=32;s<t.length-16;s+=160,r+=16)i.set(t.subarray(s,s+16),r);return i}getAvcDecryptedUnit(t,e){const i=new Uint8Array(e);let r=0;for(let s=32;s<t.length-16;s+=160,r+=16)t.set(i.subarray(r,r+16),s);return t}decryptAvcSample(t,e,i,r,s){const a=nu(s.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{s.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,r)})}decryptAvcSamples(t,e,i,r){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length){r();return}const s=t[e].units;for(;!(i>=s.length);i++){const a=s[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(t,e,i,r,a),!this.decrypter.isSync()))return}}}}const gt=188;class Ee{constructor(t,e,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.videoParser=new Py}static probe(t){const e=Ee.syncOffset(t);return e>0&&L.warn(`MPEG2-TS detected but first sync word found @ offset ${e}`),e!==-1}static syncOffset(t){const e=t.length;let i=Math.min(gt*5,e-gt)+1,r=0;for(;r<i;){let s=!1,a=-1,o=0;for(let l=r;l<e;l+=gt)if(t[l]===71&&(e-l===gt||t[l+gt]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+gt*99,t.length-gt)+1)),s||(s=ks(t,l)===0),s&&o>1&&(a===0&&o>2||l+gt>i))return a}else{if(o)return-1;break}r++}return-1}static createTrack(t,e){return{container:t==="video"||t==="audio"?"video/mp2t":void 0,type:t,id:Qc[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:t==="audio"?e:void 0}}resetInitSegment(t,e,i,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Ee.createTrack("video"),this._audioTrack=Ee.createTrack("audio",r),this._id3Track=Ee.createTrack("id3"),this._txtTrack=Ee.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_videoTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,i=!1,r=!1){i||(this.sampleAes=null);let s;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=a.pid,h=a.pesData,f=o.pid,d=l.pid,g=o.pesData,m=l.pesData,p=null,v=this.pmtParsed,x=this._pmtId,T=t.length;if(this.remainderData&&(t=Ft(this.remainderData,t),T=t.length,this.remainderData=null),T<gt&&!r)return this.remainderData=t,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const S=Math.max(0,Ee.syncOffset(t));T-=(T-S)%gt,T<t.byteLength&&!r&&(this.remainderData=new Uint8Array(t.buffer,T,t.buffer.byteLength-T));let E=0;for(let A=S;A<T;A+=gt)if(t[A]===71){const C=!!(t[A+1]&64),k=ks(t,A),I=(t[A+3]&48)>>4;let b;if(I>1){if(b=A+5+t[A+4],b===A+gt)continue}else b=A+4;switch(k){case u:C&&(h&&(s=Ye(h))&&this.videoParser.parseAVCPES(a,c,s,!1,this._duration),h={data:[],size:0}),h&&(h.data.push(t.subarray(b,A+gt)),h.size+=A+gt-b);break;case f:if(C){if(g&&(s=Ye(g)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,s);break;case"mp3":this.parseMPEGPES(o,s);break;case"ac3":this.parseAC3PES(o,s);break}g={data:[],size:0}}g&&(g.data.push(t.subarray(b,A+gt)),g.size+=A+gt-b);break;case d:C&&(m&&(s=Ye(m))&&this.parseID3PES(l,s),m={data:[],size:0}),m&&(m.data.push(t.subarray(b,A+gt)),m.size+=A+gt-b);break;case 0:C&&(b+=t[b]+1),x=this._pmtId=Oy(t,b);break;case x:{C&&(b+=t[b]+1);const $=My(t,b,this.typeSupported,i,this.observer);u=$.videoPid,u>0&&(a.pid=u,a.segmentCodec=$.segmentVideoCodec),f=$.audioPid,f>0&&(o.pid=f,o.segmentCodec=$.segmentAudioCodec),d=$.id3Pid,d>0&&(l.pid=d),p!==null&&!v&&(L.warn(`MPEG-TS PMT found at ${A} after unknown PID '${p}'. Backtracking to sync byte @${S} to parse all TS packets.`),p=null,A=S-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=k;break}}else E++;E>0&&er(this.observer,new Error(`Found ${E} TS packet/s that do not start with 0x47`)),a.pesData=h,o.pesData=g,l.pesData=m;const R={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return r&&this.extractRemainingSamples(R),R}flush(){const{remainderData:t}=this;this.remainderData=null;let e;return t?e=this.demux(t,-1,!1,!0):e={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:i,id3Track:r,textTrack:s}=t,a=i.pesData,o=e.pesData,l=r.pesData;let c;if(a&&(c=Ye(a))?(this.videoParser.parseAVCPES(i,s,c,!0,this._duration),i.pesData=null):i.pesData=a,o&&(c=Ye(o))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,c);break;case"mp3":this.parseMPEGPES(e,c);break;case"ac3":this.parseAC3PES(e,c);break}e.pesData=null}else o!=null&&o.size&&L.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=o;l&&(c=Ye(l))?(this.parseID3PES(r,c),r.pesData=null):r.pesData=l}demuxSampleAes(t,e,i){const r=this.demux(t,i,!0,!this.config.progressive),s=this.sampleAes=new Fy(this.observer,this.config,e);return this.decrypt(r,s)}decrypt(t,e){return new Promise(i=>{const{audioTrack:r,videoTrack:s}=t;r.samples&&r.segmentCodec==="aac"?e.decryptAacSamples(r.samples,0,()=>{s.samples?e.decryptAvcSamples(s.samples,0,0,()=>{i(t)}):i(t)}):s.samples&&e.decryptAvcSamples(s.samples,0,0,()=>{i(t)})})}destroy(){this._duration=0}parseAACPES(t,e){let i=0;const r=this.aacOverFlow;let s=e.data;if(r){this.aacOverFlow=null;const h=r.missing,f=r.sample.unit.byteLength;if(h===-1)s=Ft(r.sample.unit,s);else{const d=f-h;r.sample.unit.set(s.subarray(0,h),d),t.samples.push(r.sample),i=r.missing}}let a,o;for(a=i,o=s.length;a<o-1&&!tr(s,a);a++);if(a!==i){let h;const f=a<o-1;if(f?h=`AAC PES did not start with ADTS header,offset:${a}`:h="No ADTS header found in AAC PES",er(this.observer,new Error(h),f),!f)return}vu(t,this.observer,s,a,this.audioCodec);let l;if(e.pts!==void 0)l=e.pts;else if(r){const h=Eu(t.samplerate);l=r.sample.pts+h}else{L.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;a<o;)if(u=xu(t,s,a,l,c),a+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;a<o-1&&!tr(s,a);a++);}parseMPEGPES(t,e){const i=e.data,r=i.length;let s=0,a=0;const o=e.pts;if(o===void 0){L.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<r;)if(Au(i,a)){const l=Tu(t,i,a,o,s);if(l)a+=l.length,s++;else break}else a++}parseAC3PES(t,e){{const i=e.data,r=e.pts;if(r===void 0){L.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const s=i.length;let a=0,o=0,l;for(;o<s&&(l=_u(t,i,o,r,a++))>0;)o+=l}}parseID3PES(t,e){if(e.pts===void 0){L.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=ft({},e,{type:this._videoTrack?Ut.emsg:Ut.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}}function ks(n,t){return((n[t+1]&31)<<8)+n[t+2]}function Oy(n,t){return(n[t+10]&31)<<8|n[t+11]}function My(n,t,e,i,r){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(n[t+1]&15)<<8|n[t+2],o=t+3+a-4,l=(n[t+10]&15)<<8|n[t+11];for(t+=12+l;t<o;){const c=ks(n,t),u=(n[t+3]&15)<<8|n[t+4];switch(n[t]){case 207:if(!i){Or("ADTS AAC");break}case 15:s.audioPid===-1&&(s.audioPid=c);break;case 21:s.id3Pid===-1&&(s.id3Pid=c);break;case 219:if(!i){Or("H.264");break}case 27:s.videoPid===-1&&(s.videoPid=c,s.segmentVideoCodec="avc");break;case 3:case 4:!e.mpeg&&!e.mp3?L.log("MPEG audio found, not supported in this browser"):s.audioPid===-1&&(s.audioPid=c,s.segmentAudioCodec="mp3");break;case 193:if(!i){Or("AC-3");break}case 129:e.ac3?s.audioPid===-1&&(s.audioPid=c,s.segmentAudioCodec="ac3"):L.log("AC-3 audio found, not supported in this browser");break;case 6:if(s.audioPid===-1&&u>0){let h=t+5,f=u;for(;f>2;){switch(n[h]){case 106:e.ac3!==!0?L.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=c,s.segmentAudioCodec="ac3");break}const g=n[h+1]+2;h+=g,f-=g}}break;case 194:case 135:return er(r,new Error("Unsupported EC-3 in M2TS found")),s;case 36:return er(r,new Error("Unsupported HEVC in M2TS found")),s}t+=u+5}return s}function er(n,t,e){L.warn(`parsing error: ${t.message}`),n.emit(y.ERROR,y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:t,reason:t.message})}function Or(n){L.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Ye(n){let t=0,e,i,r,s,a;const o=n.data;if(!n||n.size===0)return null;for(;o[0].length<19&&o.length>1;)o[0]=Ft(o[0],o[1]),o.splice(1,1);if(e=o[0],(e[0]<<16)+(e[1]<<8)+e[2]===1){if(i=(e[4]<<8)+e[5],i&&i>n.size-6)return null;const c=e[7];c&192&&(s=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,c&64?(a=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,s-a>60*9e4&&(L.warn(`${Math.round((s-a)/9e4)}s delta between PTS and DTS, align them`),s=a)):a=s),r=e[8];let u=r+9;if(n.size<=u)return null;n.size-=u;const h=new Uint8Array(n.size);for(let f=0,d=o.length;f<d;f++){e=o[f];let g=e.byteLength;if(u)if(u>g){u-=g;continue}else e=e.subarray(u),g-=u,u=0;h.set(e,t),t+=g}return i&&(i-=r+3),{data:h,pts:s,dts:a,len:i}}return null}class Ny extends fa{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=$i(t,0);let i=(e==null?void 0:e.length)||0;if(e&&t[i]===11&&t[i+1]===119&&aa(e)!==void 0&&Ru(t,i)<=16)return!1;for(let r=t.length;i<r;i++)if(Lu(t,i))return L.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return Iy(t,e)}appendFrame(t,e,i){if(this.basePTS!==null)return Tu(t,e,i,this.basePTS,this.frameIndex)}}class nl{static getSilentFrame(t,e){switch(t){case"mp4a.40.2":if(e===1)return new Uint8Array([0,200,0,128,35,128]);if(e===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(e===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(e===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(e===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(e===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(e===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const pe=Math.pow(2,32)-1;class _{static init(){_.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in _.types)_.types.hasOwnProperty(t)&&(_.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);_.HDLR_TYPES={video:e,audio:i};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);_.STTS=_.STSC=_.STCO=s,_.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),_.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),_.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),_.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);_.FTYP=_.box(_.types.ftyp,a,l,a,o),_.DINF=_.box(_.types.dinf,_.box(_.types.dref,r))}static box(t,...e){let i=8,r=e.length;const s=r;for(;r--;)i+=e[r].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(t,4),r=0,i=8;r<s;r++)a.set(e[r],i),i+=e[r].byteLength;return a}static hdlr(t){return _.box(_.types.hdlr,_.HDLR_TYPES[t])}static mdat(t){return _.box(_.types.mdat,t)}static mdhd(t,e){e*=t;const i=Math.floor(e/(pe+1)),r=Math.floor(e%(pe+1));return _.box(_.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,r>>24,r>>16&255,r>>8&255,r&255,85,196,0,0]))}static mdia(t){return _.box(_.types.mdia,_.mdhd(t.timescale,t.duration),_.hdlr(t.type),_.minf(t))}static mfhd(t){return _.box(_.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type==="audio"?_.box(_.types.minf,_.box(_.types.smhd,_.SMHD),_.DINF,_.stbl(t)):_.box(_.types.minf,_.box(_.types.vmhd,_.VMHD),_.DINF,_.stbl(t))}static moof(t,e,i){return _.box(_.types.moof,_.mfhd(t),_.traf(i,e))}static moov(t){let e=t.length;const i=[];for(;e--;)i[e]=_.trak(t[e]);return _.box.apply(null,[_.types.moov,_.mvhd(t[0].timescale,t[0].duration)].concat(i).concat(_.mvex(t)))}static mvex(t){let e=t.length;const i=[];for(;e--;)i[e]=_.trex(t[e]);return _.box.apply(null,[_.types.mvex,...i])}static mvhd(t,e){e*=t;const i=Math.floor(e/(pe+1)),r=Math.floor(e%(pe+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,r>>24,r>>16&255,r>>8&255,r&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return _.box(_.types.mvhd,s)}static sdtp(t){const e=t.samples||[],i=new Uint8Array(4+e.length);let r,s;for(r=0;r<e.length;r++)s=e[r].flags,i[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return _.box(_.types.sdtp,i)}static stbl(t){return _.box(_.types.stbl,_.stsd(t),_.box(_.types.stts,_.STTS),_.box(_.types.stsc,_.STSC),_.box(_.types.stsz,_.STSZ),_.box(_.types.stco,_.STCO))}static avc1(t){let e=[],i=[],r,s,a;for(r=0;r<t.sps.length;r++)s=t.sps[r],a=s.byteLength,e.push(a>>>8&255),e.push(a&255),e=e.concat(Array.prototype.slice.call(s));for(r=0;r<t.pps.length;r++)s=t.pps[r],a=s.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(s));const o=_.box(_.types.avcC,new Uint8Array([1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(i))),l=t.width,c=t.height,u=t.pixelRatio[0],h=t.pixelRatio[1];return _.box(_.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,_.box(_.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),_.box(_.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(t){const e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static audioStsd(t){const e=t.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,e&255,0,0])}static mp4a(t){return _.box(_.types.mp4a,_.audioStsd(t),_.box(_.types.esds,_.esds(t)))}static mp3(t){return _.box(_.types[".mp3"],_.audioStsd(t))}static ac3(t){return _.box(_.types["ac-3"],_.audioStsd(t),_.box(_.types.dac3,t.config))}static stsd(t){return t.type==="audio"?t.segmentCodec==="mp3"&&t.codec==="mp3"?_.box(_.types.stsd,_.STSD,_.mp3(t)):t.segmentCodec==="ac3"?_.box(_.types.stsd,_.STSD,_.ac3(t)):_.box(_.types.stsd,_.STSD,_.mp4a(t)):_.box(_.types.stsd,_.STSD,_.avc1(t))}static tkhd(t){const e=t.id,i=t.duration*t.timescale,r=t.width,s=t.height,a=Math.floor(i/(pe+1)),o=Math.floor(i%(pe+1));return _.box(_.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,r&255,0,0,s>>8&255,s&255,0,0]))}static traf(t,e){const i=_.sdtp(t),r=t.id,s=Math.floor(e/(pe+1)),a=Math.floor(e%(pe+1));return _.box(_.types.traf,_.box(_.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255])),_.box(_.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,a>>24,a>>16&255,a>>8&255,a&255])),_.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||4294967295,_.box(_.types.trak,_.tkhd(t),_.mdia(t))}static trex(t){const e=t.id;return _.box(_.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const i=t.samples||[],r=i.length,s=12+16*r,a=new Uint8Array(s);let o,l,c,u,h,f;for(e+=8+s,a.set([t.type==="video"?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,r&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255],0),o=0;o<r;o++)l=i[o],c=l.duration,u=l.size,h=l.flags,f=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*o);return _.box(_.types.trun,a)}static initSegment(t){_.types||_.init();const e=_.moov(t);return Ft(_.FTYP,e)}}_.types=void 0;_.HDLR_TYPES=void 0;_.STTS=void 0;_.STSC=void 0;_.STCO=void 0;_.STSZ=void 0;_.VMHD=void 0;_.SMHD=void 0;_.STSD=void 0;_.FTYP=void 0;_.DINF=void 0;const Iu=9e4;function ma(n,t,e=1,i=!1){const r=n*t*e;return i?Math.round(r):r}function Uy(n,t,e=1,i=!1){return ma(n,t,1/e,i)}function xi(n,t=!1){return ma(n,1e3,1/Iu,t)}function By(n,t=1){return ma(n,Iu,1/t)}const $y=10*1e3,rl=1024,Gy=1152,Ky=1536;let We=null,Mr=null;class Sn{constructor(t,e,i,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.ISGenerated=!1,We===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);We=a?parseInt(a[1]):0}if(Mr===null){const s=navigator.userAgent.match(/Safari\/(\d+)/i);Mr=s?parseInt(s[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){L.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){L.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){L.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1;const i=t.reduce((r,s)=>{const a=s.pts-r;return a<-4294967296?(e=!0,wt(r,s.pts)):a>0?r:s.pts},t[0].pts);return e&&L.debug("PTS rollover detected"),i}remux(t,e,i,r,s,a,o,l){let c,u,h,f,d,g,m=s,p=s;const v=t.pid>-1,x=e.pid>-1,T=e.samples.length,S=t.samples.length>0,E=o&&T>0||T>1;if((!v||S)&&(!x||E)||this.ISGenerated||o){if(this.ISGenerated){var A,C,k,I;const M=this.videoTrackConfig;M&&(e.width!==M.width||e.height!==M.height||((A=e.pixelRatio)==null?void 0:A[0])!==((C=M.pixelRatio)==null?void 0:C[0])||((k=e.pixelRatio)==null?void 0:k[1])!==((I=M.pixelRatio)==null?void 0:I[1]))&&this.resetInitSegment()}else h=this.generateIS(t,e,s,a);const b=this.isVideoContiguous;let $=-1,F;if(E&&($=Hy(e.samples),!b&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,$>0){L.warn(`[mp4-remuxer]: Dropped ${$} out of ${T} video samples due to a missing keyframe`);const M=this.getVideoStartPts(e.samples);e.samples=e.samples.slice($),e.dropped+=$,p+=(e.samples[0].pts-M)/e.inputTimeScale,F=p}else $===-1&&(L.warn(`[mp4-remuxer]: No keyframe found out of ${T} video samples`),g=!1);if(this.ISGenerated){if(S&&E){const M=this.getVideoStartPts(e.samples),O=(wt(t.samples[0].pts,M)-M)/e.inputTimeScale;m+=Math.max(0,O),p+=Math.max(0,-O)}if(S){if(t.samplerate||(L.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(t,e,s,a)),u=this.remuxAudio(t,m,this.isAudioContiguous,a,x||E||l===H.AUDIO?p:void 0),E){const M=u?u.endPTS-u.startPTS:0;e.inputTimeScale||(L.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(t,e,s,a)),c=this.remuxVideo(e,p,b,M)}}else E&&(c=this.remuxVideo(e,p,b,0));c&&(c.firstKeyFrame=$,c.independent=$!==-1,c.firstKeyFramePTS=F)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(d=bu(i,s,this._initPTS,this._initDTS)),r.samples.length&&(f=wu(r,s,this._initPTS))),{audio:u,video:c,initSegment:h,independent:g,text:f,id3:d}}generateIS(t,e,i,r){const s=t.samples,a=e.samples,o=this.typeSupported,l={},c=this._initPTS;let u=!c||r,h="audio/mp4",f,d,g;if(u&&(f=d=1/0),t.config&&s.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":o.mpeg?(h="audio/mpeg",t.codec=""):o.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3";break}l.audio={id:"audio",container:h,codec:t.codec,initSegment:t.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):_.initSegment([t]),metadata:{channelCount:t.channelCount}},u&&(g=t.inputTimeScale,!c||g!==c.timescale?f=d=s[0].pts-Math.round(g*i):u=!1)}if(e.sps&&e.pps&&a.length){if(e.timescale=e.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:_.initSegment([e]),metadata:{width:e.width,height:e.height}},u)if(g=e.inputTimeScale,!c||g!==c.timescale){const m=this.getVideoStartPts(a),p=Math.round(g*i);d=Math.min(d,wt(a[0].dts,m)-p),f=Math.min(f,m-p)}else u=!1;this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:f,timescale:g},this._initDTS={baseTime:d,timescale:g}):f=g=void 0,{tracks:l,initPTS:f,timescale:g}}remuxVideo(t,e,i,r){const s=t.inputTimeScale,a=t.samples,o=[],l=a.length,c=this._initPTS;let u=this.nextAvcDts,h=8,f=this.videoSampleDuration,d,g,m=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,v=!1;if(!i||u===null){const N=e*s,U=a[0].pts-wt(a[0].dts,a[0].pts);We&&u!==null&&Math.abs(N-U-u)<15e3?i=!0:u=N-U}const x=c.baseTime*s/c.timescale;for(let N=0;N<l;N++){const U=a[N];U.pts=wt(U.pts-x,u),U.dts=wt(U.dts-x,u),U.dts<a[N>0?N-1:N].dts&&(v=!0)}v&&a.sort(function(N,U){const X=N.dts-U.dts,W=N.pts-U.pts;return X||W}),d=a[0].dts,g=a[a.length-1].dts;const T=g-d,S=T?Math.round(T/(l-1)):f||t.inputTimeScale/30;if(i){const N=d-u,U=N>S,X=N<-1;if((U||X)&&(U?L.warn(`AVC: ${xi(N,!0)} ms (${N}dts) hole between fragments detected at ${e.toFixed(3)}`):L.warn(`AVC: ${xi(-N,!0)} ms (${N}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!X||u>=a[0].pts||We)){d=u;const W=a[0].pts-N;if(U)a[0].dts=d,a[0].pts=W;else for(let j=0;j<a.length&&!(a[j].dts>W);j++)a[j].dts-=N,a[j].pts-=N;L.log(`Video: Initial PTS/DTS adjusted: ${xi(W,!0)}/${xi(d,!0)}, delta: ${xi(N,!0)} ms`)}}d=Math.max(0,d);let E=0,R=0,A=d;for(let N=0;N<l;N++){const U=a[N],X=U.units,W=X.length;let j=0;for(let st=0;st<W;st++)j+=X[st].data.length;R+=j,E+=W,U.length=j,U.dts<A?(U.dts=A,A+=S/4|0||1):A=U.dts,m=Math.min(U.pts,m),p=Math.max(U.pts,p)}g=a[l-1].dts;const C=R+4*E+8;let k;try{k=new Uint8Array(C)}catch(N){this.observer.emit(y.ERROR,y.ERROR,{type:Y.MUX_ERROR,details:D.REMUX_ALLOC_ERROR,fatal:!1,error:N,bytes:C,reason:`fail allocating video mdat ${C}`});return}const I=new DataView(k.buffer);I.setUint32(0,C),k.set(_.types.mdat,4);let b=!1,$=Number.POSITIVE_INFINITY,F=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY,w=Number.NEGATIVE_INFINITY;for(let N=0;N<l;N++){const U=a[N],X=U.units;let W=0;for(let at=0,yt=X.length;at<yt;at++){const It=X[at],yi=It.data,gr=It.data.byteLength;I.setUint32(h,gr),h+=4,k.set(yi,h),h+=gr,W+=4+gr}let j;if(N<l-1)f=a[N+1].dts-U.dts,j=a[N+1].pts-U.pts;else{const at=this.config,yt=N>0?U.dts-a[N-1].dts:S;if(j=N>0?U.pts-a[N-1].pts:S,at.stretchShortVideoTrack&&this.nextAudioPts!==null){const It=Math.floor(at.maxBufferHole*s),yi=(r?m+r*s:this.nextAudioPts)-U.pts;yi>It?(f=yi-yt,f<0?f=yt:b=!0,L.log(`[mp4-remuxer]: It is approximately ${yi/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=yt}else f=yt}const st=Math.round(U.pts-U.dts);$=Math.min($,f),M=Math.max(M,f),F=Math.min(F,j),w=Math.max(w,j),o.push(new sl(U.key,f,W,st))}if(o.length){if(We){if(We<70){const N=o[0].flags;N.dependsOn=2,N.isNonSync=0}}else if(Mr&&w-F<M-$&&S/M<.025&&o[0].cts===0){L.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let N=d;for(let U=0,X=o.length;U<X;U++){const W=N+o[U].duration,j=N+o[U].cts;if(U<X-1){const st=W+o[U+1].cts;o[U].duration=st-j}else o[U].duration=U?o[U-1].duration:S;o[U].cts=0,N=W}}}f=b||!f?S:f,this.nextAvcDts=u=g+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const q={data1:_.moof(t.sequenceNumber++,d,ft({},t,{samples:o})),data2:k,startPTS:m/s,endPTS:(p+f)/s,startDTS:d/s,endDTS:u/s,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:t.dropped};return t.samples=[],t.dropped=0,q}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return Gy;case"ac3":return Ky;default:return rl}}remuxAudio(t,e,i,r,s){const a=t.inputTimeScale,o=t.samplerate?t.samplerate:a,l=a/o,c=this.getSamplesPerFrame(t),u=c*l,h=this._initPTS,f=t.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],g=s!==void 0;let m=t.samples,p=f?0:8,v=this.nextAudioPts||-1;const x=e*a,T=h.baseTime*a/h.timescale;if(this.isAudioContiguous=i=i||m.length&&v>0&&(r&&Math.abs(x-v)<9e3||Math.abs(wt(m[0].pts-T,x)-v)<20*u),m.forEach(function(O){O.pts=wt(O.pts-T,x)}),!i||v<0){if(m=m.filter(O=>O.pts>=0),!m.length)return;s===0?v=0:r&&!g?v=Math.max(0,x):v=m[0].pts}if(t.segmentCodec==="aac"){const O=this.config.maxAudioFramesDrift;for(let V=0,q=v;V<m.length;V++){const N=m[V],U=N.pts,X=U-q,W=Math.abs(1e3*X/a);if(X<=-O*u&&g)V===0&&(L.warn(`Audio frame @ ${(U/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*X/a)} ms.`),this.nextAudioPts=v=q=U);else if(X>=O*u&&W<$y&&g){let j=Math.round(X/u);q=U-j*u,q<0&&(j--,q+=u),V===0&&(this.nextAudioPts=v=q),L.warn(`[mp4-remuxer]: Injecting ${j} audio frame @ ${(q/a).toFixed(3)}s due to ${Math.round(1e3*X/a)} ms gap.`);for(let st=0;st<j;st++){const at=Math.max(q,0);let yt=nl.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);yt||(L.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),yt=N.unit.subarray()),m.splice(V,0,{unit:yt,pts:at}),q+=u,V++}}N.pts=q,q+=u}}let S=null,E=null,R,A=0,C=m.length;for(;C--;)A+=m[C].unit.byteLength;for(let O=0,V=m.length;O<V;O++){const q=m[O],N=q.unit;let U=q.pts;if(E!==null){const W=d[O-1];W.duration=Math.round((U-E)/l)}else if(i&&t.segmentCodec==="aac"&&(U=v),S=U,A>0){A+=p;try{R=new Uint8Array(A)}catch(W){this.observer.emit(y.ERROR,y.ERROR,{type:Y.MUX_ERROR,details:D.REMUX_ALLOC_ERROR,fatal:!1,error:W,bytes:A,reason:`fail allocating audio mdat ${A}`});return}f||(new DataView(R.buffer).setUint32(0,A),R.set(_.types.mdat,4))}else return;R.set(N,p);const X=N.byteLength;p+=X,d.push(new sl(!0,c,X,0)),E=U}const k=d.length;if(!k)return;const I=d[d.length-1];this.nextAudioPts=v=E+l*I.duration;const b=f?new Uint8Array(0):_.moof(t.sequenceNumber++,S/l,ft({},t,{samples:d}));t.samples=[];const $=S/a,F=v/a,w={data1:b,data2:R,startPTS:$,endPTS:F,startDTS:$,endDTS:F,type:"audio",hasAudio:!0,hasVideo:!1,nb:k};return this.isAudioContiguous=!0,w}remuxEmptyAudio(t,e,i,r){const s=t.inputTimeScale,a=t.samplerate?t.samplerate:s,o=s/a,l=this.nextAudioPts,c=this._initDTS,u=c.baseTime*9e4/c.timescale,h=(l!==null?l:r.startDTS*s)+u,f=r.endDTS*s+u,d=o*rl,g=Math.ceil((f-h)/d),m=nl.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(L.warn("[mp4-remuxer]: remux empty Audio"),!m){L.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const p=[];for(let v=0;v<g;v++){const x=h+v*d;p.push({unit:m,pts:x,dts:x})}return t.samples=p,this.remuxAudio(t,e,i,!1)}}function wt(n,t){let e;if(t===null)return n;for(t<n?e=-8589934592:e=8589934592;Math.abs(n-t)>4294967296;)n+=e;return n}function Hy(n){for(let t=0;t<n.length;t++)if(n[t].key)return t;return-1}function bu(n,t,e,i){const r=n.samples.length;if(!r)return;const s=n.inputTimeScale;for(let o=0;o<r;o++){const l=n.samples[o];l.pts=wt(l.pts-e.baseTime*s/e.timescale,t*s)/s,l.dts=wt(l.dts-i.baseTime*s/i.timescale,t*s)/s}const a=n.samples;return n.samples=[],{samples:a}}function wu(n,t,e){const i=n.samples.length;if(!i)return;const r=n.inputTimeScale;for(let a=0;a<i;a++){const o=n.samples[a];o.pts=wt(o.pts-e.baseTime*r/e.timescale,t*r)/r}n.samples.sort((a,o)=>a.pts-o.pts);const s=n.samples;return n.samples=[],{samples:s}}class sl{constructor(t,e,i,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=i,this.cts=r,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}}}class Vy{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,i,r){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(jm(t,r)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(!(t!=null&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const r=this.initData=tu(t);r.audio&&(e=al(r.audio,tt.AUDIO)),r.video&&(i=al(r.video,tt.VIDEO));const s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:e+","+i,initSegment:t,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:r.video?s.video={container:"video/mp4",codec:i,initSegment:t,id:"main"}:L.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(t,e,i,r,s,a){var o,l;let{initPTS:c,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};B(u)||(u=this.lastEndTime=s||0);const f=e.samples;if(!(f!=null&&f.length))return h;const d={initPTS:void 0,timescale:1};let g=this.initData;if((o=g)!=null&&o.length||(this.generateInitSegment(f),g=this.initData),!((l=g)!=null&&l.length))return L.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const m=Jm(f,g),p=Qm(g,f),v=p===null?s:p;(Yy(c,v,s,m)||d.timescale!==c.timescale&&a)&&(d.initPTS=v-s,c&&c.timescale===1&&L.warn(`Adjusting initPTS by ${d.initPTS-c.baseTime}`),this.initPTS=c={baseTime:d.initPTS,timescale:1});const x=t?v-c.baseTime/c.timescale:u,T=x+m;tp(g,f,c.baseTime/c.timescale),m>0?this.lastEndTime=T:(L.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const S=!!g.audio,E=!!g.video;let R="";S&&(R+="audio"),E&&(R+="video");const A={data1:f,startPTS:x,startDTS:x,endPTS:T,endDTS:T,type:R,hasAudio:S,hasVideo:E,nb:1,dropped:0};return h.audio=A.type==="audio"?A:void 0,h.video=A.type!=="audio"?A:void 0,h.initSegment=d,h.id3=bu(i,s,c,c),r.samples.length&&(h.text=wu(r,s,c)),h}}function Yy(n,t,e,i){if(n===null)return!0;const r=Math.max(i,1),s=t-n.baseTime/n.timescale;return Math.abs(s-e)>r}function al(n,t){const e=n==null?void 0:n.codec;if(e&&e.length>4)return e;if(t===tt.AUDIO){if(e==="ec-3"||e==="ac-3"||e==="alac")return e;if(e==="fLaC"||e==="Opus")return zn(e,!1);const i="mp4a.40.5";return L.info(`Parsed audio codec "${e}" or audio object type not handled. Using "${i}"`),i}return L.warn(`Unhandled video codec "${e}"`),e==="hvc1"||e==="hev1"?"hvc1.1.6.L120.90":e==="av01"?"av01.0.04M.08":"avc1.42e01e"}let de;try{de=self.performance.now.bind(self.performance)}catch{L.debug("Unable to use Performance API on this environment"),de=li==null?void 0:li.Date.now}const An=[{demux:Dy,remux:Vy},{demux:Ee,remux:Sn},{demux:by,remux:Sn},{demux:Ny,remux:Sn}];An.splice(2,0,{demux:Cy,remux:Sn});class ol{constructor(t,e,i,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.vendor=r,this.id=s}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,i,r){const s=i.transmuxing;s.executeStart=de();let a=new Uint8Array(t);const{currentTransmuxState:o,transmuxConfig:l}=this;r&&(this.currentTransmuxState=r);const{contiguous:c,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:d,initSegmentChange:g}=r||o,{audioCodec:m,videoCodec:p,defaultInitPts:v,duration:x,initSegmentData:T}=l,S=Wy(a,e);if(S&&S.method==="AES-128"){const C=this.getDecrypter();if(C.isSync()){let k=C.softwareDecrypt(a,S.key.buffer,S.iv.buffer);if(i.part>-1&&(k=C.flush()),!k)return s.executeEnd=de(),Nr(i);a=new Uint8Array(k)}else return this.decryptionPromise=C.webCryptoDecrypt(a,S.key.buffer,S.iv.buffer).then(k=>{const I=this.push(k,null,i);return this.decryptionPromise=null,I}),this.decryptionPromise}const E=this.needsProbing(u,h);if(E){const C=this.configureTransmuxer(a);if(C)return L.warn(`[transmuxer] ${C.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,fatal:!1,error:C,reason:C.message}),s.executeEnd=de(),Nr(i)}(u||h||g||E)&&this.resetInitSegment(T,m,p,x,e),(u||g||E)&&this.resetInitialTimestamp(v),c||this.resetContiguity();const R=this.transmux(a,S,d,f,i),A=this.currentTransmuxState;return A.contiguous=!0,A.discontinuity=!1,A.trackSwitch=!1,s.executeEnd=de(),R}flush(t){const e=t.transmuxing;e.executeStart=de();const{decrypter:i,currentTransmuxState:r,decryptionPromise:s}=this;if(s)return s.then(()=>this.flush(t));const a=[],{timeOffset:o}=r;if(i){const h=i.flush();h&&a.push(this.push(h,null,t))}const{demuxer:l,remuxer:c}=this;if(!l||!c)return e.executeEnd=de(),[Nr(t)];const u=l.flush(o);return Ln(u)?u.then(h=>(this.flushRemux(a,h,t),a)):(this.flushRemux(a,u,t),a)}flushRemux(t,e,i){const{audioTrack:r,videoTrack:s,id3Track:a,textTrack:o}=e,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;L.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const u=this.remuxer.remux(r,s,a,o,c,l,!0,this.id);t.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=de()}resetInitialTimestamp(t){const{demuxer:e,remuxer:i}=this;!e||!i||(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;!t||!e||(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,r,s){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(t,e,i,r),o.resetInitSegment(t,e,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,r,s){let a;return e&&e.method==="SAMPLE-AES"?a=this.transmuxSampleAes(t,e,i,r,s):a=this.transmuxUnencrypted(t,i,r,s),a}transmuxUnencrypted(t,e,i,r){const{audioTrack:s,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,a,o,l,e,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(t,e,i,r,s){return this.demuxer.demuxSampleAes(t,e,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,r,!1,this.id),chunkMeta:s}))}configureTransmuxer(t){const{config:e,observer:i,typeSupported:r,vendor:s}=this;let a;for(let f=0,d=An.length;f<d;f++){var o;if((o=An[f].demux)!=null&&o.probe(t)){a=An[f];break}}if(!a)return new Error("Failed to find demuxer by probing fragment data");const l=this.demuxer,c=this.remuxer,u=a.remux,h=a.demux;(!c||!(c instanceof u))&&(this.remuxer=new u(i,e,r,s)),(!l||!(l instanceof h))&&(this.demuxer=new h(i,e,r),this.probe=h.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new ua(this.config)),t}}function Wy(n,t){let e=null;return n.byteLength>0&&(t==null?void 0:t.key)!=null&&t.iv!==null&&t.method!=null&&(e=t),e}const Nr=n=>({remuxResult:{},chunkMeta:n});function Ln(n){return"then"in n&&n.then instanceof Function}class qy{constructor(t,e,i,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=r,this.defaultInitPts=s||null}}class zy{constructor(t,e,i,r,s,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=a}}var Du={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function r(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new r(u,h||l,f),g=e?e+c:c;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],d]:l._events[g].push(d):(l._events[g]=d,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)t.call(u,h)&&c.push(e?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},o.prototype.listeners=function(c){var u=e?e+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,g=new Array(d);f<d;f++)g[f]=h[f].fn;return g},o.prototype.listenerCount=function(c){var u=e?e+c:c,h=this._events[u];return h?h.fn?1:h.length:0},o.prototype.emit=function(c,u,h,f,d,g){var m=e?e+c:c;if(!this._events[m])return!1;var p=this._events[m],v=arguments.length,x,T;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),v){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,u),!0;case 3:return p.fn.call(p.context,u,h),!0;case 4:return p.fn.call(p.context,u,h,f),!0;case 5:return p.fn.call(p.context,u,h,f,d),!0;case 6:return p.fn.call(p.context,u,h,f,d,g),!0}for(T=1,x=new Array(v-1);T<v;T++)x[T-1]=arguments[T];p.fn.apply(p.context,x)}else{var S=p.length,E;for(T=0;T<S;T++)switch(p[T].once&&this.removeListener(c,p[T].fn,void 0,!0),v){case 1:p[T].fn.call(p[T].context);break;case 2:p[T].fn.call(p[T].context,u);break;case 3:p[T].fn.call(p[T].context,u,h);break;case 4:p[T].fn.call(p[T].context,u,h,f);break;default:if(!x)for(E=1,x=new Array(v-1);E<v;E++)x[E-1]=arguments[E];p[T].fn.apply(p[T].context,x)}}return!0},o.prototype.on=function(c,u,h){return s(this,c,u,h,!1)},o.prototype.once=function(c,u,h){return s(this,c,u,h,!0)},o.prototype.removeListener=function(c,u,h,f){var d=e?e+c:c;if(!this._events[d])return this;if(!u)return a(this,d),this;var g=this._events[d];if(g.fn)g.fn===u&&(!f||g.once)&&(!h||g.context===h)&&a(this,d);else{for(var m=0,p=[],v=g.length;m<v;m++)(g[m].fn!==u||f&&!g[m].once||h&&g[m].context!==h)&&p.push(g[m]);p.length?this._events[d]=p.length===1?p[0]:p:a(this,d)}return this},o.prototype.removeAllListeners=function(c){var u;return c?(u=e?e+c:c,this._events[u]&&a(this,u)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=e,o.EventEmitter=o,n.exports=o})(Du);var Xy=Du.exports,pa=vm(Xy);class Cu{constructor(t,e,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=t.config;this.hls=t,this.id=e,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;const a=(c,u)=>{u=u||{},u.frag=this.frag,u.id=this.id,c===y.ERROR&&(this.error=u.error),this.hls.trigger(c,u)};this.observer=new pa,this.observer.on(y.FRAG_DECRYPTED,a),this.observer.on(y.ERROR,a);const o=Ne(s.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&typeof Worker<"u"&&(s.workerPath||gy())){try{s.workerPath?(L.log(`loading Web Worker ${s.workerPath} for "${e}"`),this.workerContext=py(s.workerPath)):(L.log(`injecting Web Worker for "${e}"`),this.workerContext=my()),this.onwmsg=h=>this.onWorkerMessage(h);const{worker:u}=this.workerContext;u.addEventListener("message",this.onwmsg),u.onerror=h=>{const f=new Error(`${h.message}  (${h.filename}:${h.lineno})`);s.enableWorker=!1,L.warn(`Error in "${e}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:Y.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:f})},u.postMessage({cmd:"init",typeSupported:l,vendor:"",id:e,config:JSON.stringify(s)})}catch(u){L.warn(`Error setting up "${e}" Web Worker, fallback to inline`,u),this.resetWorker(),this.error=null,this.transmuxer=new ol(this.observer,l,s,"",e)}return}this.transmuxer=new ol(this.observer,l,s,"",e)}resetWorker(){if(this.workerContext){const{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,i,r,s,a,o,l,c,u){var h,f;c.transmuxing.start=self.performance.now();const{transmuxer:d}=this,g=a?a.start:s.start,m=s.decryptdata,p=this.frag,v=!(p&&s.cc===p.cc),x=!(p&&c.level===p.level),T=p?c.sn-p.sn:-1,S=this.part?c.part-this.part.index:-1,E=T===0&&c.id>1&&c.id===(p==null?void 0:p.stats.chunkCount),R=!x&&(T===1||T===0&&(S===1||E&&S<=0)),A=self.performance.now();(x||T||s.stats.parsing.start===0)&&(s.stats.parsing.start=A),a&&(S||!R)&&(a.stats.parsing.start=A);const C=!(p&&((h=s.initSegment)==null?void 0:h.url)===((f=p.initSegment)==null?void 0:f.url)),k=new zy(v,R,l,x,g,C);if(!R||v||C){L.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${c.sn} p: ${c.part} level: ${c.level} id: ${c.id}
        discontinuity: ${v}
        trackSwitch: ${x}
        contiguous: ${R}
        accurateTimeOffset: ${l}
        timeOffset: ${g}
        initSegmentChange: ${C}`);const I=new qy(i,r,e,o,u);this.configureTransmuxer(I)}if(this.frag=s,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:m,chunkMeta:c,state:k},t instanceof ArrayBuffer?[t]:[]);else if(d){const I=d.push(t,m,c,k);Ln(I)?(d.async=!0,I.then(b=>{this.handleTransmuxComplete(b)}).catch(b=>{this.transmuxerError(b,c,"transmuxer-interface push error")})):(d.async=!1,this.handleTransmuxComplete(I))}}flush(t){t.transmuxing.start=self.performance.now();const{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let i=e.flush(t);Ln(i)||e.async?(Ln(i)||(i=Promise.resolve(i)),i.then(s=>{this.handleFlushResult(s,t)}).catch(s=>{this.transmuxerError(s,t,"transmuxer-interface flush error")})):this.handleFlushResult(i,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(e)}onWorkerMessage(t){const e=t.data;if(!(e!=null&&e.event)){L.warn(`worker message received with no ${e?"event name":"data"}`);return}const i=this.hls;if(this.hls)switch(e.event){case"init":{var r;const s=(r=this.workerContext)==null?void 0:r.objectURL;s&&self.URL.revokeObjectURL(s);break}case"transmuxComplete":{this.handleTransmuxComplete(e.data);break}case"flush":{this.onFlush(e.data);break}case"workerLog":L[e.data.logType]&&L[e.data.logType](e.data.message);break;default:{e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,i.trigger(e.event,e.data);break}}}configureTransmuxer(t){const{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}function ku(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!ui(n[e].attrs,t[e].attrs))return!1;return!0}function ui(n,t,e){const i=n["STABLE-RENDITION-ID"];return i&&!e?i===t["STABLE-RENDITION-ID"]:!(e||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(r=>n[r]!==t[r])}function Ps(n,t){return t.label.toLowerCase()===n.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(n.lang||"").toLowerCase())}const ll=100;class jy extends ha{constructor(t,e,i){super(t,e,i,"[audio-stream-controller]",H.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(y.ERROR,this.onError,this),t.on(y.BUFFER_RESET,this.onBufferReset,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(y.ERROR,this.onError,this),t.off(y.BUFFER_RESET,this.onBufferReset,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){if(i==="main"){const a=e.cc;this.initPTS[e.cc]={baseTime:r,timescale:s},this.log(`InitPTS for cc: ${a} found from main: ${r}`),this.videoTrackCC=a,this.state===P.WAITING_INIT_PTS&&this.tick()}}startLoad(t){if(!this.levels){this.startPosition=t,this.state=P.STOPPED;return}const e=this.lastCurrentTime;this.stopLoad(),this.setInterval(ll),e>0&&t===-1?(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e,this.state=P.IDLE):(this.loadedmetadata=!1,this.state=P.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}doTick(){switch(this.state){case P.IDLE:this.doTickIdle();break;case P.WAITING_TRACK:{var t;const{levels:i,trackId:r}=this,s=i==null||(t=i[r])==null?void 0:t.details;if(s){if(this.waitForCdnTuneIn(s))break;this.state=P.WAITING_INIT_PTS}break}case P.FRAG_LOADING_WAITING_RETRY:{var e;const i=performance.now(),r=this.retryDate;if(!r||i>=r||(e=this.media)!=null&&e.seeking){const{levels:s,trackId:a}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((s==null?void 0:s[a])||null),this.state=P.IDLE}break}case P.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:r,part:s,cache:a,complete:o}=i;if(this.initPTS[r.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=P.FRAG_LOADING;const l=a.flush(),c={frag:r,part:s,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),o&&super._handleFragmentLoadComplete(c)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${r.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const l=this.getLoadPosition(),c=nt.bufferInfo(this.mediaBuffer,l,this.config.maxBufferHole);Cs(c.end,this.config.maxFragLookUpTolerance,r)<0&&(this.log(`Waiting fragment cc (${r.cc}) @ ${r.start} cancelled because another fragment at ${c.end} is needed`),this.clearWaitingFragment())}}else this.state=P.IDLE}}this.onTickEnd()}clearWaitingFragment(){const t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=P.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:t}=this;t!=null&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){const{hls:t,levels:e,media:i,trackId:r}=this,s=t.config;if(!i&&(this.startFragRequested||!s.startFragPrefetch)||!(e!=null&&e[r]))return;const a=e[r],o=a.details;if(!o||o.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(o)){this.state=P.WAITING_TRACK;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,tt.AUDIO,H.AUDIO));const c=this.getFwdBufferInfo(l,H.AUDIO);if(c===null)return;const{bufferedTrack:u,switchingTrack:h}=this;if(!h&&this._streamEnded(c,o)){t.trigger(y.BUFFER_EOS,{type:"audio"}),this.state=P.ENDED;return}const f=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,H.MAIN),d=c.len,g=this.getMaxBufferLength(f==null?void 0:f.len),m=o.fragments,p=m[0].start;let v=this.flushing?this.getLoadPosition():c.end;if(h&&i){const E=this.getLoadPosition();u&&!ui(h.attrs,u.attrs)&&(v=E),o.PTSKnown&&E<p&&(c.end>p||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=p+.05)}if(d>=g&&!h&&v<m[m.length-1].start)return;let x=this.getNextFragment(v,o),T=!1;if(x&&this.isLoopLoading(x,v)&&(T=!!x.gap,x=this.getNextFragmentLoopLoading(x,o,c,H.MAIN,g)),!x){this.bufferFlushed=!0;return}const S=f&&x.start>f.end+o.targetduration;if(S||!(f!=null&&f.len)&&c.len){const E=this.getAppendedFrag(x.start,H.MAIN);if(E===null||(T||(T=!!E.gap||!!S&&f.len===0),S&&!T||T&&c.nextStart&&c.nextStart<E.end))return}this.loadFragment(x,a,v)}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.min(Math.max(e,t),this.config.maxMaxBufferLength):e}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map(i=>new ci(i))}onAudioTrackSwitching(t,e){const i=!!e.url;this.trackId=e.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?this.setInterval(ll):this.resetTransmuxer(),i?(this.switchingTrack=e,this.state=P.IDLE,this.flushAudioIfNeeded(e)):(this.switchingTrack=null,this.bufferedTrack=e,this.state=P.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(t,e){this.mainDetails=e.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(y.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(t,e){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=e;return}const{levels:r}=this,{details:s,id:a}=e;if(!r){this.warn(`Audio tracks were reset while loading level ${a}`);return}this.log(`Audio track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const o=r[a];let l=0;if(s.live||(i=o.details)!=null&&i.live){this.checkLiveUpdate(s);const u=this.mainDetails;if(s.deltaUpdateFailed||!u)return;if(!o.details&&s.hasProgramDateTime&&u.hasProgramDateTime)Zn(s,u),l=s.fragments[0].start;else{var c;l=this.alignPlaylists(s,o.details,(c=this.levelLastLoaded)==null?void 0:c.details)}}o.details=s,this.levelLastLoaded=o,!this.startFragRequested&&(this.mainDetails||!s.live)&&this.setStartPosition(this.mainDetails||s,l),this.state===P.WAITING_TRACK&&!this.waitForCdnTuneIn(s)&&(this.state=P.IDLE),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new Cu(this.hls,H.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[i.cc],g=(e=i.initSegment)==null?void 0:e.data;if(d!==void 0){const p=r?r.index:-1,v=p!==-1,x=new ca(i.level,i.sn,i.stats.chunkCount,s.byteLength,p,v);f.push(s,g,h,"",i,r,u.totalduration,!1,x,d)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${o}`);const{cache:m}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new mu,complete:!1};m.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=P.WAITING_INIT_PTS}}_handleFragmentLoadComplete(t){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(t,e){const i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),e.tracks.video&&(this.videoBuffer=e.tracks.video.buffer||null)}onFragBuffered(t,e){const{frag:i,part:r}=e;if(i.type!==H.AUDIO){if(!this.loadedmetadata&&i.type===H.MAIN){const s=this.videoBuffer||this.media;s&&nt.getBuffered(s).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const s=this.switchingTrack;s&&(this.bufferedTrack=s,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,pt({},s)))}this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal){this.state=P.ERROR;return}switch(e.details){case D.FRAG_GAP:case D.FRAG_PARSING_ERROR:case D.FRAG_DECRYPT_ERROR:case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(H.AUDIO,e);break;case D.AUDIO_TRACK_LOAD_ERROR:case D.AUDIO_TRACK_LOAD_TIMEOUT:case D.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===P.WAITING_TRACK&&((i=e.context)==null?void 0:i.type)===Q.AUDIO_TRACK&&(this.state=P.IDLE);break;case D.BUFFER_APPEND_ERROR:case D.BUFFER_FULL_ERROR:if(!e.parent||e.parent!=="audio")return;if(e.details===D.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case D.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}onBufferFlushing(t,{type:e}){e!==tt.VIDEO&&(this.flushing=!0)}onBufferFlushed(t,{type:e}){if(e!==tt.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===P.ENDED&&(this.state=P.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,e,H.AUDIO),this.tick())}}_handleTransmuxComplete(t){var e;const i="audio",{hls:r}=this,{remuxResult:s,chunkMeta:a}=t,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{details:h}=u,{audio:f,text:d,id3:g,initSegment:m}=s;if(this.fragContextChanged(l)||!h){this.fragmentTracker.removeFragment(l);return}if(this.state=P.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){const p=l.initSegment||l;this._bufferInitSegment(u,m.tracks,p,a),r.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:i,tracks:m.tracks})}if(f){const{startPTS:p,endPTS:v,startDTS:x,endDTS:T}=f;c&&(c.elementaryStreams[tt.AUDIO]={startPTS:p,endPTS:v,startDTS:x,endDTS:T}),l.setElementaryStreamInfo(tt.AUDIO,p,v,x,T),this.bufferFragmentData(f,l,c,a)}if(g!=null&&(e=g.samples)!=null&&e.length){const p=ft({id:i,frag:l,details:h},g);r.trigger(y.FRAG_PARSING_METADATA,p)}if(d){const p=ft({id:i,frag:l,details:h},d);r.trigger(y.FRAG_PARSING_USERDATA,p)}}_bufferInitSegment(t,e,i,r){if(this.state!==P.PARSING)return;e.video&&delete e.video;const s=e.audio;if(!s)return;s.id="audio";const a=t.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${a}/${s.codec}]`),a&&a.split(",").length===1&&(s.levelCodec=a),this.hls.trigger(y.BUFFER_CODECS,e);const o=s.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:r,parent:i.type,data:o};this.hls.trigger(y.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);if(this.fragCurrent=t,this.switchingTrack||r===mt.NOT_LOADED||r===mt.PARTIAL){var s;if(t.sn==="initSegment")this._loadInitSegment(t,e);else if((s=e.details)!=null&&s.live&&!this.initPTS[t.cc]){this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=P.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragments[0].start!==e.details.fragments[0].start&&Zn(e.details,a)}else this.startFragRequested=!0,super.loadFragment(t,e,i)}else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){const{media:e,bufferedTrack:i}=this,r=i==null?void 0:i.attrs,s=t.attrs;e&&r&&(r.CHANNELS!==s.CHANNELS||i.name!==t.name||i.lang!==t.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(t){const{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(y.AUDIO_TRACK_SWITCHED,pt({},t))}}class Qy extends la{constructor(t){super(t,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(y.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){const{id:i,groupId:r,details:s}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==r){this.warn(`Audio track with id:${i} and group:${r} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=e.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,o)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.audioGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(r==null?void 0:r.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(r==null?void 0:r.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(f=>f.default)&&(this.selectDefaultTrack=!1),o.forEach((f,d)=>{f.id=d});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!s&&l){const f=Qt(l,o,He);if(f>-1)s=o[f];else{const d=Qt(l,this.tracks);s=this.tracks[d]}}let c=this.findTrackId(s);c===-1&&s&&(c=this.findTrackId(null));const u={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(c!==-1&&h===-1)this.setAudioTrack(c);else if(o.length&&h===-1){var a;const f=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(f.message),this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}else this.shouldReloadPlaylist(s)&&this.setAudioTrack(this.trackId)}onError(t,e){e.fatal||!e.context||e.context.type===Q.AUDIO_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&(this.requestScheduled=-1,this.checkRetry(e))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){const e=this.hls;if(e.config.audioPreference=t,t){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const r=this.currentTrack;if(r&&ti(t,r,He))return r;const s=Qt(t,this.tracksInGroup,He);if(s>-1){const a=this.tracksInGroup[s];return this.setAudioTrack(s),a}else if(r){let a=e.loadLevel;a===-1&&(a=e.firstAutoLevel);const o=Qp(t,e.levels,i,a,He);if(o===-1)return null;e.nextLoadLevel=o}if(t.channels||t.audioCodec){const a=Qt(t,i);if(a>-1)return i[a]}}}return null}setAudioTrack(t){const e=this.tracksInGroup;if(t<0||t>=e.length){this.warn(`Invalid audio track id: ${t}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=e[t],s=r.details&&!r.details.live;if(t===this.trackId&&r===i&&s||(this.log(`Switching to audio-track ${t} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=t,this.currentTrack=r,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,pt({},r)),s))return;const a=this.switchParams(r.url,i==null?void 0:i.details,r.details);this.loadPlaylist(a)}findTrackId(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const r=e[i];if(!(this.selectDefaultTrack&&!r.default)&&(!t||ti(t,r,He)))return i}if(t){const{name:i,lang:r,assocLang:s,characteristics:a,audioCodec:o,channels:l}=t;for(let c=0;c<e.length;c++){const u=e[c];if(ti({name:i,lang:r,assocLang:s,characteristics:a,audioCodec:o,channels:l},u,He))return c}for(let c=0;c<e.length;c++){const u=e[c];if(ui(t.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<e.length;c++){const u=e[c];if(ui(t.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(t){const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){super.loadPlaylist();const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`loading audio-track playlist ${i} "${e.name}" lang:${e.lang} group:${r}`),this.clearTimer(),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}}const cl=500;class Jy extends ha{constructor(t,e,i){super(t,e,i,"[subtitle-stream-controller]",H.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.ERROR,this.onError,this),t.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.ERROR,this.onError,this),t.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(t){this.stopLoad(),this.state=P.IDLE,this.setInterval(cl),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){const{frag:i,success:r}=e;if(this.fragPrevious=i,this.state=P.IDLE,!r)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let a;const o=i.start;for(let c=0;c<s.length;c++)if(o>=s[c].start&&o<=s[c].end){a=s[c];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},s.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(t,e){const{startOffset:i,endOffset:r}=e;if(i===0&&r!==Number.POSITIVE_INFINITY){const s=r-1;if(s<=0)return;e.endOffsetSubtitles=Math.max(0,s),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=s){a.shift();continue}else if(a[o].start<s)a[o].start=s;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,s,H.SUBTITLE)}}onFragBuffered(t,e){if(!this.loadedmetadata&&e.frag.type===H.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(t,e){const i=e.frag;(i==null?void 0:i.type)===H.SUBTITLE&&(e.details===D.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==P.STOPPED&&(this.state=P.IDLE))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){if(this.levels&&ku(this.levels,e)){this.levels=e.map(i=>new ci(i));return}this.tracksBuffered=[],this.levels=e.map(i=>{const r=new ci(i);return this.tracksBuffered[r.id]=[],r}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,H.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(t,e){var i;if(this.currentTrackId=e.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const r=this.levels[this.currentTrackId];r!=null&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(cl)}onSubtitleTrackLoaded(t,e){var i;const{currentTrackId:r,levels:s}=this,{details:a,id:o}=e;if(!s){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=s[o];if(o>=s.length||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(i=l.details)!=null&&i.live){const h=this.mainDetails;if(a.deltaUpdateFailed||!h)return;const f=h.fragments[0];if(!l.details)a.hasProgramDateTime&&h.hasProgramDateTime?(Zn(a,h),c=a.fragments[0].start):f&&(c=f.start,Ds(a,c));else{var u;c=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,Ds(a,c))}}l.details=a,this.levelLastLoaded=l,o===r&&(!this.startFragRequested&&(this.mainDetails||!a.live)&&this.setStartPosition(this.mainDetails||a,c),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===P.IDLE&&(Jn(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(t){const{frag:e,payload:i}=t,r=e.decryptdata,s=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&r!=null&&r.key&&r.iv&&r.method==="AES-128"){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch(o=>{throw s.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:e}),o}).then(o=>{const l=performance.now();s.trigger(y.FRAG_DECRYPTED,{frag:e,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=P.IDLE})}}doTick(){if(!this.media){this.state=P.IDLE;return}if(this.state===P.IDLE){const{currentTrackId:t,levels:e}=this,i=e==null?void 0:e[t];if(!i||!e.length||!i.details)return;const{config:r}=this,s=this.getLoadPosition(),a=nt.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,r.maxBufferHole),{end:o,len:l}=a,c=this.getFwdBufferInfo(this.media,H.MAIN),u=i.details,h=this.getMaxBufferLength(c==null?void 0:c.len)+u.levelTargetDuration;if(l>h)return;const f=u.fragments,d=f.length,g=u.edge;let m=null;const p=this.fragPrevious;if(o<g){const v=r.maxFragLookUpTolerance,x=o>g-v?0:v;m=Jn(p,f,Math.max(f[0].start,o),x),!m&&p&&p.start<f[0].start&&(m=f[0])}else m=f[d-1];if(!m)return;if(m=this.mapToInitFragWhenRequired(m),m.sn!=="initSegment"){const v=m.sn-u.startSN,x=f[v-1];x&&x.cc===m.cc&&this.fragmentTracker.getState(x)===mt.NOT_LOADED&&(m=x)}this.fragmentTracker.getState(m)===mt.NOT_LOADED&&this.loadFragment(m,i,o)}}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.max(e,t):e}loadFragment(t,e,i){this.fragCurrent=t,t.sn==="initSegment"?this._loadInitSegment(t,e):(this.startFragRequested=!0,super.loadFragment(t,e,i))}get mediaBufferTimeRanges(){return new Zy(this.tracksBuffered[this.currentTrackId]||[])}}class Zy{constructor(t){this.buffered=void 0;const e=(i,r,s)=>{if(r=r>>>0,r>s-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${r}) is greater than the maximum bound (${s})`);return t[r][i]};this.buffered={get length(){return t.length},end(i){return e("end",i,t.length)},start(i){return e("start",i,t.length)}}}}class tv extends la{constructor(t){super(t,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const i=En(this.media.textTracks);for(let s=0;s<i.length;s++)if(i[s].mode==="hidden")e=i[s];else if(i[s].mode==="showing"){e=i[s];break}const r=this.findTrackForTextTrack(e);this.subtitleTrack!==r&&this.setSubtitleTrack(r)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(y.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),En(this.media.textTracks).forEach(e=>{Qe(e)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){const{id:i,groupId:r,details:s}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==r){this.warn(`Subtitle track with id:${i} and group:${r} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=e.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,o)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.subtitleGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(r==null?void 0:r.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(r==null?void 0:r.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,h)=>{u.id=h});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!s&&o){this.selectDefaultTrack=!1;const u=Qt(o,a);if(u>-1)s=a[u];else{const h=Qt(o,this.tracks);s=this.tracks[h]}}let l=this.findTrackId(s);l===-1&&s&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId)}findTrackId(t){const e=this.tracksInGroup,i=this.selectDefaultTrack;for(let r=0;r<e.length;r++){const s=e[r];if(!(i&&!s.default||!i&&!t)&&(!t||ti(s,t)))return r}if(t){for(let r=0;r<e.length;r++){const s=e[r];if(ui(t.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return r}for(let r=0;r<e.length;r++){const s=e[r];if(ui(t.attrs,s.attrs,["LANGUAGE"]))return r}}return-1}findTrackForTextTrack(t){if(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const r=e[i];if(Ps(r,t))return i}}return-1}onError(t,e){e.fatal||!e.context||e.context.type===Q.SUBTITLE_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&this.checkRetry(e)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){const e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){const i=this.currentTrack;if(i&&ti(t,i))return i;const r=Qt(t,this.tracksInGroup);if(r>-1){const s=this.tracksInGroup[r];return this.setSubtitleTrack(r),s}else{if(i)return null;{const s=Qt(t,e);if(s>-1)return e[s]}}}}return null}loadPlaylist(t){super.loadPlaylist();const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}toggleTrackModes(){const{media:t}=this;if(!t)return;const e=En(t.textTracks),i=this.currentTrack;let r;if(i&&(r=e.filter(s=>Ps(i,s))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(e).forEach(s=>{s.mode!=="disabled"&&s!==r&&(s.mode="disabled")}),r){const s=this.subtitleDisplay?"showing":"hidden";r.mode!==s&&(r.mode=s)}}setSubtitleTrack(t){const e=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=e.length||!B(t)){this.warn(`Invalid subtitle track id: ${t}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=e[t]||null;if(this.trackId=t,this.currentTrack=r,this.toggleTrackModes(),!r){this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:t});return}const s=!!r.details&&!r.details.live;if(t===this.trackId&&r===i&&s)return;this.log(`Switching to subtitle-track ${t}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:u}=r;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:u});const h=this.switchParams(r.url,i==null?void 0:i.details,r.details);this.loadPlaylist(h)}}class ev{constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}append(t,e,i){const r=this.queues[e];r.push(t),r.length===1&&!i&&this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;const i=new Promise(s=>{e=s}),r={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,t),i}executeNext(t){const e=this.queues[t];if(e.length){const i=e[0];try{i.execute()}catch(r){L.warn(`[buffer-operation-queue]: Exception executing "${t}" SourceBuffer operation: ${r}`),i.onError(r);const s=this.buffers[t];s!=null&&s.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}}const ul=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class iv{constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=i=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:i,mediaSource:r}=this;this.log("Media source opened"),i&&(i.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:i,mediaSource:r})),r&&r.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:r}=this;i!==r&&L.error(`Media element src was set while attaching MediaSource (${r} > ${i})`)},this.hls=t;const e="[buffer-controller]";this.appendSource=hp(Ne(t.config.preferManagedMediaSource)),this.log=L.log.bind(L,e),this.warn=L.warn.bind(L,e),this.error=L.error.bind(L,e),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.BUFFER_RESET,this.onBufferReset,this),t.on(y.BUFFER_APPENDING,this.onBufferAppending,this),t.on(y.BUFFER_CODECS,this.onBufferCodecs,this),t.on(y.BUFFER_EOS,this.onBufferEos,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(y.FRAG_PARSED,this.onFragParsed,this),t.on(y.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.BUFFER_RESET,this.onBufferReset,this),t.off(y.BUFFER_APPENDING,this.onBufferAppending,this),t.off(y.BUFFER_CODECS,this.onBufferCodecs,this),t.off(y.BUFFER_EOS,this.onBufferEos,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(y.FRAG_PARSED,this.onFragParsed,this),t.off(y.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new ev(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){let i=2;(e.audio&&!e.video||!e.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(t,e){const i=this.media=e.media,r=Ne(this.appendSource);if(i&&r){var s;const a=this.mediaSource=new r;this.log(`created media source: ${(s=a.constructor)==null?void 0:s.name}`),a.addEventListener("sourceopen",this._onMediaSourceOpen),a.addEventListener("sourceended",this._onMediaSourceEnded),a.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(a.addEventListener("startstreaming",this._onStartStreaming),a.addEventListener("endstreaming",this._onEndStreaming));const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,hl(i),nv(i,o),i.load()}catch{i.src=o}else i.src=o;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:t,mediaSource:e,_objectUrl:i}=this;if(e){if(this.log("media source detaching"),e.readyState==="open")try{e.endOfStream()}catch(r){this.warn(`onMediaDetaching: ${r.message} while calling endOfStream`)}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.removeEventListener("startstreaming",this._onStartStreaming),e.removeEventListener("endstreaming",this._onEndStreaming)),t&&(t.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(t.removeAttribute("src"),this.appendSource&&hl(t),t.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(y.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(t=>{this.resetBuffer(t)}),this._initSourceBuffer()}resetBuffer(t){const e=this.sourceBuffer[t];try{if(e){var i;this.removeBufferListeners(t),this.sourceBuffer[t]=void 0,(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(e)}}catch(r){this.warn(`onBufferReset ${t}`,r)}}onBufferCodecs(t,e){const i=this.getSourceBufferTypes().length,r=Object.keys(e);if(r.forEach(a=>{if(i){const l=this.tracks[a];if(l&&typeof l.buffer.changeType=="function"){var o;const{id:c,codec:u,levelCodec:h,container:f,metadata:d}=e[a],g=ko(l.codec,l.levelCodec),m=g==null?void 0:g.replace(ul,"$1");let p=ko(u,h);const v=(o=p)==null?void 0:o.replace(ul,"$1");if(p&&m!==v){a.slice(0,5)==="audio"&&(p=zn(p,this.appendSource));const x=`${f};codecs=${p}`;this.appendChangeType(a,x),this.log(`switching codec ${g} to ${p}`),this.tracks[a]={buffer:l.buffer,codec:u,container:f,levelCodec:h,metadata:d,id:c}}}}else this.pendingTracks[a]=e[a]}),i)return;const s=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==s&&(this.log(`${s} bufferCodec event(s) expected ${r.join(",")}`),this.bufferCodecEventsExpected=s),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(t,e){const{operationQueue:i}=this,r={execute:()=>{const s=this.sourceBuffer[t];s&&(this.log(`changing ${t} sourceBuffer type to ${e}`),s.changeType(e)),i.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:s=>{this.warn(`Failed to change ${t} SourceBuffer type`,s)}};i.append(r,t,!!this.pendingTracks[t])}onBufferAppending(t,e){const{hls:i,operationQueue:r,tracks:s}=this,{data:a,type:o,frag:l,part:c,chunkMeta:u}=e,h=u.buffering[o],f=self.performance.now();h.start=f;const d=l.stats.buffering,g=c?c.stats.buffering:null;d.start===0&&(d.start=f),g&&g.start===0&&(g.start=f);const m=s.audio;let p=!1;o==="audio"&&(m==null?void 0:m.container)==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||u.id===1||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);const v=l.start,x={execute:()=>{if(h.executeStart=self.performance.now(),p){const T=this.sourceBuffer[o];if(T){const S=v-T.timestampOffset;Math.abs(S)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${v} (delta: ${S}) sn: ${l.sn})`),T.timestampOffset=v)}}this.appendExecutor(a,o)},onStart:()=>{},onComplete:()=>{const T=self.performance.now();h.executeEnd=h.end=T,d.first===0&&(d.first=T),g&&g.first===0&&(g.first=T);const{sourceBuffer:S}=this,E={};for(const R in S)E[R]=nt.getBuffered(S[R]);this.appendErrors[o]=0,o==="audio"||o==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:o,frag:l,part:c,chunkMeta:u,parent:l.type,timeRanges:E})},onError:T=>{const S={type:Y.MEDIA_ERROR,parent:l.type,details:D.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:l,part:c,chunkMeta:u,error:T,err:T,fatal:!1};if(T.code===DOMException.QUOTA_EXCEEDED_ERR)S.details=D.BUFFER_FULL_ERROR;else{const E=++this.appendErrors[o];S.details=D.BUFFER_APPEND_ERROR,this.warn(`Failed ${E}/${i.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),E>=i.config.appendErrorMaxRetry&&(S.fatal=!0)}i.trigger(y.ERROR,S)}};r.append(x,o,!!this.pendingTracks[o])}onBufferFlushing(t,e){const{operationQueue:i}=this,r=s=>({execute:this.removeExecutor.bind(this,s,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:s})},onError:a=>{this.warn(`Failed to remove from ${s} SourceBuffer`,a)}});e.type?i.append(r(e.type),e.type):this.getSourceBufferTypes().forEach(s=>{i.append(r(s),s)})}onFragParsed(t,e){const{frag:i,part:r}=e,s=[],a=r?r.elementaryStreams:i.elementaryStreams;a[tt.AUDIOVIDEO]?s.push("audiovideo"):(a[tt.AUDIO]&&s.push("audio"),a[tt.VIDEO]&&s.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,r&&(r.stats.buffering.end=l);const c=r?r.stats:i.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:i,part:r,stats:c,id:i.type})};s.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,s)}onFragChanged(t,e){this.trimBuffers()}onBufferEos(t,e){this.getSourceBufferTypes().reduce((r,s)=>{const a=this.sourceBuffer[s];return a&&(!e.type||e.type===s)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${s} sourceBuffer now EOS`))),r&&!!(!a||a.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(s=>{const a=this.sourceBuffer[s];a&&(a.ending=!1)});const{mediaSource:r}=this;if(!r||r.readyState!=="open"){r&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${r.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),r.endOfStream()}))}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:t,details:e,media:i}=this;if(!i||e===null||!this.getSourceBufferTypes().length)return;const s=t.config,a=i.currentTime,o=e.levelTargetDuration,l=e.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(B(l)&&l>0){const c=Math.max(l,o),u=Math.floor(a/o)*o-c;this.flushBackBuffer(a,o,u)}if(B(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){const c=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),u=Math.max(c,o),h=Math.floor(a/o)*o+u;this.flushFrontBuffer(a,o,h)}}flushBackBuffer(t,e,i){const{details:r,sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(o=>{const l=s[o];if(l){const c=nt.getBuffered(l);if(c.length>0&&i>c.start(0)){if(this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:i}),r!=null&&r.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l.ended&&c.end(c.length-1)-t<e*2){this.log(`Cannot flush ${o} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:o})}}})}flushFrontBuffer(t,e,i){const{sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(a=>{const o=r[a];if(o){const l=nt.getBuffered(o),c=l.length;if(c<2)return;const u=l.start(c-1),h=l.end(c-1);if(i>u||t>=u&&t<=h)return;if(o.ended&&t-h<2*e){this.log(`Cannot flush ${a} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:u,endOffset:1/0,type:a})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:t,hls:e,media:i,mediaSource:r}=this,s=t.fragments[0].start+t.totalduration,a=i.duration,o=B(r.duration)?r.duration:0;t.live&&e.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(t)):(s>o&&s>a||!B(a))&&(this.log(`Updating Media Source duration to ${s.toFixed(3)}`),r.duration=s)}updateSeekableRange(t){const e=this.mediaSource,i=t.fragments;if(i.length&&t.live&&e!=null&&e.setLiveSeekableRange){const s=Math.max(0,i[0].start),a=Math.max(s,s+t.totalduration);this.log(`Media Source duration is set to ${e.duration}. Setting seekable range to ${s}-${a}.`),e.setLiveSeekableRange(s,a)}}checkPendingTracks(){const{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:i}=this,r=Object.keys(i).length;if(r&&(!t||r===2||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const s=this.getSourceBufferTypes();if(s.length)this.hls.trigger(y.BUFFER_CREATED,{tracks:this.tracks}),s.forEach(a=>{e.executeNext(a)});else{const a=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}}}createSourceBuffers(t){const{sourceBuffer:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const s in t)if(!e[s]){var r;const a=t[s];if(!a)throw Error(`source buffer exists for track ${s}, however track does not`);let o=((r=a.levelCodec)==null?void 0:r.indexOf(","))===-1?a.levelCodec:a.codec;o&&s.slice(0,5)==="audio"&&(o=zn(o,this.appendSource));const l=`${a.container};codecs=${o}`;this.log(`creating sourceBuffer(${l})`);try{const c=e[s]=i.addSourceBuffer(l),u=s;this.addBufferListener(u,"updatestart",this._onSBUpdateStart),this.addBufferListener(u,"updateend",this._onSBUpdateEnd),this.addBufferListener(u,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(u,"bufferedchange",(h,f)=>{const d=f.removedRanges;d!=null&&d.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:s})}),this.tracks[s]={buffer:c,codec:o,container:a.container,levelCodec:a.levelCodec,metadata:a.metadata,id:a.id}}catch(c){this.error(`error while trying to add sourceBuffer: ${c.message}`),this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:c,sourceBufferName:s,mimeType:l})}}}get mediaSrc(){var t,e;const i=((t=this.media)==null||(e=t.querySelector)==null?void 0:e.call(t,"source"))||this.media;return i==null?void 0:i.src}_onSBUpdateStart(t){const{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){var e;if(((e=this.mediaSource)==null?void 0:e.readyState)==="closed"){this.resetBuffer(t);return}const{operationQueue:i}=this;i.current(t).onComplete(),i.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){var i;const r=new Error(`${t} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${r}`,e),this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:r,fatal:!1});const s=this.operationQueue.current(t);s&&s.onError(r)}removeExecutor(t,e,i){const{media:r,mediaSource:s,operationQueue:a,sourceBuffer:o}=this,l=o[t];if(!r||!s||!l){this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),a.shiftAndExecuteNext(t);return}const c=B(r.duration)?r.duration:1/0,u=B(s.duration)?s.duration:1/0,h=Math.max(0,e),f=Math.min(i,c,u);f>h&&(!l.ending||l.ended)?(l.ended=!1,this.log(`Removing [${h},${f}] from the ${t} SourceBuffer`),l.remove(h,f)):a.shiftAndExecuteNext(t)}appendExecutor(t,e){const i=this.sourceBuffer[e];if(!i){if(!this.pendingTracks[e])throw new Error(`Attempting to append to the ${e} SourceBuffer, but it does not exist`);return}i.ended=!1,i.appendBuffer(t)}blockBuffers(t,e=this.getSourceBufferTypes()){if(!e.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);return}const{operationQueue:i}=this,r=e.map(s=>i.appendBlocker(s));Promise.all(r).then(()=>{t(),e.forEach(s=>{const a=this.sourceBuffer[s];a!=null&&a.updating||i.shiftAndExecuteNext(s)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,i){const r=this.sourceBuffer[t];if(!r)return;const s=i.bind(this,t);this.listeners[t].push({event:e,listener:s}),r.addEventListener(e,s)}removeBufferListeners(t){const e=this.sourceBuffer[t];e&&this.listeners[t].forEach(i=>{e.removeEventListener(i.event,i.listener)})}}function hl(n){const t=n.querySelectorAll("source");[].slice.call(t).forEach(e=>{n.removeChild(e)})}function nv(n,t){const e=self.document.createElement("source");e.type="video/mp4",e.src=t,n.appendChild(e)}const rv={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Pu=n=>String.fromCharCode(rv[n]||n),Nt=15,he=100,sv={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},av={17:2,18:4,21:6,22:8,23:10,19:13,20:15},ov={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},lv={25:2,26:4,29:6,30:8,31:10,27:13,28:15},cv=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class uv{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){const i=typeof e=="function"?e():e;L.log(`${this.time} [${t}] ${i}`)}}}const _e=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].toString(16));return e};class Fu{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){const e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){const r=e[i];t.hasOwnProperty(r)&&(this[r]=t[r])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class hv{constructor(){this.uchar=" ",this.penState=new Fu}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class fv{constructor(t){this.chars=[],this.pos=0,this.currPenState=new Fu,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<he;e++)this.chars.push(new hv);this.logger=t}equals(t){for(let e=0;e<he;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<he;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<he;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>he&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=he)}moveCursor(t){const e=this.pos+t;if(t>1)for(let i=this.pos+1;i<e+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();const e=Pu(t);if(this.pos>=he){this.logger.log(0,()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1)}clearFromPos(t){let e;for(e=t;e<he;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let e=!0;for(let i=0;i<he;i++){const r=this.chars[i].uchar;r!==" "&&(e=!1),t.push(r)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}}class Ur{constructor(t){this.rows=[],this.currRow=Nt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<Nt;e++)this.rows.push(new fv(t));this.logger=t}reset(){for(let t=0;t<Nt;t++)this.rows[t].clear();this.currRow=Nt-1}equals(t){let e=!0;for(let i=0;i<Nt;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<Nt;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<Nt;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,()=>"pacData = "+JSON.stringify(t));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let o=0;o<Nt;o++)this.rows[o].clear();const s=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[s].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[e-this.nrRollUpRows+c+1].copy(a.rows[s+c])}}this.currRow=e;const i=this.rows[this.currRow];if(t.indent!==null){const s=t.indent,a=Math.max(s-1,0);i.setCursor(t.indent),t.color=i.chars[a].penState.foreground}const r={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(t){this.logger.log(2,()=>"bkgData = "+JSON.stringify(t)),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;const e=[];let i="",r=-1;for(let s=0;s<Nt;s++){const a=this.rows[s].getTextString();a&&(r=s+1,t?e.push("Row "+r+": '"+a+"'"):e.push(a.trim()))}return e.length>0&&(t?i="["+e.join(" | ")+"]":i=e.join(`
`)),i}getTextAndFormat(){return this.rows}}class fl{constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new Ur(i),this.nonDisplayedMemory=new Ur(i),this.lastOutputScreen=new Ur(i),this.currRollUpRow=this.displayedMemory.rows[Nt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Nt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,()=>"MODE="+t),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let i=0;i<t.length;i++)this.writeScreen.insertChar(t[i]);const e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>e+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){const e={flash:!1};if(e.underline=t%2===1,e.italics=t>=46,e.italics)e.foreground="white";else{const i=Math.floor(t/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=r[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){const e=this.logger.time;e!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=e:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class dl{constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=gv(),this.logger=void 0;const r=this.logger=new uv;this.channels=[null,new fl(t,e,r),new fl(t+1,i,r)]}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){this.logger.time=t;for(let i=0;i<e.length;i+=2){const r=e[i]&127,s=e[i+1]&127;let a=!1,o=null;if(r===0&&s===0)continue;this.logger.log(3,()=>"["+_e([e[i],e[i+1]])+"] -> ("+_e([r,s])+")");const l=this.cmdHistory;if(r>=16&&r<=31){if(dv(r,s,l)){un(null,null,l),this.logger.log(3,()=>"Repeated command ("+_e([r,s])+") is dropped");continue}un(r,s,this.cmdHistory),a=this.parseCmd(r,s),a||(a=this.parseMidrow(r,s)),a||(a=this.parsePAC(r,s)),a||(a=this.parseBackgroundAttributes(r,s))}else un(null,null,l);if(!a&&(o=this.parseChars(r,s),o)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(o):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!a&&!o&&this.logger.log(2,()=>"Couldn't parse cleaned data "+_e([r,s])+" orig: "+_e([e[i],e[i+1]]))}}parseCmd(t,e){const i=(t===20||t===28||t===21||t===29)&&e>=32&&e<=47,r=(t===23||t===31)&&e>=33&&e<=35;if(!(i||r))return!1;const s=t===20||t===21||t===23?1:2,a=this.channels[s];return t===20||t===21||t===28||t===29?e===32?a.ccRCL():e===33?a.ccBS():e===34?a.ccAOF():e===35?a.ccAON():e===36?a.ccDER():e===37?a.ccRU(2):e===38?a.ccRU(3):e===39?a.ccRU(4):e===40?a.ccFON():e===41?a.ccRDC():e===42?a.ccTR():e===43?a.ccRTD():e===44?a.ccEDM():e===45?a.ccCR():e===46?a.ccENM():e===47&&a.ccEOC():a.ccTO(e-32),this.currentChannel=s,!0}parseMidrow(t,e){let i=0;if((t===17||t===25)&&e>=32&&e<=47){if(t===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[i];return r?(r.ccMIDROW(e),this.logger.log(3,()=>"MIDROW ("+_e([t,e])+")"),!0):!1}return!1}parsePAC(t,e){let i;const r=(t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127,s=(t===16||t===24)&&e>=64&&e<=95;if(!(r||s))return!1;const a=t<=23?1:2;e>=64&&e<=95?i=a===1?sv[t]:ov[t]:i=a===1?av[t]:lv[t];const o=this.channels[a];return o?(o.setPAC(this.interpretPAC(i,e)),this.currentChannel=a,!0):!1}interpretPAC(t,e){let i;const r={color:null,italics:!1,indent:null,underline:!1,row:t};return e>95?i=e-96:i=e-64,r.underline=(i&1)===1,i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=Math.floor((i-16)/2)*4,r}parseChars(t,e){let i,r=null,s=null;if(t>=25?(i=2,s=t-8):(i=1,s=t),s>=17&&s<=19){let a;s===17?a=e+80:s===18?a=e+112:a=e+144,this.logger.log(2,()=>"Special char '"+Pu(a)+"' in channel "+i),r=[a]}else t>=32&&t<=127&&(r=e===0?[t]:[t,e]);return r&&this.logger.log(3,()=>"Char codes =  "+_e(r).join(",")),r}parseBackgroundAttributes(t,e){const i=(t===16||t===24)&&e>=32&&e<=47,r=(t===23||t===31)&&e>=45&&e<=47;if(!(i||r))return!1;let s;const a={};t===16||t===24?(s=Math.floor((e-32)/2),a.background=cv[s],e%2===1&&(a.background=a.background+"_semi")):e===45?a.background="transparent":(a.foreground="black",e===47&&(a.underline=!0));const o=t<=23?1:2;return this.channels[o].setBkgData(a),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){const e=this.channels[t];e&&e.reset()}un(null,null,this.cmdHistory)}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){const i=this.channels[e];i&&i.cueSplitAtTime(t)}}}function un(n,t,e){e.a=n,e.b=t}function dv(n,t,e){return e.a===n&&e.b===t}function gv(){return{a:null,b:null}}class hn{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(this.startTime===null||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var ya=function(){if(li!=null&&li.VTTCue)return self.VTTCue;const n=["","lr","rl"],t=["start","middle","end","left","right"];function e(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const c=l.toLowerCase();return~o.indexOf(c)?c:!1}function i(o){return e(n,o)}function r(o){return e(t,o)}function s(o,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const h in u)o[h]=u[h]}return o}function a(o,l,c){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",d=!1,g=o,m=l,p=c,v=null,x="",T=!0,S="auto",E="start",R=50,A="middle",C=50,k="middle";Object.defineProperty(u,"id",s({},h,{get:function(){return f},set:function(I){f=""+I}})),Object.defineProperty(u,"pauseOnExit",s({},h,{get:function(){return d},set:function(I){d=!!I}})),Object.defineProperty(u,"startTime",s({},h,{get:function(){return g},set:function(I){if(typeof I!="number")throw new TypeError("Start time must be set to a number.");g=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",s({},h,{get:function(){return m},set:function(I){if(typeof I!="number")throw new TypeError("End time must be set to a number.");m=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",s({},h,{get:function(){return p},set:function(I){p=""+I,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",s({},h,{get:function(){return v},set:function(I){v=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",s({},h,{get:function(){return x},set:function(I){const b=i(I);if(b===!1)throw new SyntaxError("An invalid or illegal string was specified.");x=b,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",s({},h,{get:function(){return T},set:function(I){T=!!I,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",s({},h,{get:function(){return S},set:function(I){if(typeof I!="number"&&I!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");S=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",s({},h,{get:function(){return E},set:function(I){const b=r(I);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");E=b,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",s({},h,{get:function(){return R},set:function(I){if(I<0||I>100)throw new Error("Position must be between 0 and 100.");R=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",s({},h,{get:function(){return A},set:function(I){const b=r(I);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");A=b,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",s({},h,{get:function(){return C},set:function(I){if(I<0||I>100)throw new Error("Size must be between 0 and 100.");C=I,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",s({},h,{get:function(){return k},set:function(I){const b=r(I);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");k=b,this.hasBeenReset=!0}})),u.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class mv{decode(t,e){if(!t)return"";if(typeof t!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function Ou(n){function t(i,r,s,a){return(i|0)*3600+(r|0)*60+(s|0)+parseFloat(a||0)}const e=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return e?parseFloat(e[2])>59?t(e[2],e[3],0,e[4]):t(e[1],e[2],e[3],e[4]):null}class pv{constructor(){this.values=Object.create(null)}set(t,e){!this.get(t)&&e!==""&&(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let r=0;r<i.length;++r)if(e===i[r]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){const i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}}function Mu(n,t,e,i){const r=i?n.split(i):[n];for(const s in r){if(typeof r[s]!="string")continue;const a=r[s].split(e);if(a.length!==2)continue;const o=a[0],l=a[1];t(o,l)}}const Fs=new ya(0,0,""),fn=Fs.align==="middle"?"middle":"center";function yv(n,t,e){const i=n;function r(){const o=Ou(n);if(o===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),o}function s(o,l){const c=new pv;Mu(o,function(f,d){let g;switch(f){case"region":for(let m=e.length-1;m>=0;m--)if(e[m].id===d){c.set(f,e[m].region);break}break;case"vertical":c.alt(f,d,["rl","lr"]);break;case"line":g=d.split(","),c.integer(f,g[0]),c.percent(f,g[0])&&c.set("snapToLines",!1),c.alt(f,g[0],["auto"]),g.length===2&&c.alt("lineAlign",g[1],["start",fn,"end"]);break;case"position":g=d.split(","),c.percent(f,g[0]),g.length===2&&c.alt("positionAlign",g[1],["start",fn,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,d);break;case"align":c.alt(f,d,["start",fn,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&Fs.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",fn);let h=c.get("position","auto");h==="auto"&&Fs.position===50&&(h=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=h}function a(){n=n.replace(/^\s+/,"")}if(a(),t.startTime=r(),a(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),a(),t.endTime=r(),a(),s(n,t)}function Nu(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class vv{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new mv,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){const e=this;t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));function i(){let s=e.buffer,a=0;for(s=Nu(s);a<s.length&&s[a]!=="\r"&&s[a]!==`
`;)++a;const o=s.slice(0,a);return s[a]==="\r"&&++a,s[a]===`
`&&++a,e.buffer=s.slice(a),o}function r(s){Mu(s,function(a,o){},/:/)}try{let s="";if(e.state==="INITIAL"){if(!/\r\n|\n/.test(e.buffer))return this;s=i();const o=s.match(/^()?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");e.state="HEADER"}let a=!1;for(;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(a?a=!1:s=i(),e.state){case"HEADER":/:/.test(s)?r(s):s||(e.state="ID");continue;case"NOTE":s||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){e.state="NOTE";break}if(!s)continue;if(e.cue=new ya(0,0,""),e.state="CUE",s.indexOf("-->")===-1){e.cue.id=s;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{yv(s,e.cue,e.regionList)}catch{e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{const o=s.indexOf("-->")!==-1;if(!s||o&&(a=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(e.cue===null)continue;e.cue.text&&(e.cue.text+=`
`),e.cue.text+=s}continue;case"BADCUE":s||(e.state="ID")}}}catch{e.state==="CUETEXT"&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state=e.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const t=this;try{if((t.cue||t.state==="HEADER")&&(t.buffer+=`

`,t.parse()),t.state==="INITIAL"||t.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(e){t.onparsingerror&&t.onparsingerror(e)}return t.onflush&&t.onflush(),this}}const Ev=/\r\n|\n\r|\n|\r/g,Br=function(t,e,i=0){return t.slice(i,i+e.length)===e},xv=function(t){let e=parseInt(t.slice(-3));const i=parseInt(t.slice(-6,-4)),r=parseInt(t.slice(-9,-7)),s=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!B(e)||!B(i)||!B(r)||!B(s))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${t}`);return e+=1e3*i,e+=60*1e3*r,e+=60*60*1e3*s,e},$r=function(t){let e=5381,i=t.length;for(;i;)e=e*33^t.charCodeAt(--i);return(e>>>0).toString()};function va(n,t,e){return $r(n.toString())+$r(t.toString())+$r(e)}const Tv=function(t,e,i){let r=t[e],s=t[r.prevCC];if(!s||!s.new&&r.new){t.ccOffset=t.presentationOffset=r.start,r.new=!1;return}for(;(a=s)!=null&&a.new;){var a;t.ccOffset+=r.start-s.start,r.new=!1,r=s,s=t[r.prevCC]}t.presentationOffset=i};function Sv(n,t,e,i,r,s,a){const o=new vv,l=ie(new Uint8Array(n)).trim().replace(Ev,`
`).split(`
`),c=[],u=t?By(t.baseTime,t.timescale):0;let h="00:00.000",f=0,d=0,g,m=!0;o.oncue=function(p){const v=e[i];let x=e.ccOffset;const T=(f-u)/9e4;if(v!=null&&v.new&&(d!==void 0?x=e.ccOffset=v.start:Tv(e,i,T)),T){if(!t){g=new Error("Missing initPTS for VTT MPEGTS");return}x=T-e.presentationOffset}const S=p.endTime-p.startTime,E=wt((p.startTime+x-d)*9e4,r*9e4)/9e4;p.startTime=Math.max(E,0),p.endTime=Math.max(E+S,0);const R=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(R)),p.id||(p.id=va(p.startTime,p.endTime,R)),p.endTime>0&&c.push(p)},o.onparsingerror=function(p){g=p},o.onflush=function(){if(g){a(g);return}s(c)},l.forEach(p=>{if(m)if(Br(p,"X-TIMESTAMP-MAP=")){m=!1,p.slice(16).split(",").forEach(v=>{Br(v,"LOCAL:")?h=v.slice(6):Br(v,"MPEGTS:")&&(f=parseInt(v.slice(7)))});try{d=xv(h)/1e3}catch(v){g=v}return}else p===""&&(m=!1);o.parse(p+`
`)}),o.flush()}const Gr="stpp.ttml.im1t",Uu=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Bu=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Av={left:"start",center:"center",right:"end",start:"start",end:"end"};function gl(n,t,e,i){const r=z(new Uint8Array(n),["mdat"]);if(r.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const s=r.map(o=>ie(o)),a=Uy(t.baseTime,1,t.timescale);try{s.forEach(o=>e(Lv(o,a)))}catch(o){i(o)}}function Lv(n,t){const r=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(s).reduce((h,f)=>(h[f]=r.getAttribute(`ttp:${f}`)||s[f],h),{}),o=r.getAttribute("xml:space")!=="preserve",l=ml(Kr(r,"styling","style")),c=ml(Kr(r,"layout","region")),u=Kr(r,"body","[begin]");return[].map.call(u,h=>{const f=$u(h,o);if(!f||!h.hasAttribute("begin"))return null;const d=Vr(h.getAttribute("begin"),a),g=Vr(h.getAttribute("dur"),a);let m=Vr(h.getAttribute("end"),a);if(d===null)throw pl(h);if(m===null){if(g===null)throw pl(h);m=d+g}const p=new ya(d-t,m-t,f);p.id=va(p.startTime,p.endTime,p.text);const v=c[h.getAttribute("region")],x=l[h.getAttribute("style")],T=Rv(v,x,l),{textAlign:S}=T;if(S){const E=Av[S];E&&(p.lineAlign=E),p.align=S}return ft(p,T),p}).filter(h=>h!==null)}function Kr(n,t,e){const i=n.getElementsByTagName(t)[0];return i?[].slice.call(i.querySelectorAll(e)):[]}function ml(n){return n.reduce((t,e)=>{const i=e.getAttribute("xml:id");return i&&(t[i]=e),t},{})}function $u(n,t){return[].slice.call(n.childNodes).reduce((e,i,r)=>{var s;return i.nodeName==="br"&&r?e+`
`:(s=i.childNodes)!=null&&s.length?$u(i,t):t?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent},"")}function Rv(n,t,e){const i="http://www.w3.org/ns/ttml#styling";let r=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return a&&e.hasOwnProperty(a)&&(r=e[a]),s.reduce((o,l)=>{const c=Hr(t,i,l)||Hr(n,i,l)||Hr(r,i,l);return c&&(o[l]=c),o},{})}function Hr(n,t,e){return n&&n.hasAttributeNS(t,e)?n.getAttributeNS(t,e):null}function pl(n){return new Error(`Could not parse ttml timestamp ${n}`)}function Vr(n,t){if(!n)return null;let e=Ou(n);return e===null&&(Uu.test(n)?e=_v(n,t):Bu.test(n)&&(e=Iv(n,t))),e}function _v(n,t){const e=Uu.exec(n),i=(e[4]|0)+(e[5]|0)/t.subFrameRate;return(e[1]|0)*3600+(e[2]|0)*60+(e[3]|0)+i/t.frameRate}function Iv(n,t){const e=Bu.exec(n),i=Number(e[1]);switch(e[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}class bv{constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=vl(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(y.FRAG_LOADING,this.onFragLoading,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this),t.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:t}=this;t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(y.FRAG_LOADING,this.onFragLoading,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this),t.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const t=new hn(this,"textTrack1"),e=new hn(this,"textTrack2"),i=new hn(this,"textTrack3"),r=new hn(this,"textTrack4");this.cea608Parser1=new dl(1,t,e),this.cea608Parser2=new dl(3,i,r)}}addCues(t,e,i,r,s){let a=!1;for(let o=s.length;o--;){const l=s[o],c=wv(l[0],l[1],e,i);if(c>=0&&(l[0]=Math.min(l[0],e),l[1]=Math.max(l[1],i),a=!0,c/(i-e)>.5))return}if(a||s.push([e,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[t];this.Cues.newCue(o,e,i,r)}else{const o=this.Cues.newCue(null,e,i,r);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:o,track:t})}}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){const{unparsedVttFrags:a}=this;i==="main"&&(this.initPTS[e.cc]={baseTime:r,timescale:s}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(y.FRAG_LOADED,o)}))}getExistingTrack(t,e){const{media:i}=this;if(i)for(let r=0;r<i.textTracks.length;r++){const s=i.textTracks[r];if(yl(s,{name:t,lang:e,attrs:{}}))return s}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;const{captionsProperties:e,captionsTracks:i,media:r}=this,{label:s,languageCode:a}=e[t],o=this.getExistingTrack(s,a);if(o)i[t]=o,Qe(i[t]),au(i[t],r);else{const l=this.createTextTrack("captions",s,a);l&&(l[t]=!0,i[t]=l)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;const e=this.captionsProperties[t];if(!e)return;const i=e.label,r={_id:t,label:i,kind:"captions",default:e.media?!!e.media.default:!1,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=r,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[r]})}createTextTrack(t,e,i){const r=this.media;if(r)return r.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:t}=this;Object.keys(t).forEach(e=>{Qe(t[e]),delete t[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=vl(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:t}=this;if(!t)return;const e=t.textTracks;if(e)for(let i=0;i<e.length;i++)Qe(e[i])}onSubtitleTracksUpdated(t,e){const i=e.subtitleTracks||[],r=i.some(s=>s.textCodec===Gr);if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(ku(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const a=this.media,o=a?En(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(o){let h=null;for(let f=0;f<o.length;f++)if(o[f]&&yl(o[f],l)){h=o[f],o[f]=null;break}h&&(u=h)}if(u)Qe(u);else{const h=Gu(l);u=this.createTextTrack(h,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&L.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(i=>{const r=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!r)return;const s=`textTrack${r[1]}`,a=this.captionsProperties[s];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(t){const e=this.hls.levels[t.level];return e==null?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){if(this.enabled&&e.frag.type===H.MAIN){var i,r;const{cea608Parser1:s,cea608Parser2:a,lastSn:o}=this,{cc:l,sn:c}=e.frag,u=(i=(r=e.part)==null?void 0:r.index)!=null?i:-1;s&&a&&(c!==o+1||c===o&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(s.reset(),a.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(t,e){const{frag:i,payload:r}=e;if(i.type===H.SUBTITLE)if(r.byteLength){const s=i.decryptdata,a="stats"in e;if(s==null||!s.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===Gr?this._parseIMSC1(i,r):this._parseVTTs(e)}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(t,e){const i=this.hls;gl(e,this.initPTS[t.cc],r=>{this._appendCues(r,t.level),i.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})},r=>{L.log(`Failed to parse IMSC1: ${r}`),i.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:r})})}_parseVTTs(t){var e;const{frag:i,payload:r}=t,{initPTS:s,unparsedVttFrags:a}=this,o=s.length-1;if(!s[i.cc]&&o===-1){a.push(t);return}const l=this.hls,c=(e=i.initSegment)!=null&&e.data?Ft(i.initSegment.data,new Uint8Array(r)):r;Sv(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?a.push(t):this._fallbackToIMSC1(i,r),L.log(`Failed to parse VTT cue: ${u}`),!(h&&o>i.cc)&&l.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(t,e){const i=this.tracks[t.level];i.textCodec||gl(e,this.initPTS[t.cc],()=>{i.textCodec=Gr,this._parseIMSC1(t,e)},()=>{i.textCodec="wvtt"})}_appendCues(t,e){const i=this.hls;if(this.config.renderTextTracksNatively){const r=this.textTracks[e];if(!r||r.mode==="disabled")return;t.forEach(s=>ou(r,s))}else{const r=this.tracks[e];if(!r)return;const s=r.default?"default":"subtitles"+e;i.trigger(y.CUES_PARSED,{type:"subtitles",cues:t,track:s})}}onFragDecrypted(t,e){const{frag:i}=e;i.type===H.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:r}=this;if(!this.enabled||!i||!r)return;const{frag:s,samples:a}=e;if(!(s.type===H.MAIN&&this.closedCaptionsForLevel(s)==="NONE"))for(let o=0;o<a.length;o++){const l=a[o].bytes;if(l){const c=this.extractCea608Data(l);i.addData(a[o].pts,c[0]),r.addData(a[o].pts,c[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:i,endOffsetSubtitles:r,type:s}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!s||s==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>Is(o[l],e,i))}if(this.config.renderTextTracksNatively&&e===0&&r!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>Is(o[l],e,r))}}}extractCea608Data(t){const e=[[],[]],i=t[0]&31;let r=2;for(let s=0;s<i;s++){const a=t[r++],o=127&t[r++],l=127&t[r++];if(o===0&&l===0)continue;if((4&a)!==0){const u=3&a;(u===0||u===1)&&(e[u].push(o),e[u].push(l))}}return e}}function Gu(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function yl(n,t){return!!n&&n.kind===Gu(t)&&Ps(t,n)}function wv(n,t,e,i){return Math.min(t,i)-Math.max(n,e)}function vl(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class Ea{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.BUFFER_CODECS,this.onBufferCodecs,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.BUFFER_CODECS,this.onBufferCodecs,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){const i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&B(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const t=this.hls.levels;if(t.length){const e=this.hls,i=this.getMaxLevel(t.length-1);i!==this.autoLevelCapping&&L.log(`Setting autoLevelCapping to ${i}: ${t[i].height}p@${t[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=i,e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const i=e.filter((r,s)=>this.isLevelAllowed(r)&&s<=t);return this.clientRect=null,Ea.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,!e.width&&!e.height&&(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch{}return t}isLevelAllowed(t){return!this.restrictedLevels.some(i=>t.bitrate===i.bitrate&&t.width===i.width&&t.height===i.height)}static getMaxLevelByMediaSize(t,e,i){if(!(t!=null&&t.length))return-1;const r=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let s=t.length-1;const a=Math.max(e,i);for(let o=0;o<t.length;o+=1){const l=t[o];if((l.width>=a||l.height>=a)&&r(l,t[o+1])){s=o;break}}return s}}class Dv{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const i=this.hls.config;if(i.capLevelOnFPSDrop){const r=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=r,r&&typeof r.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,i){const r=performance.now();if(e){if(this.lastTime){const s=r-this.lastTime,a=i-this.lastDroppedFrames,o=e-this.lastDecodedFrames,l=1e3*a/s,c=this.hls;if(c.trigger(y.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let u=c.currentLevel;L.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}}const dn="[eme]";class ei{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=ei.CDMCleanupPromise?[ei.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=L.debug.bind(L,dn),this.log=L.log.bind(L,dn),this.warn=L.warn.bind(L,dn),this.error=L.error.bind(L,dn),this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(t){const{drmSystems:e,widevineLicenseUrl:i}=this.config,r=e[t];if(r)return r.licenseUrl;if(t===rt.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${t}"`)}getServerCertificateUrl(t){const{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){const e=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,r=e.map(a=>a.audioCodec).filter(i),s=e.map(a=>a.videoCodec).filter(i);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,r,s).then(h=>a({keySystem:u,mediaKeys:h})).catch(h=>{c.length?l(c):h instanceof bt?o(h):o(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};l(t)})}requestMediaKeySystemAccess(t,e){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let r=`Configured requestMediaKeySystemAccess is not a function ${i}`;return qc===null&&self.location.protocol==="http:"&&(r=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(r))}return i(t,e)}getMediaKeysPromise(t,e,i){const r=Mm(t,e,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[t];let a=s==null?void 0:s.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${t}" key-system access with config: ${JSON.stringify(r)}`),a=this.requestMediaKeySystemAccess(t,r);const o=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${t}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),o.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${t}"`),c.then(h=>h?this.setMediaKeysServerCertificate(u,t,h):u))),o.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${t}"}: ${u}`)}),o.mediaKeys})}return a.then(()=>s.mediaKeys)}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:i}){this.log(`Creating key-system session "${e}" keyId: ${Wt.hexDump(t.keyId||[])}`);const r=i.createSession(),s={decryptdata:t,keySystem:e,mediaKeys:i,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(t){const e=t.decryptdata;if(e.pssh){const i=this.createMediaKeySessionContext(t),r=this.getKeyIdString(e),s="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,s,e.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(t.keyId===null)throw new Error("keyId is null");return Wt.hexDump(t.keyId)}updateKeySession(t,e){var i;const r=t.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${Wt.hexDump(((i=t.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${e&&e.byteLength})`),r.update(e)}selectKeySystemFormat(t){const e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){return new Promise((e,i)=>{const r=_r(this.config),s=t.map(Lo).filter(a=>!!a&&r.indexOf(a)!==-1);return this.getKeySystemSelectionPromise(s).then(({keySystem:a})=>{const o=_o(a);o?e(o):i(new Error(`Unable to find format for key-system "${a}"`))}).catch(i)})}loadKey(t){const e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),r=`(keyId: ${i} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${r}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(e).then(({keySystem:a,mediaKeys:o})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${r}`),this.attemptSetMediaKeys(a,o).then(()=>{this.throwIfDestroyed();const l=this.createMediaKeySessionContext({keySystem:a,mediaKeys:o,decryptdata:e});return this.generateRequestWithPreferredKeySession(l,"cenc",e.pssh,"playlist-key")}))),s.catch(a=>this.handleError(a))),s}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof bt?this.hls.trigger(y.ERROR,t.data):this.hls.trigger(y.ERROR,{type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){const e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){const r=Lo(t.keyFormat),s=r?[r]:_r(this.config);return this.attemptKeySystemAccess(s)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=_r(this.config)),t.length===0)throw new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}_onMediaEncrypted(t){const{initDataType:e,initData:i}=t,r=`"${t.type}" event: init data type: "${e}"`;if(this.debug(r),i===null)return;let s,a;if(e==="sinf"&&this.config.drmSystems[rt.FAIRPLAY]){const h=dt(new Uint8Array(i));try{const f=ra(JSON.parse(h).sinf),d=eu(new Uint8Array(f));if(!d)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");s=d.subarray(8,24),a=rt.FAIRPLAY}catch(f){this.warn(`${r} Failed to parse sinf: ${f}`);return}}else{const h=op(i),f=h.filter(d=>d.systemId===wi.WIDEVINE)[0];if(!f){h.length===0||h.some(d=>!d.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${h.map(d=>Ro(d.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(a=Ro(f.systemId),f.version===0&&f.data){const d=f.data.length-22;s=f.data.subarray(d,d+16)}}if(!a||!s)return;const o=Wt.hexDump(s),{keyIdToKeySessionPromise:l,mediaKeySessions:c}=this;let u=l[o];for(let h=0;h<c.length;h++){const f=c[h],d=f.decryptdata;if(!d.keyId)continue;const g=Wt.hexDump(d.keyId);if(o===g||d.uri.replace(/-/g,"").indexOf(o)!==-1){if(u=l[g],d.pssh)break;delete l[g],d.pssh=new Uint8Array(i),d.keyId=s,u=l[o]=u.then(()=>this.generateRequestWithPreferredKeySession(f,e,i,"encrypted-event-key-match"));break}}u||(u=l[o]=this.getKeySystemSelectionPromise([a]).then(({keySystem:h,mediaKeys:f})=>{var d;this.throwIfDestroyed();const g=new Gi("ISO-23001-7",o,(d=_o(h))!=null?d:"");return g.pssh=new Uint8Array(i),g.keyId=s,this.attemptSetMediaKeys(h,f).then(()=>{this.throwIfDestroyed();const m=this.createMediaKeySessionContext({decryptdata:g,keySystem:h,mediaKeys:f});return this.generateRequestWithPreferredKeySession(m,e,i,"encrypted-event-no-match")})})),u.catch(h=>this.handleError(h))}_onWaitingForKey(t){this.log(`"${t.type}" event`)}attemptSetMediaKeys(t,e){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);const r=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)});return this.setMediaKeysQueue.push(r),r.then(()=>{this.log(`Media-keys set for "${t}"`),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(s=>i.indexOf(s)===-1)})}generateRequestWithPreferredKeySession(t,e,i,r){var s,a;const o=(s=this.config.drmSystems)==null||(a=s[t.keySystem])==null?void 0:a.generateRequest;if(o)try{const g=o.call(this.hls,e,i,t);if(!g)throw new Error("Invalid response from configured generateRequest filter");e=g.initDataType,i=t.decryptdata.pssh=g.initData?new Uint8Array(g.initData):null}catch(g){var l;if(this.warn(g.message),(l=this.hls)!=null&&l.config.debug)throw g}if(i===null)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(t);const c=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${r}": ${c} (init data type: ${e} length: ${i?i.byteLength:null})`);const u=new pa,h=t._onmessage=g=>{const m=t.mediaKeysSession;if(!m){u.emit("error",new Error("invalid state"));return}const{messageType:p,message:v}=g;this.log(`"${p}" message event for session "${m.sessionId}" message size: ${v.byteLength}`),p==="license-request"||p==="license-renewal"?this.renewLicense(t,v).catch(x=>{this.handleError(x),u.emit("error",x)}):p==="license-release"?t.keySystem===rt.FAIRPLAY&&(this.updateKeySession(t,Rs("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${p}"`)},f=t._onkeystatuseschange=g=>{if(!t.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(t);const p=t.keyStatus;u.emit("keyStatus",p),p==="expired"&&(this.warn(`${t.keySystem} expired for key ${c}`),this.renewKeySession(t))};t.mediaKeysSession.addEventListener("message",h),t.mediaKeysSession.addEventListener("keystatuseschange",f);const d=new Promise((g,m)=>{u.on("error",m),u.on("keyStatus",p=>{p.startsWith("usable")?g():p==="output-restricted"?m(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):p==="internal-error"?m(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${p}"`)):p==="expired"?m(new Error("key expired while generating request")):this.warn(`unhandled key status change "${p}"`)})});return t.mediaKeysSession.generateRequest(e,i).then(()=>{var g;this.log(`Request generated for key-session "${(g=t.mediaKeysSession)==null?void 0:g.sessionId}" keyId: ${c}`)}).catch(g=>{throw new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_NO_SESSION,error:g,fatal:!1},`Error generating key-session request: ${g}`)}).then(()=>d).catch(g=>{throw u.removeAllListeners(),this.removeSession(t),g}).then(()=>(u.removeAllListeners(),t))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach((e,i)=>{this.log(`key status change "${e}" for keyStatuses keyId: ${Wt.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Wt.hexDump(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=e})}fetchServerCertificate(t){const e=this.config,i=e.loader,r=new i(e),s=this.getServerCertificateUrl(t);return s?(this.log(`Fetching server certificate for "${t}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:s},c=e.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,g,m)=>{a(f.data)},onError:(f,d,g,m)=>{o(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:pt({url:l.url,data:void 0},f)},`"${t}" certificate request failed (${s}). Status: ${f.code} (${f.text})`))},onTimeout:(f,d,g)=>{o(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:{url:l.url,data:void 0}},`"${t}" certificate request timed out (${s})`))},onAbort:(f,d,g)=>{o(new Error("aborted"))}};r.load(l,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise((r,s)=>{t.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${e}"`),r(t)}).catch(a=>{s(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then(i=>this.updateKeySession(t,new Uint8Array(i)).catch(r=>{throw new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:r,fatal:!0},r.message)}))}unpackPlayReadyKeyMessage(t,e){const i=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!i.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;const r=new DOMParser().parseFromString(i,"application/xml"),s=r.querySelectorAll("HttpHeader");if(s.length>0){let u;for(let h=0,f=s.length;h<f;h++){var a,o;u=s[h];const d=(a=u.querySelector("name"))==null?void 0:a.textContent,g=(o=u.querySelector("value"))==null?void 0:o.textContent;d&&g&&t.setRequestHeader(d,g)}}const l=r.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Rs(atob(c))}setupLicenseXHR(t,e,i,r){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,t,e,i,r)}).catch(a=>{if(!i.decryptdata)throw a;return t.open("POST",e,!0),s.call(this.hls,t,e,i,r)}).then(a=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:a||r})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:r}))}requestLicense(t,e){const i=this.config.keyLoadPolicy.default;return new Promise((r,s)=>{const a=this.getLicenseServerUrl(t.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return s(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,t)}catch(u){this.error(u)}r(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)s(new bt({type:Y.KEY_SYSTEM_ERROR,details:D.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(t,e).then(r,s)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=o,this.setupLicenseXHR(o,a,t,e).then(({xhr:l,licenseChallenge:c})=>{t.keySystem==rt.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onMediaAttached(t,e){if(!this.config.emeEnabled)return;const i=e.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const t=this.media,e=this.mediaKeySessions;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Gi.clearKeyUriToKeyIdMap();const i=e.length;ei.CDMCleanupPromise=Promise.all(e.map(r=>this.removeSession(r)).concat(t==null?void 0:t.setMediaKeys(null).catch(r=>{this.log(`Could not clear media keys: ${r}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),e.length=0)}).catch(r=>{this.log(`Could not close sessions and clear media keys: ${r}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,{sessionKeys:e}){if(!(!e||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=e.reduce((r,s)=>(r.indexOf(s.keyFormat)===-1&&r.push(s.keyFormat),r),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(t){const{mediaKeysSession:e,licenseXhr:i}=t;if(e){this.log(`Remove licenses and keys and close session ${e.sessionId}`),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(t);return r>-1&&this.mediaKeySessions.splice(r,1),e.remove().catch(s=>{this.log(`Could not remove session: ${s}`)}).then(()=>e.close()).catch(s=>{this.log(`Could not close session: ${s}`)})}}}ei.CDMCleanupPromise=void 0;class bt extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=new Error(e)),this.data=t,t.err=t.error}}var Et;(function(n){n.MANIFEST="m",n.AUDIO="a",n.VIDEO="v",n.MUXED="av",n.INIT="i",n.CAPTION="c",n.TIMED_TEXT="tt",n.KEY="k",n.OTHER="o"})(Et||(Et={}));var Os;(function(n){n.DASH="d",n.HLS="h",n.SMOOTH="s",n.OTHER="o"})(Os||(Os={}));var De;(function(n){n.OBJECT="CMCD-Object",n.REQUEST="CMCD-Request",n.SESSION="CMCD-Session",n.STATUS="CMCD-Status"})(De||(De={}));const Cv={[De.OBJECT]:["br","d","ot","tb"],[De.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[De.SESSION]:["cid","pr","sf","sid","st","v"],[De.STATUS]:["bs","rtp"]};class hi{constructor(t,e){this.value=void 0,this.params=void 0,Array.isArray(t)&&(t=t.map(i=>i instanceof hi?i:new hi(i))),this.value=t,this.params=e}}class Ku{constructor(t){this.description=void 0,this.description=t}}const kv="Dict";function Pv(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function Fv(n,t,e,i){return new Error(`failed to ${n} "${Pv(t)}" as ${e}`,{cause:i})}const El="Bare Item",Ov="Boolean",Mv="Byte Sequence",Nv="Decimal",Uv="Integer";function Bv(n){return n<-999999999999999||999999999999999<n}const $v=/[\x00-\x1f\x7f]+/,Gv="Token",Kv="Key";function ne(n,t,e){return Fv("serialize",n,t,e)}function Hv(n){if(typeof n!="boolean")throw ne(n,Ov);return n?"?1":"?0"}function Vv(n){return btoa(String.fromCharCode(...n))}function Yv(n){if(ArrayBuffer.isView(n)===!1)throw ne(n,Mv);return`:${Vv(n)}:`}function Hu(n){if(Bv(n))throw ne(n,Uv);return n.toString()}function Wv(n){return`@${Hu(n.getTime()/1e3)}`}function Vu(n,t){if(n<0)return-Vu(-n,t);const e=Math.pow(10,t);if(Math.abs(n*e%1-.5)<Number.EPSILON){const r=Math.floor(n*e);return(r%2===0?r:r+1)/e}else return Math.round(n*e)/e}function qv(n){const t=Vu(n,3);if(Math.floor(Math.abs(t)).toString().length>12)throw ne(n,Nv);const e=t.toString();return e.includes(".")?e:`${e}.0`}const zv="String";function Xv(n){if($v.test(n))throw ne(n,zv);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function jv(n){return n.description||n.toString().slice(7,-1)}function xl(n){const t=jv(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t)===!1)throw ne(t,Gv);return t}function Ms(n){switch(typeof n){case"number":if(!B(n))throw ne(n,El);return Number.isInteger(n)?Hu(n):qv(n);case"string":return Xv(n);case"symbol":return xl(n);case"boolean":return Hv(n);case"object":if(n instanceof Date)return Wv(n);if(n instanceof Uint8Array)return Yv(n);if(n instanceof Ku)return xl(n);default:throw ne(n,El)}}function Ns(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw ne(n,Kv);return n}function xa(n){return n==null?"":Object.entries(n).map(([t,e])=>e===!0?`;${Ns(t)}`:`;${Ns(t)}=${Ms(e)}`).join("")}function Yu(n){return n instanceof hi?`${Ms(n.value)}${xa(n.params)}`:Ms(n)}function Qv(n){return`(${n.value.map(Yu).join(" ")})${xa(n.params)}`}function Jv(n,t={whitespace:!0}){if(typeof n!="object")throw ne(n,kv);const e=n instanceof Map?n.entries():Object.entries(n),i=t!=null&&t.whitespace?" ":"";return Array.from(e).map(([r,s])=>{s instanceof hi||(s=new hi(s));let a=Ns(r);return s.value===!0?a+=xa(s.params):(a+="=",Array.isArray(s.value)?a+=Qv(s):a+=Yu(s)),a}).join(`,${i}`)}function Zv(n,t){return Jv(n,t)}const tE=n=>n==="ot"||n==="sf"||n==="st",eE=n=>typeof n=="number"?B(n):n!=null&&n!==""&&n!==!1;function iE(n,t){const e=new URL(n),i=new URL(t);if(e.origin!==i.origin)return n;const r=e.pathname.split("/").slice(1),s=i.pathname.split("/").slice(1,-1);for(;r[0]===s[0];)r.shift(),s.shift();for(;s.length;)s.shift(),r.unshift("..");return r.join("/")}function nE(){try{return crypto.randomUUID()}catch{try{const t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}catch{let e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const s=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(r=="x"?s:s&3|8).toString(16)})}}}const Rn=n=>Math.round(n),rE=(n,t)=>(t!=null&&t.baseUrl&&(n=iE(n,t.baseUrl)),encodeURIComponent(n)),gn=n=>Rn(n/100)*100,sE={br:Rn,d:Rn,bl:gn,dl:gn,mtp:gn,nor:rE,rtp:gn,tb:Rn};function aE(n,t){const e={};if(n==null||typeof n!="object")return e;const i=Object.keys(n).sort(),r=ft({},sE,t==null?void 0:t.formatters),s=t==null?void 0:t.filter;return i.forEach(a=>{if(s!=null&&s(a))return;let o=n[a];const l=r[a];l&&(o=l(o,t)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||eE(o)&&(tE(a)&&typeof o=="string"&&(o=new Ku(o)),e[a]=o))}),e}function Wu(n,t={}){return n?Zv(aE(n,t),ft({whitespace:!1},t)):""}function oE(n,t={}){if(!n)return{};const e=Object.entries(n),i=Object.entries(Cv).concat(Object.entries((t==null?void 0:t.customHeaderMap)||{})),r=e.reduce((s,a)=>{var o,l;const[c,u]=a,h=((o=i.find(f=>f[1].includes(c)))==null?void 0:o[0])||De.REQUEST;return(l=s[h])!=null||(s[h]={}),s[h][c]=u,s},{});return Object.entries(r).reduce((s,[a,o])=>(s[a]=Wu(o,t),s),{})}function lE(n,t,e){return ft(n,oE(t,e))}const cE="CMCD";function uE(n,t={}){if(!n)return"";const e=Wu(n,t);return`${cE}=${encodeURIComponent(e)}`}const Tl=/CMCD=[^&#]+/;function hE(n,t,e){const i=uE(t,e);if(!i)return n;if(Tl.test(n))return n.replace(Tl,i);const r=n.includes("?")?"&":"?";return`${n}${r}${i}`}class fE{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=r=>{try{this.apply(r,{ot:Et.MANIFEST,su:!this.initialized})}catch(s){L.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=r=>{try{const s=r.frag,a=this.hls.levels[s.level],o=this.getObjectType(s),l={d:s.duration*1e3,ot:o};(o===Et.VIDEO||o===Et.AUDIO||o==Et.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(o)/1e3,l.bl=this.getBufferLength(o)),this.apply(r,l)}catch(s){L.warn("Could not generate segment CMCD data.",s)}},this.hls=t;const e=this.config=t.config,{cmcd:i}=e;i!=null&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||nE(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const t=this.hls;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHED,this.onMediaDetached,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const t=this.hls;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHED,this.onMediaDetached,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,r;this.audioBuffer=(i=e.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(r=e.tracks.video)==null?void 0:r.buffer}createData(){var t;return{v:1,sf:Os.HLS,sid:this.sid,cid:this.cid,pr:(t=this.media)==null?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){ft(e,this.createData());const i=e.ot===Et.INIT||e.ot===Et.VIDEO||e.ot===Et.MUXED;this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),e.su==null&&(e.su=this.buffering);const{includeKeys:r}=this;r&&(e=Object.keys(e).reduce((s,a)=>(r.includes(a)&&(s[a]=e[a]),s),{})),this.useHeaders?(t.headers||(t.headers={}),lE(t.headers,e)):t.url=hE(t.url,e)}getObjectType(t){const{type:e}=t;if(e==="subtitle")return Et.TIMED_TEXT;if(t.sn==="initSegment")return Et.INIT;if(e==="audio")return Et.AUDIO;if(e==="main")return this.hls.audioTracks.length?Et.VIDEO:Et.MUXED}getTopBandwidth(t){let e=0,i;const r=this.hls;if(t===Et.AUDIO)i=r.audioTracks;else{const s=r.maxAutoLevel,a=s>-1?s+1:r.levels.length;i=r.levels.slice(0,a)}for(const s of i)s.bitrate>e&&(e=s.bitrate);return e>0?e:NaN}getBufferLength(t){const e=this.hls.media,i=t===Et.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!e?NaN:nt.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,a,o){e(s),this.loader.load(s,a,o)}}}createFragmentLoader(){const{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,a,o){e(s),this.loader.load(s,a,o)}}}}const dE=3e5;class gE{constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=L.log.bind(L,"[content-steering]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const t=this.timeToLoad*1e3-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter(i=>i!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:i}=e;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:i}=e;if((i==null?void 0:i.action)===vt.SendAlternateToPenaltyBox&&i.flags===Ot.MoveAllAlternatesMatchingHost){const r=this.levels;let s=this.pathwayPriority,a=this.pathwayId;if(e.context){const{groupId:o,pathwayId:l,type:c}=e.context;o&&r?a=this.getPathwayForGroupId(o,c,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!s&&r&&(s=r.reduce((o,l)=>(o.indexOf(l.pathwayId)===-1&&o.push(l.pathwayId),o),[])),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==a),i.resolved||L.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${a} levels: ${r&&r.length} priorities: ${JSON.stringify(s)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(e.length===0){const i=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length&&this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e}getLevelsForPathway(t){return this.levels===null?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){this.pathwayPriority=t;let e;const i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach(s=>{r-i[s]>dE&&delete i[s]});for(let s=0;s<t.length;s++){const a=t[s];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(e=this.getLevelsForPathway(a),e.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,hu(e),this.hls.trigger(y.LEVELS_UPDATED,{levels:e});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(t,e,i){const r=this.getLevelsForPathway(i).concat(this.levels||[]);for(let s=0;s<r.length;s++)if(e===Q.AUDIO_TRACK&&r[s].hasAudioGroup(t)||e===Q.SUBTITLE_TRACK&&r[s].hasSubtitleGroup(t))return r[s].pathwayId;return i}clonePathways(t){const e=this.levels;if(!e)return;const i={},r={};t.forEach(s=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=s;if(e.some(u=>u.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(u=>{const h=new ct(u.attrs);h["PATHWAY-ID"]=a;const f=h.AUDIO&&`${h.AUDIO}_clone_${a}`,d=h.SUBTITLES&&`${h.SUBTITLES}_clone_${a}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),d&&(r[h.SUBTITLES]=d,h.SUBTITLES=d);const g=qu(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),m=new ci({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:g,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let p=1;p<u.audioGroups.length;p++)m.addGroupId("audio",`${u.audioGroups[p]}_clone_${a}`);if(u.subtitleGroups)for(let p=1;p<u.subtitleGroups.length;p++)m.addGroupId("text",`${u.subtitleGroups[p]}_clone_${a}`);return m});e.push(...c),Sl(this.audioTracks,i,l,a),Sl(this.subtitleTracks,r,l,a)})}loadSteeringManifest(t){const e=this.hls.config,i=e.loader;this.loader&&this.loader.destroy(),this.loader=new i(e);let r;try{r=new self.URL(t)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${t}`);return}if(r.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate)|0;r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+u)}const s={responseType:"json",url:r.href},a=e.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(u,h,f,d)=>{this.log(`Loaded steering manifest: "${r}"`);const g=u.data;if(g.VERSION!==1){this.log(`Steering VERSION ${g.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=g.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":v}=g;if(m)try{this.uri=new self.URL(m,r).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||f.url),p&&this.clonePathways(p);const x={steeringManifest:g,url:r.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,x),v&&this.updatePathwayPriority(v)},onError:(u,h,f,d)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let g=this.timeToLoad*1e3;if(u.code===429){const m=this.loader;if(typeof(m==null?void 0:m.getResponseHeader)=="function"){const p=m.getResponseHeader("Retry-After");p&&(g=parseFloat(p)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,g)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(s,l,c)}scheduleRefresh(t,e=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const r=(i=this.hls)==null?void 0:i.media;if(r&&!r.ended){this.loadSteeringManifest(t);return}this.scheduleRefresh(t,this.timeToLoad*1e3)},e)}}function Sl(n,t,e,i){n&&Object.keys(t).forEach(r=>{const s=n.filter(a=>a.groupId===r).map(a=>{const o=ft({},a);return o.details=void 0,o.attrs=new ct(o.attrs),o.url=o.attrs.URI=qu(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",e),o.groupId=o.attrs["GROUP-ID"]=t[r],o.attrs["PATHWAY-ID"]=i,o});n.push(...s)})}function qu(n,t,e,i){const{HOST:r,PARAMS:s,[e]:a}=i;let o;t&&(o=a==null?void 0:a[t],o&&(n=o));const l=new self.URL(n);return r&&!o&&(l.host=r),s&&Object.keys(s).sort().forEach(c=>{c&&l.searchParams.set(c,s[c])}),l.href}const mE=/^age:\s*[\d.]+\s*$/im;class zu{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new fr,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,t.readyState!==4&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t||!e)return;const i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return s(i,e.url)}).catch(a=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",e.url,!0),s(i,e.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,e,t)}).catch(a=>{this.callbacks.onError({code:i.status,text:a.message},e,i,r)}):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);const r=e.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:a}=i.loadPolicy;if(r)for(const o in r)t.setRequestHeader(o,r[o]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&B(s)?s:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:i}=this;if(!t||!e)return;const r=e.readyState,s=this.config;if(!i.aborted&&r>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),r===4)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const a=e.status,o=e.responseType!=="text";if(a>=200&&a<300&&(o&&e.response||e.responseText!==null)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const l=o?e.response:e.responseText,c=e.responseType==="arraybuffer"?l.byteLength:l.length;if(i.loaded=i.total=c,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const u=this.callbacks.onProgress;if(u&&u(i,t,l,e),!this.callbacks)return;const h={url:e.responseURL,data:l,code:a};this.callbacks.onSuccess(h,i,t,e)}else{const l=s.loadPolicy.errorRetry,c=i.retry,u={url:t.url,data:void 0,code:a};Qn(l,c,!1,u)?this.retry(l):(L.error(`${a} while loading ${t.url}`),this.callbacks.onError({code:a,text:e.statusText},t,e,i))}}}loadtimeout(){if(!this.config)return;const t=this.config.loadPolicy.timeoutRetry,e=this.stats.retry;if(Qn(t,e,!0))this.retry(t);else{var i;L.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const r=this.callbacks;r&&(this.abortInternal(),r.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:i}=this;this.retryDelay=oa(t,i.retry),i.retry++,L.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${e==null?void 0:e.url}, retrying ${i.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&mE.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}function pE(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const yE=/(\d+)-(\d+)\/(\d+)/;class Al{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||TE,this.controller=new self.AbortController,this.stats=new fr}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const s=vE(t,this.controller.signal),a=i.onProgress,o=t.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:u}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,s),self.clearTimeout(this.requestTimeout),e.timeout=c&&B(c)?c:u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(r,t,this.response)},e.timeout),self.fetch(this.request).then(h=>{this.response=this.loader=h;const f=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(r,t,this.response)},u-(f-r.loading.start)),!h.ok){const{status:d,statusText:g}=h;throw new SE(g||"fetch, bad network response",d,h)}return r.loading.first=f,r.total=xE(h.headers)||r.total,a&&B(e.highWaterMark)?this.loadProgressively(h,r,t,e.highWaterMark,a):o?h.arrayBuffer():t.responseType==="json"?h.json():h.text()}).then(h=>{const f=this.response;if(!f)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const d=h[l];d&&(r.loaded=r.total=d);const g={url:f.url,data:h,code:f.status};a&&!B(e.highWaterMark)&&a(r,t,h,f),i.onSuccess(g,r,t,f)}).catch(h=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const f=h&&h.code||0,d=h?h.message:null;i.onError({code:f,text:d},t,h?h.details:null,r)})}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i,r=0,s){const a=new mu,o=t.body.getReader(),l=()=>o.read().then(c=>{if(c.done)return a.dataLength&&s(e,i,a.flush(),t),Promise.resolve(new ArrayBuffer(0));const u=c.value,h=u.length;return e.loaded+=h,h<r||a.dataLength?(a.push(u),a.dataLength>=r&&s(e,i,a.flush(),t)):s(e,i,u,t),l()}).catch(()=>Promise.reject());return l()}}function vE(n,t){const e={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(ft({},n.headers))};return n.rangeEnd&&e.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),e}function EE(n){const t=yE.exec(n);if(t)return parseInt(t[2])-parseInt(t[1])+1}function xE(n){const t=n.get("Content-Range");if(t){const i=EE(t);if(B(i))return i}const e=n.get("Content-Length");if(e)return parseInt(e)}function TE(n,t){return new self.Request(n.url,t)}class SE extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}const AE=/\s/,LE={newCue(n,t,e,i){const r=[];let s,a,o,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(s=i.rows[f],o=!0,l=0,c="",!s.isEmpty()){var h;for(let m=0;m<s.chars.length;m++)AE.test(s.chars[m].uchar)&&o?l++:(c+=s.chars[m].uchar,o=!1);s.cueStartTime=t,t===e&&(e+=1e-4),l>=16?l--:l++;const d=Nu(c.trim()),g=va(t,e,d);n!=null&&(h=n.cues)!=null&&h.getCueById(g)||(a=new u(t,e,d),a.id=g,a.line=f+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),r.push(a))}return n&&r.length&&(r.sort((f,d)=>f.line==="auto"||d.line==="auto"?0:f.line>8&&d.line>8?d.line-f.line:f.line-d.line),r.forEach(f=>ou(n,f))),r}},RE={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Xu=pt(pt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:zu,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Jp,bufferController:iv,capLevelController:Ea,errorController:$p,fpsController:Dv,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:qc,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:RE},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},_E()),{},{subtitleStreamController:Jy,subtitleTrackController:tv,timelineController:bv,audioStreamController:jy,audioTrackController:Qy,emeController:ei,cmcdController:fE,contentSteeringController:gE});function _E(){return{cueHandler:LE,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function IE(n,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const e=Us(n),i=["manifest","level","frag"],r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(s=>{const a=`${s==="level"?"playlist":s}LoadPolicy`,o=t[a]===void 0,l=[];r.forEach(c=>{const u=`${s}Loading${c}`,h=t[u];if(h!==void 0&&o){l.push(u);const f=e[a].default;switch(t[a]={default:f},c){case"TimeOut":f.maxLoadTimeMs=h,f.maxTimeToFirstByteMs=h;break;case"MaxRetry":f.errorRetry.maxNumRetry=h,f.timeoutRetry.maxNumRetry=h;break;case"RetryDelay":f.errorRetry.retryDelayMs=h,f.timeoutRetry.retryDelayMs=h;break;case"MaxRetryTimeout":f.errorRetry.maxRetryDelayMs=h,f.timeoutRetry.maxRetryDelayMs=h;break}}}),l.length&&L.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${JSON.stringify(t[a])}`)}),pt(pt({},e),t)}function Us(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(Us):Object.keys(n).reduce((t,e)=>(t[e]=Us(n[e]),t),{}):n}function bE(n){const t=n.loader;t!==Al&&t!==zu?(L.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):pE()&&(n.loader=Al,n.progressive=!0,n.enableSoftwareAES=!0,L.log("[config]: Progressive streaming enabled, using FetchLoader"))}let Yr;class wE extends la{constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const i=this.hls.config.preferManagedMediaSource,r=[],s={},a={};let o=!1,l=!1,c=!1;e.levels.forEach(u=>{var h,f;const d=u.attrs;let{audioCodec:g,videoCodec:m}=u;((h=g)==null?void 0:h.indexOf("mp4a.40.34"))!==-1&&(Yr||(Yr=/chrome|firefox/i.test(navigator.userAgent)),Yr&&(u.audioCodec=g=void 0)),g&&(u.audioCodec=g=zn(g,i)),((f=m)==null?void 0:f.indexOf("avc1"))===0&&(m=u.videoCodec=mp(m));const{width:p,height:v,unknownCodecs:x}=u;if(o||(o=!!(p&&v)),l||(l=!!m),c||(c=!!g),x!=null&&x.length||g&&!Dr(g,"audio",i)||m&&!Dr(m,"video",i))return;const{CODECS:T,"FRAME-RATE":S,"HDCP-LEVEL":E,"PATHWAY-ID":R,RESOLUTION:A,"VIDEO-RANGE":C}=d,I=`${`${R||"."}-`}${u.bitrate}-${A}-${S}-${T}-${C}-${E}`;if(s[I])if(s[I].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const b=a[I]+=1;u.attrs["PATHWAY-ID"]=new Array(b+1).join(".");const $=new ci(u);s[I]=$,r.push($)}else s[I].addGroupId("audio",d.AUDIO),s[I].addGroupId("text",d.SUBTITLES);else{const b=new ci(u);s[I]=b,a[I]=1,r.push(b)}}),this.filterAndSortMediaOptions(r,e,o,l,c)}filterAndSortMediaOptions(t,e,i,r,s){let a=[],o=[],l=t;if((i||r)&&s&&(l=l.filter(({videoCodec:g,videoRange:m,width:p,height:v})=>(!!g||!!(p&&v))&&bp(m))),l.length===0){Promise.resolve().then(()=>{if(this.hls){e.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(e.levels[0].attrs)}`);const g=new Error("no level with compatible codecs found in manifest");this.hls.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:g,reason:g.message})}});return}if(e.audioTracks){const{preferManagedMediaSource:g}=this.hls.config;a=e.audioTracks.filter(m=>!m.audioCodec||Dr(m.audioCodec,"audio",g)),Ll(a)}e.subtitles&&(o=e.subtitles,Ll(o));const c=l.slice(0);l.sort((g,m)=>{if(g.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"])return(g.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&g.height!==m.height)return g.height-m.height;if(g.frameRate!==m.frameRate)return g.frameRate-m.frameRate;if(g.videoRange!==m.videoRange)return Xn.indexOf(g.videoRange)-Xn.indexOf(m.videoRange);if(g.videoCodec!==m.videoCodec){const p=Co(g.videoCodec),v=Co(m.videoCodec);if(p!==v)return v-p}if(g.uri===m.uri&&g.codecSet!==m.codecSet){const p=qn(g.codecSet),v=qn(m.codecSet);if(p!==v)return v-p}return g.averageBitrate!==m.averageBitrate?g.averageBitrate-m.averageBitrate:0});let u=c[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==c.length)){for(let g=0;g<c.length;g++)if(c[g].pathwayId===l[0].pathwayId){u=c[g];break}}this._levels=l;for(let g=0;g<l.length;g++)if(l[g]===u){var h;this._firstLevel=g;const m=u.bitrate,p=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${m}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){const v=Math.min(m,this.hls.config.abrEwmaDefaultEstimateMax);v>p&&p===Xu.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=v)}break}const f=s&&!r,d={levels:l,audioTracks:a,subtitleTracks:o,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:s,video:r,altAudio:!f&&a.some(g=>!!g.url)};this.hls.trigger(y.MANIFEST_PARSED,d),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(e.length===0)return;if(t<0||t>=e.length){const u=new Error("invalid level idx"),h=t<0;if(this.hls.trigger(y.ERROR,{type:Y.OTHER_ERROR,details:D.LEVEL_SWITCH_ERROR,level:t,fatal:h,error:u,reason:u.message}),h)return;t=Math.min(t,e.length-1)}const i=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,a=e[t],o=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=a,i===t&&a.details&&r&&s===o)return;this.log(`Switching to level ${t} (${a.height?a.height+"p ":""}${a.videoRange?a.videoRange+" ":""}${a.codecSet?a.codecSet+" ":""}@${a.bitrate})${o?" with Pathway "+o:""} from level ${i}${s?" with Pathway "+s:""}`);const l={level:t,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(y.LEVEL_SWITCHING,l);const c=a.details;if(!c||c.live){const u=this.switchParams(a.uri,r==null?void 0:r.details,c);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,this._startLevel===void 0&&(this._startLevel=t),t!==-1&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(this._startLevel===void 0){const t=this.hls.config.startLevel;return t!==void 0?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){e.fatal||!e.context||e.context.type===Q.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(e!==void 0&&e.type===H.MAIN){const i=e.elementaryStreams;if(!Object.keys(i).some(s=>!!i[s]))return;const r=this._levels[e.level];r!=null&&r.loadError&&(this.log(`Resetting level error count of ${r.loadError} on frag buffered`),r.loadError=0)}}onLevelLoaded(t,e){var i;const{level:r,details:s}=e,a=this._levels[r];if(!a){var o;this.warn(`Invalid level index ${r}`),(o=e.deliveryDirectives)!=null&&o.skip&&(s.deltaUpdateFailed=!0);return}r===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0),this.playlistLoaded(r,e,a.details)):(i=e.deliveryDirectives)!=null&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist();const e=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let r=i.uri;if(t)try{r=t.addDirectives(r)}catch(a){this.warn(`Could not construct new URL with HLS Delivery Directives: ${a}`)}const s=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${e}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""} with${s?" Pathway "+s:""} ${r}`),this.clearTimer(),this.hls.trigger(y.LEVEL_LOADING,{url:r,level:e,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;const i=this._levels.filter((r,s)=>s!==t?!0:(this.steering&&this.steering.removeLevel(r),r===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,r.details&&r.details.fragments.forEach(a=>a.level=-1)),!1));hu(i),this._levels=i,this.currentLevelIndex>-1&&(e=this.currentLevel)!=null&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(y.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){const{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(y.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function Ll(n){const t={};n.forEach(e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++})}class DE{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(const i in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[i].loader;if(r){var e;if(t&&t!==((e=r.context)==null?void 0:e.frag.type))return;r.abort()}}}detach(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=D.KEY_LOAD_ERROR,i,r,s){return new fe({type:Y.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:s,error:i,networkDetails:r})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:r}=t;for(let s=0;s<e.length;s++){const a=e[s];if(r<=a.cc&&(i==="initSegment"||a.sn==="initSegment"||i<a.sn)){this.emeController.selectKeySystemFormat(a).then(o=>{a.setKeyFormat(o)});break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var i,r;e&&t.setKeyFormat(e);const s=t.decryptdata;if(!s){const c=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,D.KEY_LOAD_ERROR,c))}const a=s.uri;if(!a)return Promise.reject(this.createKeyLoadError(t,D.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${a}"`)));let o=this.keyUriToKeyInfo[a];if((i=o)!=null&&i.decryptdata.key)return s.key=o.decryptdata.key,Promise.resolve({frag:t,keyInfo:o});if((r=o)!=null&&r.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(c=>(s.key=c.keyInfo.decryptdata.key,{frag:t,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[a]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return s.keyFormat==="identity"?this.loadKeyHTTP(o,t):this.loadKeyEME(o,t);case"AES-128":return this.loadKeyHTTP(o,t);default:return Promise.reject(this.createKeyLoadError(t,D.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(t,e){const i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){const r=this.emeController.loadKey(i);if(r)return(t.keyLoadPromise=r.then(s=>(t.mediaKeySessionContext=s,i))).catch(s=>{throw t.keyLoadPromise=null,s})}return Promise.resolve(i)}loadKeyHTTP(t,e){const i=this.config,r=i.loader,s=new r(i);return e.keyLoader=t.loader=s,t.keyLoadPromise=new Promise((a,o)=>{const l={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},c=i.keyLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,g,m)=>{const{frag:p,keyInfo:v,url:x}=g;if(!p.decryptdata||v!==this.keyUriToKeyInfo[x])return o(this.createKeyLoadError(p,D.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));v.decryptdata.key=p.decryptdata.key=new Uint8Array(f.data),p.keyLoader=null,v.loader=null,a({frag:p,keyInfo:v})},onError:(f,d,g,m)=>{this.resetLoader(d),o(this.createKeyLoadError(e,D.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),g,pt({url:l.url,data:void 0},f)))},onTimeout:(f,d,g)=>{this.resetLoader(d),o(this.createKeyLoadError(e,D.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),g))},onAbort:(f,d,g)=>{this.resetLoader(d),o(this.createKeyLoadError(e,D.INTERNAL_ABORTED,new Error("key loading aborted"),g))}};s.load(l,u,h)})}resetLoader(t){const{frag:e,keyInfo:i,url:r}=t,s=i.loader;e.keyLoader===s&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}}function ju(){return self.SourceBuffer||self.WebKitSourceBuffer}function Qu(){if(!Ne())return!1;const t=ju();return!t||t.prototype&&typeof t.prototype.appendBuffer=="function"&&typeof t.prototype.remove=="function"}function CE(){if(!Qu())return!1;const n=Ne();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>n.isTypeSupported(Ki(t,"video")))||["mp4a.40.2","fLaC"].some(t=>n.isTypeSupported(Ki(t,"audio"))))}function kE(){var n;const t=ju();return typeof(t==null||(n=t.prototype)==null?void 0:n.changeType)=="function"}const PE=250,_n=2,FE=.1,OE=.05;class ME{constructor(t,e,i,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=i,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){const{config:i,media:r,stalled:s}=this;if(r===null)return;const{currentTime:a,seeking:o}=r,l=this.seeking&&!o,c=!this.seeking&&o;if(this.seeking=o,a!==t){if(this.moved=!0,o||(this.nudgeRetry=0),s!==null){if(this.stallReported){const p=self.performance.now()-s;L.warn(`playback not stuck anymore @${a}, after ${Math.round(p)}ms`),this.stallReported=!1}this.stalled=null}return}if(c||l){this.stalled=null;return}if(r.paused&&!o||r.ended||r.playbackRate===0||!nt.getBuffered(r).length){this.nudgeRetry=0;return}const u=nt.bufferInfo(r,a,0),h=u.nextStart||0;if(o){const p=u.len>_n,v=!h||e&&e.start<=a||h-a>_n&&!this.fragmentTracker.getPartialFragment(a);if(p||v)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var f;if(!(u.len>0)&&!h)return;const v=Math.max(h,u.start||0)-a,x=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,S=(x==null||(f=x.details)==null?void 0:f.live)?x.details.targetduration*2:_n,E=this.fragmentTracker.getPartialFragment(a);if(v>0&&(v<=S||E)){r.paused||this._trySkipBufferHole(E);return}}const d=self.performance.now();if(s===null){this.stalled=d;return}const g=d-s;if(!o&&g>=PE&&(this._reportStall(u),!this.media))return;const m=nt.bufferInfo(r,a,i.maxBufferHole);this._tryFixBufferStall(m,g)}_tryFixBufferStall(t,e){const{config:i,fragmentTracker:r,media:s}=this;if(s===null)return;const a=s.currentTime,o=r.getPartialFragment(a);o&&(this._trySkipBufferHole(o)||!this.media)||(t.len>i.maxBufferHole||t.nextStart&&t.nextStart-a<i.maxBufferHole)&&e>i.highBufferWatchdogPeriod*1e3&&(L.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){const{hls:e,media:i,stallReported:r}=this;if(!r&&i){this.stallReported=!0;const s=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(t)})`);L.warn(s.message),e.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_STALLED_ERROR,fatal:!1,error:s,buffer:t.len})}}_trySkipBufferHole(t){const{config:e,hls:i,media:r}=this;if(r===null)return 0;const s=r.currentTime,a=nt.bufferInfo(r,s,0),o=s<a.start?a.start:a.nextStart;if(o){const l=a.len<=e.maxBufferHole,c=a.len>0&&a.len<1&&r.readyState<3,u=o-s;if(u>0&&(l||c)){if(u>e.maxBufferHole){const{fragmentTracker:f}=this;let d=!1;if(s===0){const g=f.getAppendedFrag(0,H.MAIN);g&&o<g.end&&(d=!0)}if(!d){const g=t||f.getAppendedFrag(s,H.MAIN);if(g){let m=!1,p=g.end;for(;p<o;){const v=f.getPartialFragment(p);if(v)p+=v.duration;else{m=!0;break}}if(m)return 0}}}const h=Math.max(o+OE,s+FE);if(L.warn(`skipping hole, adjusting currentTime from ${s} to ${h}`),this.moved=!0,this.stalled=null,r.currentTime=h,t&&!t.gap){const f=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${h}`);i.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:f,reason:f.message,frag:t})}return h}}return 0}_tryNudgeBuffer(){const{config:t,hls:e,media:i,nudgeRetry:r}=this;if(i===null)return;const s=i.currentTime;if(this.nudgeRetry++,r<t.nudgeMaxRetry){const a=s+(r+1)*t.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${s} to ${a}`);L.warn(o.message),i.currentTime=a,e.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const a=new Error(`Playhead still not moving while enough data buffered @${s} after ${t.nudgeMaxRetry} nudges`);L.error(a.message),e.trigger(y.ERROR,{type:Y.MEDIA_ERROR,details:D.BUFFER_STALLED_ERROR,error:a,fatal:!0})}}}const NE=100;class UE extends ha{constructor(t,e,i){super(t,e,i,"[stream-controller]",H.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(y.ERROR,this.onError,this),t.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this),t.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(y.ERROR,this.onError,this),t.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this),t.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(t){if(this.levels){const{lastCurrentTime:e,hls:i}=this;if(this.stopLoad(),this.setInterval(NE),this.level=-1,!this.startFragRequested){let r=i.startLevel;r===-1&&(i.config.testBandwidth&&this.levels.length>1?(r=0,this.bitrateTest=!0):r=i.firstAutoLevel),i.nextLoadLevel=r,this.level=i.loadLevel,this.loadedmetadata=!1}e>0&&t===-1&&(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e),this.state=P.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=P.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case P.WAITING_LEVEL:{const{levels:e,level:i}=this,r=e==null?void 0:e[i],s=r==null?void 0:r.details;if(s&&(!s.live||this.levelLastLoaded===r)){if(this.waitForCdnTuneIn(s))break;this.state=P.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=P.IDLE;break}break}case P.FRAG_LOADING_WAITING_RETRY:{var t;const e=self.performance.now(),i=this.retryDate;if(!i||e>=i||(t=this.media)!=null&&t.seeking){const{levels:r,level:s}=this,a=r==null?void 0:r[s];this.resetStartWhenNotLoaded(a||null),this.state=P.IDLE}}break}this.state===P.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:i,media:r}=this;if(e===null||!r&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const s=t.nextLoadLevel;if(!(i!=null&&i[s]))return;const a=i[s],o=this.getMainFwdBufferInfo();if(o===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(o,l)){const m={};this.altAudio&&(m.type="video"),this.hls.trigger(y.BUFFER_EOS,m),this.state=P.ENDED;return}t.loadLevel!==s&&t.manualLevel===-1&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=t.nextLoadLevel=s;const c=a.details;if(!c||this.state===P.WAITING_LEVEL||c.live&&this.levelLastLoaded!==a){this.level=s,this.state=P.WAITING_LEVEL;return}const u=o.len,h=this.getMaxBufferLength(a.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:o.end;let d=this.getNextFragment(f,c);if(this.couldBacktrack&&!this.fragPrevious&&d&&d.sn!=="initSegment"&&this.fragmentTracker.getState(d)!==mt.OK){var g;const p=((g=this.backtrackFragment)!=null?g:d).sn-c.startSN,v=c.fragments[p-1];v&&d.cc===v.cc&&(d=v,this.fragmentTracker.removeFragment(v))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,f)){if(!d.gap){const p=this.audioOnly&&!this.altAudio?tt.AUDIO:tt.VIDEO,v=(p===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;v&&this.afterBufferFlushed(v,p,H.MAIN)}d=this.getNextFragmentLoopLoading(d,c,o,H.MAIN,h)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,a,f))}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);this.fragCurrent=t,r===mt.NOT_LOADED||r===mt.PARTIAL?t.sn==="initSegment"?this._loadInitSegment(t,e):this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,H.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(e!=null&&e.readyState){let i;const r=this.getAppendedFrag(e.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const s=this.getLevelDetails();if(s!=null&&s.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<s.targetduration*2)return}if(!e.paused&&t){const o=this.hls.nextLoadLevel,l=t[o],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const a=this.getBufferedFrag(e.currentTime+i);if(a){const o=this.followingBufferedFrag(a);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,c=o.duration,u=Math.max(a.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case P.KEY_LOADING:case P.FRAG_LOADING:case P.FRAG_LOADING_WAITING_RETRY:case P.PARSING:case P.PARSED:this.state=P.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const i=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new ME(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const t=this.media,e=t?t.currentTime:null;B(e)&&this.log(`Media seeked to ${e.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(y.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(t,e){let i=!1,r=!1;e.levels.forEach(s=>{const a=s.audioCodec;a&&(i=i||a.indexOf("mp4a.40.2")!==-1,r=r||a.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&r&&!kE(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:i}=this;if(!i||this.state!==P.IDLE)return;const r=i[e.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=P.WAITING_LEVEL)}onLevelLoaded(t,e){var i;const{levels:r}=this,s=e.level,a=e.details,o=a.totalduration;if(!r){this.warn(`Levels were reset while loading level ${s}`);return}this.log(`Level ${s} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=r[s],c=this.fragCurrent;c&&(this.state===P.FRAG_LOADING||this.state===P.FRAG_LOADING_WAITING_RETRY)&&c.level!==e.level&&c.loader&&this.abortCurrentFrag();let u=0;if(a.live||(i=l.details)!=null&&i.live){var h;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;u=this.alignPlaylists(a,l.details,(h=this.levelLastLoaded)==null?void 0:h.details)}if(l.details=a,this.levelLastLoaded=l,this.hls.trigger(y.LEVEL_UPDATED,{details:a,level:s}),this.state===P.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=P.IDLE}this.startFragRequested?a.live&&this.synchronizeToLiveEdge(a):this.setStartPosition(a,u),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{levels:a}=this;if(!a){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const o=a[i.level],l=o.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=o.videoCodec,u=l.PTSKnown||!l.live,h=(e=i.initSegment)==null?void 0:e.data,f=this._getAudioCodec(o),d=this.transmuxer=this.transmuxer||new Cu(this.hls,H.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),g=r?r.index:-1,m=g!==-1,p=new ca(i.level,i.sn,i.stats.chunkCount,s.byteLength,g,m),v=this.initPTS[i.cc];d.push(s,h,f,c,i,r,l.totalduration,u,p,v)}onAudioTrackSwitching(t,e){const i=this.altAudio;if(!!!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const a=this.fragCurrent;a&&(this.log("Switching to main audio track, cancel main fragment load"),a.abortRequests(),this.fragmentTracker.removeFragment(a)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const s=this.hls;i&&(s.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),s.trigger(y.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const i=e.id,r=!!this.hls.audioTracks[i].url;if(r){const s=this.videoBuffer;s&&this.mediaBuffer!==s&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=s)}this.altAudio=r,this.tick()}onBufferCreated(t,e){const i=e.tracks;let r,s,a=!1;for(const o in i){const l=i[o];if(l.id==="main"){if(s=o,r=l,o==="video"){const c=i[o];c&&(this.videoBuffer=c.buffer)}}else a=!0}a&&r?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:i,part:r}=e;if(i&&i.type!==H.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===P.PARSED&&(this.state=P.IDLE);return}const s=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal){this.state=P.ERROR;return}switch(e.details){case D.FRAG_GAP:case D.FRAG_PARSING_ERROR:case D.FRAG_DECRYPT_ERROR:case D.FRAG_LOAD_ERROR:case D.FRAG_LOAD_TIMEOUT:case D.KEY_LOAD_ERROR:case D.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(H.MAIN,e);break;case D.LEVEL_LOAD_ERROR:case D.LEVEL_LOAD_TIMEOUT:case D.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===P.WAITING_LEVEL&&((i=e.context)==null?void 0:i.type)===Q.LEVEL&&(this.state=P.IDLE);break;case D.BUFFER_APPEND_ERROR:case D.BUFFER_FULL_ERROR:if(!e.parent||e.parent!=="main")return;if(e.details===D.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case D.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}checkBuffer(){const{media:t,gapController:e}=this;if(!(!t||!e||!t.readyState)){if(this.loadedmetadata||!nt.getBuffered(t).length){const i=this.state!==P.IDLE?this.fragCurrent:null;e.poll(this.lastCurrentTime,i)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=P.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==tt.AUDIO||this.audioOnly&&!this.altAudio){const i=(e===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,e,H.MAIN),this.tick()}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let i=this.startPosition;if(i>=0&&e<i){if(t.seeking){this.log(`could not seek to ${i}, already seeking at ${e}`);return}const r=nt.getBuffered(t),a=(r.length?r.start(0):0)-i;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${a} to match buffer start`),i+=a,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${e}`),t.currentTime=i}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e.indexOf("mp4a.40.5")!==-1?e="mp4a.40.2":e="mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(i=>{const{hls:r}=this;if(!i||this.fragContextChanged(t))return;e.fragmentError=0,this.state=P.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const s=t.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(y.FRAG_LOADED,i),t.bitrateTest=!1})}_handleTransmuxComplete(t){var e;const i="main",{hls:r}=this,{remuxResult:s,chunkMeta:a}=t,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{video:h,text:f,id3:d,initSegment:g}=s,{details:m}=u,p=this.altAudio?void 0:s.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=P.PARSING,g){if(g!=null&&g.tracks){const T=l.initSegment||l;this._bufferInitSegment(u,g.tracks,T,a),r.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:i,tracks:g.tracks})}const v=g.initPTS,x=g.timescale;B(v)&&(this.initPTS[l.cc]={baseTime:v,timescale:x},r.trigger(y.INIT_PTS_FOUND,{frag:l,id:i,initPTS:v,timescale:x}))}if(h&&m&&l.sn!=="initSegment"){const v=m.fragments[l.sn-1-m.startSN],x=l.sn===m.startSN,T=!v||l.cc>v.cc;if(s.independent!==!1){const{startPTS:S,endPTS:E,startDTS:R,endDTS:A}=h;if(c)c.elementaryStreams[h.type]={startPTS:S,endPTS:E,startDTS:R,endDTS:A};else if(h.firstKeyFrame&&h.independent&&a.id===1&&!T&&(this.couldBacktrack=!0),h.dropped&&h.independent){const C=this.getMainFwdBufferInfo(),k=(C?C.end:this.getLoadPosition())+this.config.maxBufferHole,I=h.firstKeyFramePTS?h.firstKeyFramePTS:S;if(!x&&k<I-this.config.maxBufferHole&&!T){this.backtrack(l);return}else T&&(l.gap=!0);l.setElementaryStreamInfo(h.type,l.start,E,l.start,A,!0)}else x&&S>_n&&(l.gap=!0);l.setElementaryStreamInfo(h.type,S,E,R,A),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(h,l,c,a,x||T)}else if(x||T)l.gap=!0;else{this.backtrack(l);return}}if(p){const{startPTS:v,endPTS:x,startDTS:T,endDTS:S}=p;c&&(c.elementaryStreams[tt.AUDIO]={startPTS:v,endPTS:x,startDTS:T,endDTS:S}),l.setElementaryStreamInfo(tt.AUDIO,v,x,T,S),this.bufferFragmentData(p,l,c,a)}if(m&&d!=null&&(e=d.samples)!=null&&e.length){const v={id:i,frag:l,details:m,samples:d.samples};r.trigger(y.FRAG_PARSING_METADATA,v)}if(m&&f){const v={id:i,frag:l,details:m,samples:f.samples};r.trigger(y.FRAG_PARSING_USERDATA,v)}}_bufferInitSegment(t,e,i,r){if(this.state!==P.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;const{audio:s,video:a,audiovideo:o}=e;if(s){let l=t.audioCodec;const c=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5");const u=s.metadata;u&&"channelCount"in u&&(u.channelCount||1)!==1&&c.indexOf("firefox")===-1&&(l="mp4a.40.5")}l&&l.indexOf("mp4a.40.5")!==-1&&c.indexOf("android")!==-1&&s.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),t.audioCodec&&t.audioCodec!==l&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${l}"`),s.levelCodec=l,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${l||""}/${t.audioCodec||""}/${s.codec}]`)}a&&(a.levelCodec=t.videoCodec,a.id="main",this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${t.videoCodec||""}/${a.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${t.codecs}/${o.codec}]`),this.hls.trigger(y.BUFFER_CODECS,e),Object.keys(e).forEach(l=>{const u=e[l].initSegment;u!=null&&u.byteLength&&this.hls.trigger(y.BUFFER_APPENDING,{type:l,data:u,frag:i,part:null,chunkMeta:r,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,H.MAIN)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=P.IDLE}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&t.seeking===!1){const i=t.currentTime;if(nt.isBuffered(t,i)?e=this.getAppendedFrag(i):nt.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;const r=this.fragPlaying,s=e.level;(!r||e.sn!==r.sn||r.level!==s)&&(this.fragPlaying=e,this.hls.trigger(y.FRAG_CHANGED,{frag:e}),(!r||r.level!==s)&&this.hls.trigger(y.LEVEL_SWITCHED,{level:s}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){const t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){const t=this.media;if(t){const e=t.currentTime,i=this.currentFrag;if(i&&B(e)&&B(i.programDateTime)){const r=i.programDateTime+(e-i.start)*1e3;return new Date(r)}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class Jt{static get version(){return"1.5.17"}static isMSESupported(){return Qu()}static isSupported(){return CE()}static getMediaSource(){return Ne()}static get Events(){return y}static get ErrorTypes(){return Y}static get ErrorDetails(){return D}static get DefaultConfig(){return Jt.defaultConfig?Jt.defaultConfig:Xu}static set DefaultConfig(t){Jt.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new pa,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,_m(t.debug||!1,"Hls instance");const e=this.config=IE(Jt.DefaultConfig,t);this.userConfig=t,e.progressive&&bE(e);const{abrController:i,bufferController:r,capLevelController:s,errorController:a,fpsController:o}=e,l=new a(this),c=this.abrController=new i(this),u=this.bufferController=new r(this),h=this.capLevelController=new s(this),f=new o(this),d=new xp(this),g=new Rp(this),m=e.contentSteeringController,p=m?new m(this):null,v=this.levelController=new wE(this,p),x=new ty(this),T=new DE(this.config),S=this.streamController=new UE(this,x,T);h.setStreamController(S),f.setStreamController(S);const E=[d,v,S];p&&E.splice(1,0,p),this.networkControllers=E;const R=[c,u,h,f,g,x];this.audioTrackController=this.createController(e.audioTrackController,E);const A=e.audioStreamController;A&&E.push(new A(this,x,T)),this.subtitleTrackController=this.createController(e.subtitleTrackController,E);const C=e.subtitleStreamController;C&&E.push(new C(this,x,T)),this.createController(e.timelineController,R),T.emeController=this.emeController=this.createController(e.emeController,R),this.cmcdController=this.createController(e.cmcdController,R),this.latencyController=this.createController(_p,R),this.coreComponents=R,E.push(l);const k=l.onErrorOut;typeof k=="function"&&this.on(y.ERROR,k,l)}createController(t,e){if(t){const i=new t(this);return e&&e.push(i),i}return null}on(t,e,i=this){this._emitter.on(t,e,i)}once(t,e,i=this){this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,i=this,r){this._emitter.off(t,e,i,r)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(i){if(L.error("An internal error happened while handling event "+t+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const r=t===y.ERROR;this.trigger(y.ERROR,{type:Y.OTHER_ERROR,details:D.INTERNAL_EXCEPTION,fatal:r,event:t,error:i}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){L.log("destroy"),this.trigger(y.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){L.log("attachMedia"),this._media=t,this.trigger(y.MEDIA_ATTACHING,{media:t})}detachMedia(){L.log("detachMedia"),this.trigger(y.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();const e=this.media,i=this.url,r=this.url=na.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,L.log(`loadSource:${r}`),e&&i&&(i!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(y.MANIFEST_LOADING,{url:t})}startLoad(t=-1){L.log(`startLoad(${t})`),this.started=!0,this.networkControllers.forEach(e=>{e.startLoad(t)})}stopLoad(){L.log("stopLoad"),this.started=!1,this.networkControllers.forEach(t=>{t.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.stopLoad()})}swapAudioCodec(){L.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){L.log("recoverMediaError");const t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t){this.levelController.removeLevel(t)}get levels(){const t=this.levelController.levels;return t||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){L.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){L.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){L.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){L.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){const t=this.levelController.startLevel;return t===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){L.log(`set startLevel:${t}`),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(L.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){Ip(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const i=t.length;for(let r=0;r<i;r++)if(t[r].maxBitrate>=e)return r;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:i}=this;let r;if(e===-1&&t!=null&&t.length?r=t.length-1:r=e,i)for(let s=r;s--;){const a=t[s].attrs["HDCP-LEVEL"];if(a&&a<=i)return s}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(t){var e;return(e=this.audioTrackController)==null?void 0:e.setAudioOption(t)}setSubtitleOption(t){var e;return(e=this.subtitleTrackController)==null||e.setSubtitleOption(t),null}get allAudioTracks(){const t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){const t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return t?t.subtitleDisplay:!1}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Jt.defaultConfig=void 0;var BE=qh('<path fill="#1B1A1B" stroke="gray" stroke-width="0.2" role="button" tabindex="0" class="svelte-19vdeh4"></path><image role="button" tabindex="0" class="svelte-19vdeh4"></image>'),$E=Wh('<main class="svelte-19vdeh4"><audio controls autoplay class="svelte-19vdeh4"></audio> <svg><g></g></svg></main>');function GE(n,t){jl(t,!1);const e=oe(),i=oe();let r=oe();const s={uk:"https://as-hls-ww-live.akamaized.net/pool_904/live/ww/bbc_6music/bbc_6music.isml/bbc_6music-audio%3d96000.norewind.m3u8",austria:"https://orf-live.ors-shoutcast.at/fm4-q2a",portugal:"https://radiocast.rtp.pt/antena380a.mp3",slovakia:"https://icecast.stv.livebox.sk/fm_128.mp3",france:"https://icecast.radiofrance.fr/fip-midfi.mp3?id=radiofrance",spain:"https://rtvelivestream.akamaized.net/rtvesec/rne/rne_r3_main.m3u8",ireland:"https://icecast1.rte.ie/2xm",iceland:"http://netradio.ruv.is/ras2.aac",netherlands:"https://icecast.omroep.nl/3fm-bb-aac",czech:"https://rozhlas.stream/radio_wave_low.aac",switzerland:"https://stream.srg-ssr.ch/m/drsvirus/aacp_96",italy:"https://radiodueindie-live.akamaized.net/hls/live/2032593/radiodueindie/radiodueindie/radio2indie_256/chunklist.m3u8",germany:"https://st03.sslstream.dlf.de/dlf/03/high/aac/stream.aac",denmark:"https://drliveradio.akamaized.net/hls/live/2022411/p6beat/masterab.m3u8",poland:"http://mp3.polskieradio.pl:8904/;",hungary:"https://icast.connectmedia.hu/4738/mr2.mp3",slovenia:"https://mp3.rtvslo.si/val202",norway:"https://lyd.nrk.no/nrk_radio_p13_aac_h",sweden:"https://http-live.sr.se/p3-aac-192",finland:"https://icecast.live.yle.fi/radio/YleX/icecast.audio",estonia:"https://sb.err.ee/live/raadio2.m3u8",latvia:"https://live.pieci.lv/live19-hq.aac",lithuania:"http://lrt-cast.lrt.lt:8000/lrt_opus",croatia:"https://playerservices.streamtheworld.com/api/livestream-redirect/PROGRAM2AAC.aac",bosnia:"https://pstnet7.shoutcastnet.com:10034/stream"};let a=oe(),o=oe(),l=oe(Lr),c=oe(25),u=oe();Cg("europe.json").then(E=>Mt(u,E));let h=oe([]);function f(E){const R=Ec(G(l),E);_c().duration(750).tween("zoom",()=>A=>{Mt(l,R(A))})}let d;function g(E){d=E.properties.NAME,d=="United Kingdom"&&(d="uk"),d=="Czech Republic"&&(d="czech"),d=="Bosnia and Herzegovina"&&(d="bosnia");const R=s[d.toLowerCase()];R?m(R):console.error(`No stream available for ${d}`);const[[A,C],[k,I]]=E.bounds,b=Lr.translate(G(a)/2,G(o)/2).scale(Math.min(8,.9/Math.max((k-A)/G(a),(I-C)/G(o)))).translate(-(A+k)/2,-(C+I)/2);f(b)}function m(E){if(E.endsWith(".m3u8"))if(Jt.isSupported()){const R=new Jt;R.loadSource(E),R.attachMedia(G(r)),R.on(Jt.Events.MANIFEST_PARSED,()=>{console.log("HLS Manifest loaded, ready to play."),G(r).play()}),R.on(Jt.Events.ERROR,(A,C)=>{console.error("HLS Error:",C)})}else G(r).canPlayType("application/vnd.apple.mpegurl")?(Ra(r,G(r).src=E),G(r).play()):console.error("Your browser does not support HLS playback.");else Ra(r,G(r).src=E),G(r).play()}function p(E){E.key==="Escape"&&f(Lr)}hf(()=>(window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)));function v(E){E.target.style.fill="red"}function x(E){E.target.style.fill="#1B1A1B"}Xi(()=>G(a),()=>{Mt(c,G(a)<600?15:25)}),Xi(()=>(G(a),G(o),G(u)),()=>{Mt(e,ym().fitSize([G(a),G(o)],G(u)))}),Xi(()=>G(e),()=>{Mt(i,rm(G(e)))}),Xi(()=>(G(u),G(i)),()=>{G(u)&&Mt(h,G(u).features.map(E=>({...E,path:G(i)(E),bounds:G(i).bounds(E),centroid:G(i).centroid(E)})))}),wh(),uf();var T=zh(),S=ba(T);Zh(S,()=>G(h),E=>{var R=$E(),A=Ia(R);cf(A,I=>Mt(r,I),()=>G(r));var C=wa(A,2),k=Ia(C);nf(k,5,()=>G(h),tf,(I,b)=>{var $=BE(),F=ba($),M=wa(F);Da(()=>{Vt(F,"d",G(b).path),Vt(F,"aria-label",`Select ${G(b).properties.NAME}`),Vt(M,"href",G(b).properties.radio),Vt(M,"x",G(b).centroid[0]-G(c)/2),Vt(M,"y",G(b).centroid[1]-G(c)/2),Vt(M,"height",G(c)),Vt(M,"aria-label",`Play radio for ${G(b).properties.NAME}`)}),$e("click",F,()=>g(G(b))),$e("mouseenter",F,v),$e("mouseleave",F,x),$e("keydown",F,w=>{(w.key==="Enter"||w.key===" ")&&(g(G(b)),w.preventDefault())}),$e("click",M,()=>g(G(b))),$e("keydown",M,w=>{(w.key==="Enter"||w.key===" ")&&(g(G(b)),w.preventDefault())}),yr(I,$)}),Da(()=>{Vt(C,"width",G(a)),Vt(C,"height",G(o)),Vt(k,"transform",G(l))}),Na(R,"clientWidth",I=>Mt(a,I)),Na(R,"clientHeight",I=>Mt(o,I)),yr(E,R)}),yr(n,T),Ql()}Qh(GE,{target:document.getElementById("app")});
